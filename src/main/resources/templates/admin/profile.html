<!doctype html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/layout :: head(title='Hồ sơ Admin')}"></head>
  <body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 font-sans h-screen flex overflow-hidden"
  >
    <!-- Mobile Sidebar Backdrop -->
    <div th:replace="~{fragments/layout :: sidebar-backdrop}"></div>

    <!-- Admin Sidebar -->
    <aside th:replace="~{fragments/layout :: admin-sidebar}"></aside>

    <!-- Main Content -->
    <main
      class="flex-1 flex flex-col min-w-0 bg-gradient-to-br from-slate-50 via-white to-indigo-50/30 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800"
    >
      <!-- Header -->
      <header
        th:replace="~{fragments/layout :: header(title='Hồ sơ cá nhân')}"
      ></header>

      <!-- Page Content -->
      <div class="flex-1 overflow-y-auto p-4 lg:p-6">
        <div class="max-w-7xl mx-auto flex flex-col gap-6">
          <!-- Page Title -->
          <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
              Hồ sơ Quản trị viên
            </h1>
            <p class="text-slate-500 dark:text-slate-400 mt-1">
              Quản lý thông tin cá nhân và bảo mật tài khoản
            </p>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Profile Card -->
            <div class="lg:col-span-1 space-y-6">
              <!-- Avatar & Basic Info -->
              <div
                class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-700 p-6"
              >
                <div class="text-center">
                  <!-- Avatar -->
                  <div class="relative inline-block group">
                    <img
                      id="avatarImg"
                      src=""
                      alt="Avatar"
                      class="w-28 h-28 rounded-full object-cover border-4 border-primary/20 shadow-lg hidden"
                    />
                    <div
                      id="avatarPlaceholder"
                      class="w-28 h-28 bg-gradient-to-br from-primary to-primary-dark rounded-full flex items-center justify-center shadow-lg"
                    >
                      <span
                        class="text-white font-bold text-3xl"
                        id="avatarInitials"
                        >AD</span
                      >
                    </div>
                    <button
                      id="avatarUploadBtn"
                      class="absolute bottom-0 right-0 w-9 h-9 bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-full flex items-center justify-center shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-all duration-200"
                    >
                      <span class="material-symbols-outlined text-[18px]"
                        >photo_camera</span
                      >
                    </button>
                    <input
                      type="file"
                      id="avatarInput"
                      accept="image/jpeg,image/jpg,image/png"
                      class="hidden"
                    />
                  </div>

                  <!-- Name & Role -->
                  <h2
                    id="profileName"
                    class="text-xl font-bold text-slate-900 dark:text-white mt-4"
                  >
                    Đang tải...
                  </h2>
                  <p
                    class="text-slate-500 dark:text-slate-400 flex items-center justify-center gap-1 mt-1"
                  >
                    <span class="material-symbols-outlined text-[18px]"
                      >admin_panel_settings</span
                    >
                    Quản trị viên
                  </p>

                  <!-- Status Badge -->
                  <div id="verificationBadge" class="mt-3">
                    <!-- Dynamic content -->
                  </div>

                  <!-- Admin Badge -->
                  <div class="mt-4">
                    <span
                      class="inline-flex items-center gap-1.5 px-4 py-1.5 bg-primary/10 text-primary text-sm font-bold rounded-full"
                    >
                      <span class="material-symbols-outlined text-[16px]"
                        >shield</span
                      >
                      Super Admin
                    </span>
                  </div>
                </div>

                <!-- Profile Completion -->
                <div
                  class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700"
                >
                  <div class="flex items-center justify-between mb-2">
                    <span
                      class="text-sm font-medium text-slate-700 dark:text-slate-300"
                      >Hoàn thiện hồ sơ</span
                    >
                    <span
                      id="completionPercent"
                      class="text-sm font-bold text-primary"
                      >0%</span
                    >
                  </div>
                  <div
                    class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2 overflow-hidden"
                  >
                    <div
                      id="completionBar"
                      class="bg-primary h-full rounded-full transition-all duration-500"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>

              <!-- System Stats -->
              <div
                class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-700 p-6"
              >
                <h3
                  class="text-lg font-bold text-slate-900 dark:text-white mb-4"
                >
                  Thống kê hệ thống
                </h3>
                <div class="space-y-4">
                  <div
                    class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl"
                  >
                    <div class="flex items-center gap-3">
                      <div
                        class="w-10 h-10 bg-blue-100 dark:bg-blue-900/40 rounded-lg flex items-center justify-center"
                      >
                        <span
                          class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-[20px]"
                          >group</span
                        >
                      </div>
                      <span class="text-slate-700 dark:text-slate-300"
                        >Người dùng</span
                      >
                    </div>
                    <span
                      id="statUsers"
                      class="text-xl font-bold text-slate-900 dark:text-white"
                      >0</span
                    >
                  </div>
                  <div
                    class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-xl"
                  >
                    <div class="flex items-center gap-3">
                      <div
                        class="w-10 h-10 bg-green-100 dark:bg-green-900/40 rounded-lg flex items-center justify-center"
                      >
                        <span
                          class="material-symbols-outlined text-green-600 dark:text-green-400 text-[20px]"
                          >stethoscope</span
                        >
                      </div>
                      <span class="text-slate-700 dark:text-slate-300"
                        >Bác sĩ</span
                      >
                    </div>
                    <span
                      id="statDoctors"
                      class="text-xl font-bold text-slate-900 dark:text-white"
                      >0</span
                    >
                  </div>
                  <div
                    class="flex items-center justify-between p-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl"
                  >
                    <div class="flex items-center gap-3">
                      <div
                        class="w-10 h-10 bg-purple-100 dark:bg-purple-900/40 rounded-lg flex items-center justify-center"
                      >
                        <span
                          class="material-symbols-outlined text-purple-600 dark:text-purple-400 text-[20px]"
                          >personal_injury</span
                        >
                      </div>
                      <span class="text-slate-700 dark:text-slate-300"
                        >Bệnh nhân</span
                      >
                    </div>
                    <span
                      id="statPatients"
                      class="text-xl font-bold text-slate-900 dark:text-white"
                      >0</span
                    >
                  </div>
                  <div
                    class="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/20 rounded-xl"
                  >
                    <div class="flex items-center gap-3">
                      <div
                        class="w-10 h-10 bg-orange-100 dark:bg-orange-900/40 rounded-lg flex items-center justify-center"
                      >
                        <span
                          class="material-symbols-outlined text-orange-600 dark:text-orange-400 text-[20px]"
                          >support_agent</span
                        >
                      </div>
                      <span class="text-slate-700 dark:text-slate-300"
                        >Lễ tân</span
                      >
                    </div>
                    <span
                      id="statReceptionists"
                      class="text-xl font-bold text-slate-900 dark:text-white"
                      >0</span
                    >
                  </div>
                </div>
              </div>
            </div>

            <!-- Profile Form -->
            <div class="lg:col-span-2 space-y-6">
              <!-- Tab Navigation -->
              <div
                class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-700"
              >
                <div
                  class="flex border-b border-slate-200 dark:border-slate-700"
                >
                  <button
                    id="tab-personal"
                    onclick="switchTab('personal')"
                    class="tab-btn flex-1 py-4 text-sm font-medium border-b-2 border-primary text-primary flex items-center justify-center gap-2 transition-colors"
                  >
                    <span class="material-symbols-outlined text-[20px]"
                      >person</span
                    >
                    Thông tin cá nhân
                  </button>
                  <button
                    id="tab-security"
                    onclick="switchTab('security')"
                    class="tab-btn flex-1 py-4 text-sm font-medium border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-primary flex items-center justify-center gap-2 transition-colors"
                  >
                    <span class="material-symbols-outlined text-[20px]"
                      >security</span
                    >
                    Bảo mật
                  </button>
                  <button
                    id="tab-permissions"
                    onclick="switchTab('permissions')"
                    class="tab-btn flex-1 py-4 text-sm font-medium border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-primary flex items-center justify-center gap-2 transition-colors"
                  >
                    <span class="material-symbols-outlined text-[20px]"
                      >policy</span
                    >
                    Quyền hạn
                  </button>
                </div>

                <!-- Personal Information Panel -->
                <div id="panel-personal" class="p-6">
                  <form id="profileForm" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                        >
                          Họ và tên <span class="text-red-500">*</span>
                        </label>
                        <input
                          type="text"
                          id="fullName"
                          required
                          class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                        />
                      </div>
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                        >
                          Email <span class="text-red-500">*</span>
                        </label>
                        <input
                          type="email"
                          id="email"
                          readonly
                          class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-500 dark:text-slate-400 cursor-not-allowed"
                        />
                      </div>
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                          >Số điện thoại</label
                        >
                        <input
                          type="tel"
                          id="phoneNumber"
                          class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                        />
                      </div>
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                          >Ngày sinh</label
                        >
                        <input
                          type="date"
                          id="dateOfBirth"
                          class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                        />
                      </div>
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                          >Giới tính</label
                        >
                        <select
                          id="gender"
                          class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                        >
                          <option value="">-- Chọn giới tính --</option>
                          <option value="MALE">Nam</option>
                          <option value="FEMALE">Nữ</option>
                          <option value="OTHER">Khác</option>
                        </select>
                      </div>
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                          >CCCD/CMND</label
                        >
                        <input
                          type="text"
                          id="identityNumber"
                          class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                        />
                      </div>
                      <div class="md:col-span-2">
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                          >Địa chỉ</label
                        >
                        <textarea
                          id="address"
                          rows="2"
                          class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"
                        ></textarea>
                      </div>
                    </div>
                    <div
                      class="flex justify-end gap-3 pt-4 border-t border-slate-200 dark:border-slate-700"
                    >
                      <button
                        type="button"
                        onclick="resetForm()"
                        class="px-5 py-2.5 text-slate-600 dark:text-slate-400 font-medium rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                      >
                        Hủy thay đổi
                      </button>
                      <button
                        type="submit"
                        class="px-5 py-2.5 bg-primary text-white font-medium rounded-xl hover:bg-primary-dark transition-colors shadow-lg shadow-primary/25"
                      >
                        Lưu thay đổi
                      </button>
                    </div>
                  </form>
                </div>

                <!-- Security Panel -->
                <div id="panel-security" class="p-6 hidden">
                  <!-- Email Verification -->
                  <div class="mb-6">
                    <div
                      class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-xl"
                    >
                      <div class="flex items-center gap-4">
                        <div
                          id="emailIconWrapper"
                          class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center"
                        >
                          <span
                            class="material-symbols-outlined text-blue-600 dark:text-blue-400"
                            >mail</span
                          >
                        </div>
                        <div>
                          <p class="font-medium text-slate-900 dark:text-white">
                            Email xác thực
                          </p>
                          <p
                            id="emailStatusText"
                            class="text-sm text-slate-500 dark:text-slate-400"
                          >
                            Đang tải...
                          </p>
                        </div>
                      </div>
                      <button
                        id="resendEmailBtn"
                        class="hidden px-4 py-2 text-primary font-medium rounded-lg hover:bg-primary/10 transition-colors"
                      >
                        Gửi lại email
                      </button>
                    </div>
                  </div>

                  <!-- Two-Factor Auth -->
                  <div class="mb-6">
                    <div
                      class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-xl"
                    >
                      <div class="flex items-center gap-4">
                        <div
                          class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center"
                        >
                          <span
                            class="material-symbols-outlined text-green-600 dark:text-green-400"
                            >security</span
                          >
                        </div>
                        <div>
                          <p class="font-medium text-slate-900 dark:text-white">
                            Xác thực 2 bước
                          </p>
                          <p class="text-sm text-green-600 dark:text-green-400">
                            Đã bật - Được khuyến nghị cho Admin
                          </p>
                        </div>
                      </div>
                      <button
                        class="px-4 py-2 text-slate-600 dark:text-slate-400 font-medium rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                      >
                        Quản lý
                      </button>
                    </div>
                  </div>

                  <!-- Change Password -->
                  <div class="mb-6">
                    <h4
                      class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2"
                    >
                      <span class="material-symbols-outlined">lock</span>
                      Đổi mật khẩu
                    </h4>
                    <form id="passwordForm" class="space-y-4">
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                        >
                          Mật khẩu hiện tại <span class="text-red-500">*</span>
                        </label>
                        <input
                          type="password"
                          id="currentPassword"
                          required
                          class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                        />
                      </div>
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                        >
                          Mật khẩu mới <span class="text-red-500">*</span>
                        </label>
                        <input
                          type="password"
                          id="newPassword"
                          required
                          minlength="8"
                          class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                        />
                        <p
                          class="text-xs text-slate-500 dark:text-slate-400 mt-1"
                        >
                          Tối thiểu 8 ký tự, bao gồm chữ hoa, chữ thường, số và
                          ký tự đặc biệt
                        </p>
                      </div>
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                        >
                          Xác nhận mật khẩu mới
                          <span class="text-red-500">*</span>
                        </label>
                        <input
                          type="password"
                          id="confirmPassword"
                          required
                          minlength="8"
                          class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                        />
                      </div>
                      <div class="flex justify-end">
                        <button
                          type="submit"
                          class="px-5 py-2.5 bg-primary text-white font-medium rounded-xl hover:bg-primary-dark transition-colors shadow-lg shadow-primary/25"
                        >
                          Đổi mật khẩu
                        </button>
                      </div>
                    </form>
                  </div>

                  <!-- Active Sessions -->
                  <div>
                    <div
                      class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-xl"
                    >
                      <div class="flex items-center gap-4">
                        <div
                          class="w-12 h-12 bg-slate-200 dark:bg-slate-700 rounded-lg flex items-center justify-center"
                        >
                          <span
                            class="material-symbols-outlined text-slate-600 dark:text-slate-400"
                            >devices</span
                          >
                        </div>
                        <div>
                          <p class="font-medium text-slate-900 dark:text-white">
                            Phiên đăng nhập
                          </p>
                          <p class="text-sm text-slate-500 dark:text-slate-400">
                            Quản lý các thiết bị đã đăng nhập
                          </p>
                        </div>
                      </div>
                      <button
                        class="px-4 py-2 text-red-600 font-medium rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                      >
                        Đăng xuất tất cả
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Permissions Panel -->
                <div id="panel-permissions" class="p-6 hidden">
                  <h4
                    class="text-lg font-semibold text-slate-900 dark:text-white mb-4"
                  >
                    Quyền hạn của bạn
                  </h4>

                  <div class="space-y-4">
                    <!-- User Management -->
                    <div
                      class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800"
                    >
                      <div class="flex items-center gap-3 mb-2">
                        <span
                          class="material-symbols-outlined text-green-600 dark:text-green-400"
                          >check_circle</span
                        >
                        <h5 class="font-medium text-slate-900 dark:text-white">
                          Quản lý người dùng
                        </h5>
                      </div>
                      <p
                        class="text-sm text-slate-600 dark:text-slate-400 ml-9"
                      >
                        Tạo, sửa, xóa, kích hoạt/vô hiệu hóa tài khoản người
                        dùng
                      </p>
                    </div>

                    <!-- System Settings -->
                    <div
                      class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800"
                    >
                      <div class="flex items-center gap-3 mb-2">
                        <span
                          class="material-symbols-outlined text-green-600 dark:text-green-400"
                          >check_circle</span
                        >
                        <h5 class="font-medium text-slate-900 dark:text-white">
                          Cài đặt hệ thống
                        </h5>
                      </div>
                      <p
                        class="text-sm text-slate-600 dark:text-slate-400 ml-9"
                      >
                        Cấu hình chung, tích hợp API, cài đặt bảo mật
                      </p>
                    </div>

                    <!-- Reports -->
                    <div
                      class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800"
                    >
                      <div class="flex items-center gap-3 mb-2">
                        <span
                          class="material-symbols-outlined text-green-600 dark:text-green-400"
                          >check_circle</span
                        >
                        <h5 class="font-medium text-slate-900 dark:text-white">
                          Báo cáo & Thống kê
                        </h5>
                      </div>
                      <p
                        class="text-sm text-slate-600 dark:text-slate-400 ml-9"
                      >
                        Xem tất cả báo cáo, xuất dữ liệu, thống kê hệ thống
                      </p>
                    </div>

                    <!-- Logs -->
                    <div
                      class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800"
                    >
                      <div class="flex items-center gap-3 mb-2">
                        <span
                          class="material-symbols-outlined text-green-600 dark:text-green-400"
                          >check_circle</span
                        >
                        <h5 class="font-medium text-slate-900 dark:text-white">
                          Nhật ký hệ thống
                        </h5>
                      </div>
                      <p
                        class="text-sm text-slate-600 dark:text-slate-400 ml-9"
                      >
                        Xem lịch sử hoạt động, audit logs, security logs
                      </p>
                    </div>

                    <!-- Database -->
                    <div
                      class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800"
                    >
                      <div class="flex items-center gap-3 mb-2">
                        <span
                          class="material-symbols-outlined text-green-600 dark:text-green-400"
                          >check_circle</span
                        >
                        <h5 class="font-medium text-slate-900 dark:text-white">
                          Quản lý dữ liệu
                        </h5>
                      </div>
                      <p
                        class="text-sm text-slate-600 dark:text-slate-400 ml-9"
                      >
                        Backup, restore, import/export dữ liệu
                      </p>
                    </div>
                  </div>

                  <div
                    class="mt-6 p-4 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-200 dark:border-amber-800"
                  >
                    <div class="flex items-start gap-3">
                      <span
                        class="material-symbols-outlined text-amber-600 dark:text-amber-400"
                        >warning</span
                      >
                      <div>
                        <h5 class="font-medium text-slate-900 dark:text-white">
                          Lưu ý về bảo mật
                        </h5>
                        <p
                          class="text-sm text-slate-600 dark:text-slate-400 mt-1"
                        >
                          Với quyền Admin, mọi hành động của bạn đều được ghi
                          lại. Vui lòng cẩn thận khi thực hiện các thao tác quan
                          trọng.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
      <div
        class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-4 flex items-center gap-3"
      >
        <span id="toastIcon" class="material-symbols-outlined text-green-500"
          >check_circle</span
        >
        <p id="toastMessage" class="text-slate-900 dark:text-white">
          Thành công!
        </p>
      </div>
    </div>

    <script>
      // Tab switching
      function switchTab(tabName) {
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("border-primary", "text-primary");
          btn.classList.add(
            "border-transparent",
            "text-slate-500",
            "dark:text-slate-400",
          );
        });
        document
          .querySelectorAll('[id^="panel-"]')
          .forEach((panel) => panel.classList.add("hidden"));

        document
          .getElementById("tab-" + tabName)
          .classList.add("border-primary", "text-primary");
        document
          .getElementById("tab-" + tabName)
          .classList.remove(
            "border-transparent",
            "text-slate-500",
            "dark:text-slate-400",
          );
        document.getElementById("panel-" + tabName).classList.remove("hidden");
      }

      // Dark mode toggle
      document
        .getElementById("darkModeToggle")
        .addEventListener("click", () => {
          document.documentElement.classList.toggle("dark");
          localStorage.setItem(
            "darkMode",
            document.documentElement.classList.contains("dark"),
          );
        });

      // Load dark mode preference
      if (localStorage.getItem("darkMode") === "true") {
        document.documentElement.classList.add("dark");
      }

      // Load profile data
      let profileData = null;

      async function loadProfile() {
        try {
          const response = await fetch("/api/profile");
          const result = await response.json();

          if (result.success) {
            profileData = result.data;
            updateUI(profileData);
          }
        } catch (error) {
          console.error("Error loading profile:", error);
          showToast("Lỗi tải thông tin hồ sơ", "error");
        }
      }

      function updateUI(data) {
        // Avatar
        if (data.avatarUrl) {
          document.getElementById("avatarImg").src = data.avatarUrl;
          document.getElementById("avatarImg").classList.remove("hidden");
          document.getElementById("avatarPlaceholder").classList.add("hidden");
        } else {
          document.getElementById("avatarInitials").textContent = getInitials(
            data.fullName,
          );
        }

        // Name
        document.getElementById("profileName").textContent =
          data.fullName || "Administrator";

        // Form fields
        document.getElementById("fullName").value = data.fullName || "";
        document.getElementById("email").value = data.email || "";
        document.getElementById("phoneNumber").value = data.phoneNumber || "";
        document.getElementById("dateOfBirth").value = data.dateOfBirth || "";
        document.getElementById("gender").value = data.gender || "";
        document.getElementById("address").value = data.address || "";
        document.getElementById("identityNumber").value =
          data.identityNumber || "";

        // Profile completion
        const completion = calculateCompletion(data);
        document.getElementById("completionPercent").textContent =
          completion + "%";
        document.getElementById("completionBar").style.width = completion + "%";

        // Verification badge
        updateVerificationBadge(data.emailVerified);

        // Email status
        updateEmailStatus(data.email, data.emailVerified);
      }

      function getInitials(name) {
        if (!name) return "AD";
        return name
          .split(" ")
          .map((w) => w[0])
          .join("")
          .substring(0, 2)
          .toUpperCase();
      }

      function calculateCompletion(data) {
        const fields = [
          "fullName",
          "email",
          "phoneNumber",
          "dateOfBirth",
          "gender",
          "address",
        ];
        const filled = fields.filter((f) => data[f]).length;
        return Math.round((filled / fields.length) * 100);
      }

      function updateVerificationBadge(verified) {
        const badge = document.getElementById("verificationBadge");
        if (verified) {
          badge.innerHTML = `<span class="inline-flex items-center gap-1.5 px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 text-sm font-medium rounded-full">
            <span class="material-symbols-outlined text-[16px]">verified</span>
            Email đã xác thực
          </span>`;
        } else {
          badge.innerHTML = `<span class="inline-flex items-center gap-1.5 px-3 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 text-sm font-medium rounded-full">
            <span class="material-symbols-outlined text-[16px]">warning</span>
            Email chưa xác thực
          </span>`;
        }
      }

      function updateEmailStatus(email, verified) {
        const statusText = document.getElementById("emailStatusText");
        const iconWrapper = document.getElementById("emailIconWrapper");
        const resendBtn = document.getElementById("resendEmailBtn");

        if (verified) {
          statusText.innerHTML = `<span class="text-green-600 dark:text-green-400">${email} - Đã xác thực</span>`;
          iconWrapper.className =
            "w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center";
          iconWrapper.innerHTML =
            '<span class="material-symbols-outlined text-green-600 dark:text-green-400">verified</span>';
          resendBtn.classList.add("hidden");
        } else {
          statusText.innerHTML = `<span class="text-yellow-600 dark:text-yellow-400">${email} - Chưa xác thực</span>`;
          iconWrapper.className =
            "w-12 h-12 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg flex items-center justify-center";
          iconWrapper.innerHTML =
            '<span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400">mail</span>';
          resendBtn.classList.remove("hidden");
        }
      }

      // Form submission
      document
        .getElementById("profileForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = {
            fullName: document.getElementById("fullName").value,
            phoneNumber: document.getElementById("phoneNumber").value,
            dateOfBirth: document.getElementById("dateOfBirth").value,
            gender: document.getElementById("gender").value,
            address: document.getElementById("address").value,
            identityNumber: document.getElementById("identityNumber").value,
          };

          try {
            const response = await fetch("/api/profile/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });

            const result = await response.json();
            if (result.success) {
              showToast("Cập nhật thông tin thành công!", "success");
              loadProfile();
            } else {
              showToast(result.message || "Có lỗi xảy ra", "error");
            }
          } catch (error) {
            showToast("Lỗi khi cập nhật thông tin", "error");
          }
        });

      // Password form
      document
        .getElementById("passwordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;

          if (newPassword !== confirmPassword) {
            showToast("Mật khẩu xác nhận không khớp", "error");
            return;
          }

          try {
            const response = await fetch("/api/profile/change-password", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                currentPassword:
                  document.getElementById("currentPassword").value,
                newPassword: newPassword,
              }),
            });

            const result = await response.json();
            if (result.success) {
              showToast("Đổi mật khẩu thành công!", "success");
              document.getElementById("passwordForm").reset();
            } else {
              showToast(result.message || "Có lỗi xảy ra", "error");
            }
          } catch (error) {
            showToast("Lỗi khi đổi mật khẩu", "error");
          }
        });

      // Avatar upload
      document
        .getElementById("avatarUploadBtn")
        .addEventListener("click", () => {
          document.getElementById("avatarInput").click();
        });

      document
        .getElementById("avatarInput")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          if (file.size > 5 * 1024 * 1024) {
            showToast("File quá lớn. Tối đa 5MB", "error");
            return;
          }

          const formData = new FormData();
          formData.append("file", file);

          try {
            const response = await fetch("/api/profile/avatar", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();
            if (result.success) {
              showToast("Cập nhật ảnh đại diện thành công!", "success");
              loadProfile();
            } else {
              showToast(result.message || "Có lỗi xảy ra", "error");
            }
          } catch (error) {
            showToast("Lỗi khi upload ảnh", "error");
          }
        });

      // Resend verification email
      document
        .getElementById("resendEmailBtn")
        .addEventListener("click", async () => {
          try {
            const response = await fetch("/api/profile/resend-verification", {
              method: "POST",
            });
            const result = await response.json();
            showToast(result.message, result.success ? "success" : "error");
          } catch (error) {
            showToast("Lỗi khi gửi email", "error");
          }
        });

      // Reset form
      function resetForm() {
        if (profileData) {
          updateUI(profileData);
        }
      }

      // Toast notification
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const icon = document.getElementById("toastIcon");
        const msg = document.getElementById("toastMessage");

        msg.textContent = message;
        if (type === "success") {
          icon.textContent = "check_circle";
          icon.className = "material-symbols-outlined text-green-500";
        } else {
          icon.textContent = "error";
          icon.className = "material-symbols-outlined text-red-500";
        }

        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), 3000);
      }

      // Initialize
      loadProfile();
    </script>
  </body>
</html>
