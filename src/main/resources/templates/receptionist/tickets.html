<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Ticket - ABClinic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script th:src="@{/js/tailwind-config.js}"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap"
    />
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
      .material-symbols-outlined.fill {
        font-variation-settings: "FILL" 1;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-slate-100 font-sans"
  >
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside th:replace="~{fragments/layout :: receptionist-sidebar}"></aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Header -->
        <header
          class="bg-white dark:bg-[#1a2634] border-b border-slate-200 dark:border-slate-800 px-6 py-4"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <button
                onclick="toggleSidebar()"
                class="lg:hidden p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
              >
                <span class="material-symbols-outlined">menu</span>
              </button>
              <div>
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">
                  Quản lý Ticket
                </h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Tạo và theo dõi ticket hỗ trợ gửi đến bác sĩ
                </p>
              </div>
            </div>
            <button
              onclick="openCreateModal()"
              class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors"
            >
              <span class="material-symbols-outlined text-[20px]">add</span>
              <span class="hidden sm:inline">Tạo Ticket</span>
            </button>
          </div>
        </header>

        <!-- Filters -->
        <div
          class="bg-white dark:bg-[#1a2634] border-b border-slate-200 dark:border-slate-800 px-6 py-4"
        >
          <div class="flex flex-wrap items-center gap-4">
            <!-- Search -->
            <div class="flex-1 min-w-[250px] relative">
              <span
                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
                >search</span
              >
              <input
                type="text"
                id="searchInput"
                placeholder="Tìm theo tiêu đề, bệnh nhân..."
                onkeyup="debounceSearch()"
                class="w-full pl-10 pr-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              />
            </div>

            <!-- Status Filter -->
            <select
              id="statusFilter"
              onchange="filterTickets()"
              class="px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
            >
              <option value="">Tất cả trạng thái</option>
              <option value="OPEN">Mới mở</option>
              <option value="ASSIGNED">Đã gán</option>
              <option value="IN_PROGRESS">Đang xử lý</option>
              <option value="RESOLVED">Đã giải quyết</option>
              <option value="CLOSED">Đã đóng</option>
            </select>

            <!-- Priority Filter -->
            <select
              id="priorityFilter"
              onchange="filterTickets()"
              class="px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
            >
              <option value="">Tất cả mức độ</option>
              <option value="URGENT">Khẩn cấp</option>
              <option value="HIGH">Cao</option>
              <option value="MEDIUM">Trung bình</option>
              <option value="LOW">Thấp</option>
            </select>

            <button
              onclick="refreshTickets()"
              class="px-4 py-2.5 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors"
              title="Làm mới"
            >
              <span class="material-symbols-outlined">refresh</span>
            </button>
          </div>
        </div>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-6">
          <!-- Statistics Cards -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-blue-600 dark:text-blue-400"
                    >confirmation_number</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="totalTickets"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Tổng ticket đã tạo</p>
                </div>
              </div>
            </div>
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-amber-600 dark:text-amber-400"
                    >schedule</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="pendingTickets"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Chờ xử lý</p>
                </div>
              </div>
            </div>
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-purple-600 dark:text-purple-400"
                    >sync</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="inProgressTickets"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Đang xử lý</p>
                </div>
              </div>
            </div>
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-green-600 dark:text-green-400"
                    >task_alt</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="resolvedTickets"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Đã xử lý</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Tickets Table -->
          <div
            class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden"
          >
            <div
              class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
            >
              <h3 class="font-semibold text-slate-900 dark:text-white">
                Danh sách Ticket
              </h3>
              <span id="resultsInfo" class="text-sm text-slate-500"></span>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 dark:bg-slate-800/50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      ID
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Tiêu đề
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Bệnh nhân
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Bác sĩ xử lý
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Mức độ
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Trạng thái
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Ngày tạo
                    </th>
                    <th
                      class="px-6 py-3 text-right text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Thao tác
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="ticketsTableBody"
                  class="divide-y divide-slate-200 dark:divide-slate-700"
                >
                  <tr>
                    <td colspan="8" class="px-6 py-12 text-center">
                      <span
                        class="material-symbols-outlined text-5xl text-slate-300 dark:text-slate-600"
                        >hourglass_empty</span
                      >
                      <p class="mt-2 text-slate-500">Đang tải dữ liệu...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Create/Edit Ticket Modal -->
    <div
      id="ticketFormModal"
      class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-[#1a2634] rounded-2xl w-full max-w-xl max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h3
            id="formModalTitle"
            class="text-lg font-semibold text-slate-900 dark:text-white"
          >
            Tạo Ticket mới
          </h3>
          <button
            onclick="closeFormModal()"
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <form
          id="ticketForm"
          onsubmit="saveTicket(event)"
          class="flex-1 overflow-y-auto p-6"
        >
          <input type="hidden" id="ticketId" />

          <div class="space-y-4">
            <!-- Patient -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >
                Bệnh nhân *
              </label>
              <select
                id="patientId"
                required
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              >
                <option value="">-- Chọn bệnh nhân --</option>
              </select>
            </div>

            <!-- Title -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >
                Tiêu đề *
              </label>
              <input
                type="text"
                id="ticketTitle"
                required
                placeholder="Mô tả ngắn gọn vấn đề"
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              />
            </div>

            <!-- Category & Priority -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                >
                  Danh mục
                </label>
                <select
                  id="ticketCategory"
                  class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                >
                  <option value="MEDICAL_QUERY">Câu hỏi y tế</option>
                  <option value="APPOINTMENT">Lịch hẹn</option>
                  <option value="PRESCRIPTION">Đơn thuốc</option>
                  <option value="TECHNICAL">Kỹ thuật</option>
                  <option value="OTHER">Khác</option>
                </select>
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                >
                  Mức độ ưu tiên
                </label>
                <select
                  id="ticketPriority"
                  class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                >
                  <option value="LOW">Thấp</option>
                  <option value="MEDIUM" selected>Trung bình</option>
                  <option value="HIGH">Cao</option>
                  <option value="URGENT">Khẩn cấp</option>
                </select>
              </div>
            </div>

            <!-- Assign Doctor -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >
                Gán cho bác sĩ
              </label>
              <select
                id="assignedToId"
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              >
                <option value="">-- Chưa gán --</option>
              </select>
            </div>

            <!-- Description -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >
                Mô tả chi tiết *
              </label>
              <textarea
                id="ticketDescription"
                rows="4"
                required
                placeholder="Mô tả chi tiết vấn đề cần hỗ trợ..."
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary resize-none"
              ></textarea>
            </div>
          </div>
        </form>

        <div
          class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
        >
          <button
            onclick="closeFormModal()"
            class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
          >
            Hủy
          </button>
          <button
            type="submit"
            form="ticketForm"
            class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors flex items-center gap-2"
          >
            <span class="material-symbols-outlined text-[20px]">send</span>
            Gửi Ticket
          </button>
        </div>
      </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div
      id="ticketDetailModal"
      class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-[#1a2634] rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
            Chi tiết Ticket #<span id="detailTicketId"></span>
          </h3>
          <div class="flex items-center gap-2">
            <button
              onclick="editCurrentTicket()"
              class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
              title="Chỉnh sửa"
            >
              <span class="material-symbols-outlined">edit</span>
            </button>
            <button
              onclick="closeDetailModal()"
              class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
            >
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>

        <div id="ticketDetailContent" class="flex-1 overflow-y-auto p-6">
          <!-- Content will be loaded dynamically -->
        </div>

        <!-- Reply Section -->
        <div class="px-6 py-4 border-t border-slate-200 dark:border-slate-700">
          <div class="flex gap-3">
            <input
              type="text"
              id="replyMessage"
              placeholder="Nhập tin nhắn cho bác sĩ..."
              onkeypress="if(event.key==='Enter') sendMessage()"
              class="flex-1 px-4 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
            />
            <button
              onclick="sendMessage()"
              class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors flex items-center gap-2"
            >
              <span class="material-symbols-outlined text-[20px]">send</span>
              Gửi
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-4 right-4 z-50 space-y-2"
    ></div>

    <!-- Scripts -->
    <script>
      // Toggle sidebar function for mobile
      function toggleSidebar() {
        const sidebar = document.querySelector("[data-sidebar]");
        if (sidebar) {
          sidebar.classList.toggle("sidebar-hidden");
          sidebar.classList.toggle("sidebar-open");
        }
      }
    </script>
    <script>
      // Global state
      let allTickets = [];
      let filteredTickets = [];
      let patients = [];
      let doctors = [];
      let currentTicket = null;
      let searchTimeout = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadPatients();
        loadDoctors();
        loadTickets();
      });

      // Load patients
      async function loadPatients() {
        try {
          const response = await fetch("/api/receptionist/patients");
          if (response.ok) {
            patients = await response.json();
            populatePatientSelect();
          }
        } catch (error) {
          console.error("Error loading patients:", error);
        }
      }

      // Load doctors
      async function loadDoctors() {
        try {
          const response = await fetch("/api/receptionist/doctors");
          if (response.ok) {
            doctors = await response.json();
            populateDoctorSelect();
          }
        } catch (error) {
          console.error("Error loading doctors:", error);
        }
      }

      // Populate patient select
      function populatePatientSelect() {
        const select = document.getElementById("patientId");
        select.innerHTML =
          '<option value="">-- Chọn bệnh nhân --</option>' +
          patients
            .map(
              (p) =>
                `<option value="${p.id}">${p.fullName} - ${p.phoneNumber || p.email}</option>`,
            )
            .join("");
      }

      // Populate doctor select
      function populateDoctorSelect() {
        const select = document.getElementById("assignedToId");
        select.innerHTML =
          '<option value="">-- Chưa gán --</option>' +
          doctors
            .map((d) => `<option value="${d.id}">BS. ${d.fullName}</option>`)
            .join("");
      }

      // Load tickets
      async function loadTickets() {
        try {
          const response = await fetch("/api/receptionist/tickets");
          if (!response.ok) throw new Error("Failed to load tickets");

          const data = await response.json();
          allTickets = data.tickets || [];
          filterTickets();
          updateStatistics();
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể tải danh sách ticket", "error");
        }
      }

      // Refresh tickets
      function refreshTickets() {
        loadTickets();
        showToast("Đã làm mới danh sách", "info");
      }

      // Debounced search
      function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => filterTickets(), 300);
      }

      // Filter tickets
      function filterTickets() {
        const search = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const status = document.getElementById("statusFilter").value;
        const priority = document.getElementById("priorityFilter").value;

        filteredTickets = allTickets.filter((ticket) => {
          const matchSearch =
            !search ||
            ticket.title?.toLowerCase().includes(search) ||
            ticket.patientName?.toLowerCase().includes(search) ||
            ticket.description?.toLowerCase().includes(search);
          const matchStatus = !status || ticket.status === status;
          const matchPriority = !priority || ticket.priority === priority;
          return matchSearch && matchStatus && matchPriority;
        });

        renderTickets();
      }

      // Update statistics
      function updateStatistics() {
        document.getElementById("totalTickets").textContent = allTickets.length;
        document.getElementById("pendingTickets").textContent =
          allTickets.filter((t) => t.status === "OPEN").length;
        document.getElementById("inProgressTickets").textContent =
          allTickets.filter(
            (t) => t.status === "IN_PROGRESS" || t.status === "ASSIGNED",
          ).length;
        document.getElementById("resolvedTickets").textContent =
          allTickets.filter(
            (t) => t.status === "RESOLVED" || t.status === "CLOSED",
          ).length;
      }

      // Render tickets table
      function renderTickets() {
        const tbody = document.getElementById("ticketsTableBody");

        if (filteredTickets.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="px-6 py-12 text-center">
                <span class="material-symbols-outlined text-5xl text-slate-300 dark:text-slate-600">inbox</span>
                <p class="mt-2 text-slate-500">Chưa có ticket nào</p>
                <button onclick="openCreateModal()" class="mt-4 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg">
                  Tạo ticket đầu tiên
                </button>
              </td>
            </tr>
          `;
          document.getElementById("resultsInfo").textContent = "0 ticket";
          return;
        }

        tbody.innerHTML = filteredTickets
          .map(
            (ticket) => `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
            <td class="px-6 py-4 text-sm font-medium text-primary">#${ticket.id}</td>
            <td class="px-6 py-4">
              <div class="text-sm font-medium text-slate-900 dark:text-white">${escapeHtml(ticket.title)}</div>
              <div class="text-xs text-slate-500 truncate max-w-xs">${escapeHtml(ticket.description || "")}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-slate-900 dark:text-white">${escapeHtml(ticket.patientName || "N/A")}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-slate-600 dark:text-slate-400">${ticket.assignedToName ? "BS. " + escapeHtml(ticket.assignedToName) : '<span class="text-slate-400 italic">Chưa gán</span>'}</div>
            </td>
            <td class="px-6 py-4">${getPriorityBadge(ticket.priority)}</td>
            <td class="px-6 py-4">${getStatusBadge(ticket.status)}</td>
            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${formatDate(ticket.createdAt)}</td>
            <td class="px-6 py-4 text-right">
              <div class="flex items-center justify-end gap-1">
                <button onclick="viewTicket(${ticket.id})" class="p-2 text-primary hover:bg-primary/10 rounded-lg transition-colors" title="Xem chi tiết">
                  <span class="material-symbols-outlined text-[20px]">visibility</span>
                </button>
                <button onclick="editTicket(${ticket.id})" class="p-2 text-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors" title="Sửa">
                  <span class="material-symbols-outlined text-[20px]">edit</span>
                </button>
                <button onclick="deleteTicket(${ticket.id})" class="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="Xóa">
                  <span class="material-symbols-outlined text-[20px]">delete</span>
                </button>
              </div>
            </td>
          </tr>
        `,
          )
          .join("");

        document.getElementById("resultsInfo").textContent =
          `${filteredTickets.length} ticket`;
      }

      // Open create modal
      function openCreateModal() {
        document.getElementById("formModalTitle").textContent =
          "Tạo Ticket mới";
        document.getElementById("ticketForm").reset();
        document.getElementById("ticketId").value = "";
        document.getElementById("ticketPriority").value = "MEDIUM";
        openFormModal();
      }

      // Edit ticket
      async function editTicket(id) {
        try {
          const response = await fetch(`/api/receptionist/tickets/${id}`);
          if (!response.ok) throw new Error("Failed to load ticket");

          const ticket = await response.json();

          document.getElementById("formModalTitle").textContent =
            "Chỉnh sửa Ticket";
          document.getElementById("ticketId").value = ticket.id;
          document.getElementById("patientId").value = ticket.patientId || "";
          document.getElementById("ticketTitle").value = ticket.title || "";
          document.getElementById("ticketCategory").value =
            ticket.category || "OTHER";
          document.getElementById("ticketPriority").value =
            ticket.priority || "MEDIUM";
          document.getElementById("assignedToId").value =
            ticket.assignedToId || "";
          document.getElementById("ticketDescription").value =
            ticket.description || "";

          openFormModal();
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể tải thông tin ticket", "error");
        }
      }

      // Edit current ticket from detail modal
      function editCurrentTicket() {
        if (currentTicket) {
          closeDetailModal();
          editTicket(currentTicket.id);
        }
      }

      // Save ticket (create or update)
      async function saveTicket(event) {
        event.preventDefault();

        const id = document.getElementById("ticketId").value;
        const data = {
          patientId: document.getElementById("patientId").value,
          title: document.getElementById("ticketTitle").value,
          category: document.getElementById("ticketCategory").value,
          priority: document.getElementById("ticketPriority").value,
          assignedToId: document.getElementById("assignedToId").value || null,
          description: document.getElementById("ticketDescription").value,
        };

        try {
          const url = id
            ? `/api/receptionist/tickets/${id}`
            : "/api/receptionist/tickets";
          const method = id ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();
          if (result.success) {
            showToast(
              id ? "Cập nhật ticket thành công" : "Tạo ticket thành công",
              "success",
            );
            closeFormModal();
            loadTickets();
          } else {
            showToast(result.message || "Lỗi lưu ticket", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể lưu ticket", "error");
        }
      }

      // Delete ticket
      async function deleteTicket(id) {
        if (!confirm("Bạn có chắc muốn xóa ticket này?")) return;

        try {
          const response = await fetch(`/api/receptionist/tickets/${id}`, {
            method: "DELETE",
          });

          const result = await response.json();
          if (result.success) {
            showToast("Xóa ticket thành công", "success");
            loadTickets();
          } else {
            showToast(result.message || "Lỗi xóa ticket", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể xóa ticket", "error");
        }
      }

      // View ticket detail
      async function viewTicket(id) {
        document.getElementById("detailTicketId").textContent = id;

        try {
          const response = await fetch(`/api/receptionist/tickets/${id}`);
          if (!response.ok) throw new Error("Failed to load ticket");

          currentTicket = await response.json();
          renderTicketDetail(currentTicket);
          openDetailModal();
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể tải chi tiết ticket", "error");
        }
      }

      // Render ticket detail
      function renderTicketDetail(ticket) {
        const content = document.getElementById("ticketDetailContent");

        content.innerHTML = `
          <div class="space-y-6">
            <!-- Ticket Info -->
            <div class="bg-slate-50 dark:bg-slate-800 rounded-xl p-4">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <p class="text-xs text-slate-500 mb-1">Bệnh nhân</p>
                  <p class="text-sm font-medium text-slate-900 dark:text-white">${escapeHtml(ticket.patientName || "N/A")}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 mb-1">Bác sĩ xử lý</p>
                  <p class="text-sm font-medium text-slate-900 dark:text-white">${ticket.assignedToName ? "BS. " + escapeHtml(ticket.assignedToName) : '<span class="text-slate-400 italic">Chưa gán</span>'}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 mb-1">Danh mục</p>
                  <p class="text-sm font-medium text-slate-900 dark:text-white">${getCategoryName(ticket.category)}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 mb-1">Ngày tạo</p>
                  <p class="text-sm font-medium text-slate-900 dark:text-white">${formatDateTime(ticket.createdAt)}</p>
                </div>
              </div>
              <div class="flex items-center gap-4 mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                <div>
                  <p class="text-xs text-slate-500 mb-1">Mức độ</p>
                  ${getPriorityBadge(ticket.priority)}
                </div>
                <div>
                  <p class="text-xs text-slate-500 mb-1">Trạng thái</p>
                  ${getStatusBadge(ticket.status)}
                </div>
                ${
                  ticket.resolvedAt
                    ? `
                <div>
                  <p class="text-xs text-slate-500 mb-1">Ngày xử lý</p>
                  <p class="text-sm font-medium text-green-600">${formatDateTime(ticket.resolvedAt)}</p>
                </div>
                `
                    : ""
                }
              </div>
            </div>

            <!-- Description -->
            <div>
              <h4 class="text-sm font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px]">description</span>
                Mô tả vấn đề
              </h4>
              <div class="bg-slate-50 dark:bg-slate-800 rounded-lg p-4">
                <p class="text-sm text-slate-600 dark:text-slate-400 whitespace-pre-wrap">${escapeHtml(ticket.description || "Không có mô tả")}</p>
              </div>
            </div>

            <!-- Messages -->
            <div>
              <h4 class="text-sm font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px]">forum</span>
                Trao đổi với bác sĩ (${ticket.messages?.length || 0})
              </h4>
              <div class="space-y-3 max-h-64 overflow-y-auto">
                ${
                  ticket.messages && ticket.messages.length > 0
                    ? ticket.messages
                        .map(
                          (msg) => `
                  <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full ${msg.senderRole === "DOCTOR" ? "bg-green-500" : "bg-primary"} text-white flex items-center justify-center text-xs font-bold flex-shrink-0">
                      ${msg.senderName ? msg.senderName.charAt(0).toUpperCase() : "?"}
                    </div>
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <span class="text-sm font-medium text-slate-900 dark:text-white">${escapeHtml(msg.senderName || "Unknown")}</span>
                        <span class="text-xs text-slate-500">${formatDateTime(msg.createdAt)}</span>
                      </div>
                      <p class="text-sm text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg p-3">${escapeHtml(msg.messageText)}</p>
                    </div>
                  </div>
                `,
                        )
                        .join("")
                    : '<p class="text-sm text-slate-500 text-center py-8">Chưa có tin nhắn. Hãy bắt đầu cuộc hội thoại!</p>'
                }
              </div>
            </div>
          </div>
        `;
      }

      // Send message
      async function sendMessage() {
        const message = document.getElementById("replyMessage").value.trim();
        if (!message) {
          showToast("Vui lòng nhập nội dung tin nhắn", "warning");
          return;
        }

        if (!currentTicket) return;

        try {
          const response = await fetch(
            `/api/receptionist/tickets/${currentTicket.id}/messages`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                messageText: message,
                messageType: "TEXT",
                isInternalNote: false,
              }),
            },
          );

          const result = await response.json();
          if (result.success) {
            document.getElementById("replyMessage").value = "";
            showToast("Gửi tin nhắn thành công", "success");
            viewTicket(currentTicket.id); // Reload detail
          } else {
            showToast(result.message || "Lỗi gửi tin nhắn", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể gửi tin nhắn", "error");
        }
      }

      // Modal functions
      function openFormModal() {
        document.getElementById("ticketFormModal").classList.remove("hidden");
        document.getElementById("ticketFormModal").classList.add("flex");
      }

      function closeFormModal() {
        document.getElementById("ticketFormModal").classList.add("hidden");
        document.getElementById("ticketFormModal").classList.remove("flex");
      }

      function openDetailModal() {
        document.getElementById("ticketDetailModal").classList.remove("hidden");
        document.getElementById("ticketDetailModal").classList.add("flex");
      }

      function closeDetailModal() {
        document.getElementById("ticketDetailModal").classList.add("hidden");
        document.getElementById("ticketDetailModal").classList.remove("flex");
        currentTicket = null;
      }

      // Helper functions
      function getPriorityBadge(priority) {
        const map = {
          URGENT:
            '<span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 text-xs font-medium rounded-full">Khẩn cấp</span>',
          HIGH: '<span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 text-xs font-medium rounded-full">Cao</span>',
          MEDIUM:
            '<span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-xs font-medium rounded-full">Trung bình</span>',
          LOW: '<span class="px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-medium rounded-full">Thấp</span>',
        };
        return map[priority] || map.MEDIUM;
      }

      function getStatusBadge(status) {
        const map = {
          OPEN: '<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-xs font-medium rounded-full">Mới mở</span>',
          ASSIGNED:
            '<span class="px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 text-xs font-medium rounded-full">Đã gán</span>',
          IN_PROGRESS:
            '<span class="px-2 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 text-xs font-medium rounded-full">Đang xử lý</span>',
          RESOLVED:
            '<span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-medium rounded-full">Đã giải quyết</span>',
          CLOSED:
            '<span class="px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-medium rounded-full">Đã đóng</span>',
        };
        return map[status] || map.OPEN;
      }

      function getCategoryName(category) {
        const map = {
          MEDICAL_QUERY: "Câu hỏi y tế",
          APPOINTMENT: "Lịch hẹn",
          PRESCRIPTION: "Đơn thuốc",
          TECHNICAL: "Kỹ thuật",
          OTHER: "Khác",
        };
        return map[category] || category || "N/A";
      }

      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleDateString("vi-VN");
      }

      function formatDateTime(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleString("vi-VN");
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showToast(message, type = "info") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");

        const colors = {
          success: "bg-green-500",
          error: "bg-red-500",
          info: "bg-blue-500",
          warning: "bg-amber-500",
        };

        const icons = {
          success: "check_circle",
          error: "error",
          info: "info",
          warning: "warning",
        };

        toast.className = `flex items-center gap-3 px-4 py-3 ${colors[type]} text-white rounded-lg shadow-lg min-w-[300px]`;
        toast.innerHTML = `
          <span class="material-symbols-outlined">${icons[type]}</span>
          <span class="flex-1">${message}</span>
          <button onclick="this.parentElement.remove()" class="p-1 hover:bg-white/20 rounded">
            <span class="material-symbols-outlined text-[18px]">close</span>
          </button>
        `;

        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    </script>
  </body>
</html>
