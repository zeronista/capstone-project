<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/layout :: head(title='Trang B·ªánh Nh√¢n')}">
  </head>
  <body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 font-sans h-screen flex overflow-hidden"
  >
    <!-- Mobile Sidebar Backdrop -->
    <div th:replace="~{fragments/layout :: sidebar-backdrop}"></div>

    <!-- Patient Sidebar -->
    <aside th:replace="~{fragments/layout :: patient-sidebar}"></aside>

    <!-- Main Content -->
    <main
      class="flex-1 flex flex-col min-w-0 bg-gradient-to-br from-slate-50 via-white to-blue-50/30 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800"
    >
      <!-- Header -->
      <header
        th:replace="~{fragments/layout :: header(title='Trang B·ªánh Nh√¢n')}"
      ></header>

      <!-- Content Area -->
      <div class="flex-1 overflow-y-auto p-4 lg:p-6">
        <div class="max-w-7xl mx-auto flex flex-col gap-6">
          <!-- Welcome Hero Section -->
          <div
            class="relative overflow-hidden bg-gradient-to-r from-blue-600 via-blue-500 to-emerald-500 rounded-2xl p-6 lg:p-8 shadow-xl"
          >
            <!-- Background Pattern -->
            <div class="absolute inset-0 opacity-10">
              <svg
                class="w-full h-full"
                viewBox="0 0 100 100"
                preserveAspectRatio="none"
              >
                <defs>
                  <pattern
                    id="grid"
                    width="10"
                    height="10"
                    patternUnits="userSpaceOnUse"
                  >
                    <path
                      d="M 10 0 L 0 0 0 10"
                      fill="none"
                      stroke="white"
                      stroke-width="0.5"
                    />
                  </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#grid)" />
              </svg>
            </div>
            <!-- Decorative Circles -->
            <div
              class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"
            ></div>
            <div
              class="absolute -bottom-10 -left-10 w-32 h-32 bg-emerald-300/20 rounded-full blur-2xl"
            ></div>

            <div
              class="relative flex flex-col lg:flex-row lg:items-center justify-between gap-6"
            >
              <div class="flex items-center gap-4">
                <!-- Avatar -->
                <div
                  class="w-16 h-16 lg:w-20 lg:h-20 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center border border-white/30 shadow-lg"
                >
                  <span
                    class="text-3xl lg:text-4xl font-bold text-white"
                    th:text="${patient != null && patient.userInfo != null && patient.userInfo.fullName != null} ? ${patient.userInfo.fullName.substring(0,1)} : (${session.userFullName} != null ? ${session.userFullName.substring(0,1)} : 'B')"
                    >B</span
                  >
                </div>
                <div>
                  <p class="text-blue-100 text-sm font-medium mb-1">
                    Ch√†o m·ª´ng tr·ªü l·∫°i
                  </p>
                  <h1 class="text-2xl lg:text-3xl font-bold text-white">
                    <span
                      id="patientName"
                      th:text="${patient != null && patient.userInfo != null && patient.userInfo.fullName != null} ? ${patient.userInfo.fullName} : (${session.userFullName} != null ? ${session.userFullName} : 'B·ªánh nh√¢n')"
                      >B·ªánh nh√¢n</span
                    >!
                  </h1>
                  <p class="text-blue-100 text-sm mt-1">
                    Ch√∫c b·∫°n m·ªôt ng√†y tr√†n ƒë·∫ßy s·ª©c kh·ªèe üí™
                  </p>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="flex flex-wrap gap-3">
                <a
                  th:href="@{/patient/call}"
                  class="group flex items-center gap-2 px-5 py-3 bg-white text-blue-600 rounded-xl font-semibold hover:bg-blue-50 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5"
                >
                  <span
                    class="material-symbols-outlined text-[20px] group-hover:animate-pulse"
                    >call</span
                  >
                  G·ªçi t∆∞ v·∫•n
                </a>
                <a
                  th:href="@{/patient/appointments}"
                  class="group flex items-center gap-2 px-5 py-3 bg-white/20 backdrop-blur-sm text-white border border-white/30 rounded-xl font-semibold hover:bg-white/30 transition-all"
                >
                  <span class="material-symbols-outlined text-[20px]"
                    >calendar_month</span
                  >
                  ƒê·∫∑t l·ªãch h·∫πn
                </a>
                <a
                  th:href="@{/patient/tickets}"
                  class="group flex items-center gap-2 px-5 py-3 bg-white/20 backdrop-blur-sm text-white border border-white/30 rounded-xl font-semibold hover:bg-white/30 transition-all"
                >
                  <span class="material-symbols-outlined text-[20px]"
                    >support</span
                  >
                  H·ªó tr·ª£
                </a>
              </div>
            </div>
          </div>

          <!-- Stats Cards -->
          <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
            <!-- Prescriptions -->
            <div
              class="group bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm hover:shadow-lg transition-all duration-300 border border-slate-100 dark:border-slate-700 hover:-translate-y-1"
            >
              <div class="flex items-center justify-between mb-3">
                <div
                  class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform"
                >
                  <span class="material-symbols-outlined text-white text-[24px]"
                    >prescriptions</span
                  >
                </div>
                <span
                  class="text-xs font-medium text-slate-400 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full"
                  >T·ªïng</span
                >
              </div>
              <h3
                id="statPrescriptions"
                class="text-3xl font-bold text-slate-900 dark:text-white"
              >
                0
              </h3>
              <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                ƒê∆°n thu·ªëc
              </p>
            </div>

            <!-- Treatment Plans -->
            <div
              class="group bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm hover:shadow-lg transition-all duration-300 border border-slate-100 dark:border-slate-700 hover:-translate-y-1"
            >
              <div class="flex items-center justify-between mb-3">
                <div
                  class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/30 group-hover:scale-110 transition-transform"
                >
                  <span class="material-symbols-outlined text-white text-[24px]"
                    >medical_services</span
                  >
                </div>
                <span
                  class="text-xs font-medium text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded-full"
                  >ƒêang th·ª±c hi·ªán</span
                >
              </div>
              <h3
                id="statTreatments"
                class="text-3xl font-bold text-slate-900 dark:text-white"
              >
                0
              </h3>
              <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã
              </p>
            </div>

            <!-- Support Tickets -->
            <div
              class="group bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm hover:shadow-lg transition-all duration-300 border border-slate-100 dark:border-slate-700 hover:-translate-y-1"
            >
              <div class="flex items-center justify-between mb-3">
                <div
                  class="w-12 h-12 bg-gradient-to-br from-purple-500 to-violet-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/30 group-hover:scale-110 transition-transform"
                >
                  <span class="material-symbols-outlined text-white text-[24px]"
                    >confirmation_number</span
                  >
                </div>
                <span
                  class="text-xs font-medium text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/30 px-2 py-1 rounded-full"
                  >Ticket</span
                >
              </div>
              <h3
                id="statTickets"
                class="text-3xl font-bold text-slate-900 dark:text-white"
              >
                0
              </h3>
              <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                Y√™u c·∫ßu h·ªó tr·ª£
              </p>
            </div>

            <!-- In Progress -->
            <div
              class="group bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm hover:shadow-lg transition-all duration-300 border border-slate-100 dark:border-slate-700 hover:-translate-y-1"
            >
              <div class="flex items-center justify-between mb-3">
                <div
                  class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg shadow-amber-500/30 group-hover:scale-110 transition-transform"
                >
                  <span class="material-symbols-outlined text-white text-[24px]"
                    >hourglass_empty</span
                  >
                </div>
                <span
                  class="text-xs font-medium text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/30 px-2 py-1 rounded-full"
                  >Ch·ªù x·ª≠ l√Ω</span
                >
              </div>
              <h3
                id="statOpenTickets"
                class="text-3xl font-bold text-slate-900 dark:text-white"
              >
                0
              </h3>
              <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                ƒêang x·ª≠ l√Ω
              </p>
            </div>

            <!-- Documents -->
            <div
              class="group bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm hover:shadow-lg transition-all duration-300 border border-slate-100 dark:border-slate-700 hover:-translate-y-1 col-span-2 lg:col-span-1"
            >
              <div class="flex items-center justify-between mb-3">
                <div
                  class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/30 group-hover:scale-110 transition-transform"
                >
                  <span class="material-symbols-outlined text-white text-[24px]"
                    >folder_open</span
                  >
                </div>
                <span
                  class="text-xs font-medium text-cyan-600 dark:text-cyan-400 bg-cyan-50 dark:bg-cyan-900/30 px-2 py-1 rounded-full"
                  >T√†i li·ªáu</span
                >
              </div>
              <h3
                id="statDocuments"
                class="text-3xl font-bold text-slate-900 dark:text-white"
              >
                0
              </h3>
              <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                T√†i li·ªáu y t·∫ø
              </p>
            </div>
          </div>

          <!-- Quick Access Cards -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <a
              th:href="@{/patient/prescriptions}"
              class="group relative overflow-hidden bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-5 text-white shadow-lg hover:shadow-xl transition-all hover:-translate-y-1"
            >
              <div
                class="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full blur-xl"
              ></div>
              <span
                class="material-symbols-outlined text-[32px] mb-3 opacity-90"
                >prescriptions</span
              >
              <h4 class="font-bold text-lg">ƒê∆°n thu·ªëc</h4>
              <p class="text-sm text-blue-100 mt-1">Xem t·∫•t c·∫£ ƒë∆°n thu·ªëc</p>
              <span
                class="material-symbols-outlined absolute bottom-4 right-4 text-white/50 group-hover:text-white group-hover:translate-x-1 transition-all"
                >arrow_forward</span
              >
            </a>

            <a
              th:href="@{/patient/treatments}"
              class="group relative overflow-hidden bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-5 text-white shadow-lg hover:shadow-xl transition-all hover:-translate-y-1"
            >
              <div
                class="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full blur-xl"
              ></div>
              <span
                class="material-symbols-outlined text-[32px] mb-3 opacity-90"
                >medical_services</span
              >
              <h4 class="font-bold text-lg">ƒêi·ªÅu tr·ªã</h4>
              <p class="text-sm text-emerald-100 mt-1">
                K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã c·ªßa b·∫°n
              </p>
              <span
                class="material-symbols-outlined absolute bottom-4 right-4 text-white/50 group-hover:text-white group-hover:translate-x-1 transition-all"
                >arrow_forward</span
              >
            </a>

            <a
              th:href="@{/patient/appointments}"
              class="group relative overflow-hidden bg-gradient-to-br from-violet-500 to-purple-600 rounded-2xl p-5 text-white shadow-lg hover:shadow-xl transition-all hover:-translate-y-1"
            >
              <div
                class="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full blur-xl"
              ></div>
              <span
                class="material-symbols-outlined text-[32px] mb-3 opacity-90"
                >calendar_month</span
              >
              <h4 class="font-bold text-lg">L·ªãch h·∫πn</h4>
              <p class="text-sm text-violet-100 mt-1">Qu·∫£n l√Ω cu·ªôc h·∫πn</p>
              <span
                class="material-symbols-outlined absolute bottom-4 right-4 text-white/50 group-hover:text-white group-hover:translate-x-1 transition-all"
                >arrow_forward</span
              >
            </a>

            <a
              th:href="@{/patient/documents}"
              class="group relative overflow-hidden bg-gradient-to-br from-orange-500 to-amber-600 rounded-2xl p-5 text-white shadow-lg hover:shadow-xl transition-all hover:-translate-y-1"
            >
              <div
                class="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full blur-xl"
              ></div>
              <span
                class="material-symbols-outlined text-[32px] mb-3 opacity-90"
                >folder_open</span
              >
              <h4 class="font-bold text-lg">T√†i li·ªáu</h4>
              <p class="text-sm text-orange-100 mt-1">H·ªì s∆° y t·∫ø c·ªßa b·∫°n</p>
              <span
                class="material-symbols-outlined absolute bottom-4 right-4 text-white/50 group-hover:text-white group-hover:translate-x-1 transition-all"
                >arrow_forward</span
              >
            </a>
          </div>

          <!-- Recent Activity Section -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recent Prescriptions -->
            <div
              class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"
            >
              <div
                class="p-5 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between bg-gradient-to-r from-blue-50 to-transparent dark:from-blue-900/20"
              >
                <div class="flex items-center gap-3">
                  <div
                    class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30"
                  >
                    <span
                      class="material-symbols-outlined text-white text-[20px]"
                      >prescriptions</span
                    >
                  </div>
                  <h3 class="text-lg font-bold text-slate-900 dark:text-white">
                    ƒê∆°n thu·ªëc g·∫ßn ƒë√¢y
                  </h3>
                </div>
                <a
                  th:href="@{/patient/prescriptions}"
                  class="flex items-center gap-1 text-blue-600 dark:text-blue-400 text-sm font-medium hover:underline"
                >
                  Xem t·∫•t c·∫£
                  <span class="material-symbols-outlined text-[16px]"
                    >arrow_forward</span
                  >
                </a>
              </div>
              <div
                id="prescriptionsList"
                class="divide-y divide-slate-100 dark:divide-slate-700"
              >
                <!-- Loading -->
                <div class="p-8 text-center">
                  <div
                    class="w-8 h-8 border-3 border-slate-200 dark:border-slate-600 border-t-blue-500 rounded-full animate-spin mx-auto mb-3"
                  ></div>
                  <p class="text-sm text-slate-500 dark:text-slate-400">
                    ƒêang t·∫£i...
                  </p>
                </div>
              </div>
            </div>

            <!-- Recent Tickets -->
            <div
              class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"
            >
              <div
                class="p-5 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between bg-gradient-to-r from-purple-50 to-transparent dark:from-purple-900/20"
              >
                <div class="flex items-center gap-3">
                  <div
                    class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/30"
                  >
                    <span
                      class="material-symbols-outlined text-white text-[20px]"
                      >confirmation_number</span
                    >
                  </div>
                  <h3 class="text-lg font-bold text-slate-900 dark:text-white">
                    Y√™u c·∫ßu h·ªó tr·ª£ g·∫ßn ƒë√¢y
                  </h3>
                </div>
                <a
                  th:href="@{/patient/tickets}"
                  class="flex items-center gap-1 text-purple-600 dark:text-purple-400 text-sm font-medium hover:underline"
                >
                  Xem t·∫•t c·∫£
                  <span class="material-symbols-outlined text-[16px]"
                    >arrow_forward</span
                  >
                </a>
              </div>
              <div
                id="ticketsList"
                class="divide-y divide-slate-100 dark:divide-slate-700"
              >
                <!-- Loading -->
                <div class="p-8 text-center">
                  <div
                    class="w-8 h-8 border-3 border-slate-200 dark:border-slate-600 border-t-purple-500 rounded-full animate-spin mx-auto mb-3"
                  ></div>
                  <p class="text-sm text-slate-500 dark:text-slate-400">
                    ƒêang t·∫£i...
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Treatment Plans -->
          <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"
          >
            <div
              class="p-5 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between bg-gradient-to-r from-emerald-50 to-transparent dark:from-emerald-900/20"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/30"
                >
                  <span class="material-symbols-outlined text-white text-[20px]"
                    >medical_services</span
                  >
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white">
                  K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã hi·ªán t·∫°i
                </h3>
              </div>
              <a
                th:href="@{/patient/treatments}"
                class="flex items-center gap-1 text-emerald-600 dark:text-emerald-400 text-sm font-medium hover:underline"
              >
                Xem t·∫•t c·∫£
                <span class="material-symbols-outlined text-[16px]"
                  >arrow_forward</span
                >
              </a>
            </div>
            <div id="treatmentsList" class="p-5">
              <!-- Loading -->
              <div class="text-center py-8">
                <div
                  class="w-8 h-8 border-3 border-slate-200 dark:border-slate-600 border-t-emerald-500 rounded-full animate-spin mx-auto mb-3"
                ></div>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  ƒêang t·∫£i...
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Prescription Detail Modal -->
    <div
      id="prescriptionModal"
      class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl max-w-3xl w-full shadow-2xl max-h-[90vh] overflow-y-auto border border-slate-200 dark:border-slate-700"
      >
        <div
          class="p-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-blue-50 to-transparent dark:from-blue-900/20"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div
                class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30"
              >
                <span class="material-symbols-outlined text-white"
                  >prescriptions</span
                >
              </div>
              <h3 class="text-xl font-bold text-slate-900 dark:text-white">
                Chi ti·∫øt ƒë∆°n thu·ªëc
              </h3>
            </div>
            <button
              onclick="closePrescriptionModal()"
              class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center transition-colors"
            >
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>
        <div id="prescriptionModalContent" class="p-6">
          <!-- Content will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
      <div
        class="flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border"
        id="toastContent"
      >
        <span
          id="toastIcon"
          class="material-symbols-outlined text-[20px]"
        ></span>
        <span id="toastMessage" class="text-sm font-medium"></span>
      </div>
    </div>

    <!-- Scripts -->
    <th:block th:replace="~{fragments/layout :: scripts}"></th:block>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        loadDashboardData();
      });

      async function loadDashboardData() {
        try {
          // Load stats
          const [prescriptionsRes, treatmentsRes, ticketsRes, documentsRes] =
            await Promise.all([
              fetch("/api/patient/prescriptions?size=5").catch(() => ({
                ok: false,
              })),
              fetch("/api/patient/treatment-plans?size=5").catch(() => ({
                ok: false,
              })),
              fetch("/api/patient/tickets?size=5").catch(() => ({ ok: false })),
              fetch("/api/patient/documents/stats").catch(() => ({
                ok: false,
              })),
            ]);

          // Update prescriptions
          if (prescriptionsRes.ok) {
            const prescriptions = await prescriptionsRes.json();
            const prescriptionList =
              prescriptions.data ||
              prescriptions.content ||
              (Array.isArray(prescriptions) ? prescriptions : []);
            updatePrescriptionsList(prescriptionList);
            document.getElementById("statPrescriptions").textContent =
              prescriptions.totalElements || prescriptionList.length || 0;
          } else {
            document.getElementById("prescriptionsList").innerHTML =
              renderEmptyState("prescriptions", "Ch∆∞a c√≥ ƒë∆°n thu·ªëc n√†o");
          }

          // Update treatments
          if (treatmentsRes.ok) {
            const treatments = await treatmentsRes.json();
            updateTreatmentsList(treatments.data || treatments);
            document.getElementById("statTreatments").textContent =
              treatments.totalElements || treatments.length || 0;
          } else {
            document.getElementById("treatmentsList").innerHTML =
              renderEmptyState("medical_services", "Ch∆∞a c√≥ k·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã");
          }

          // Update tickets
          if (ticketsRes.ok) {
            const tickets = await ticketsRes.json();
            updateTicketsList(tickets.data || tickets);
            const total = tickets.totalElements || tickets.length || 0;
            const open = (tickets.data || tickets).filter(
              (t) => t.status === "OPEN" || t.status === "IN_PROGRESS",
            ).length;
            document.getElementById("statTickets").textContent = total;
            document.getElementById("statOpenTickets").textContent = open;
          } else {
            document.getElementById("ticketsList").innerHTML = renderEmptyState(
              "confirmation_number",
              "Ch∆∞a c√≥ y√™u c·∫ßu h·ªó tr·ª£",
            );
          }

          // Update documents
          if (documentsRes.ok) {
            const docs = await documentsRes.json();
            document.getElementById("statDocuments").textContent =
              docs.total || 0;
          }
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      function updatePrescriptionsList(prescriptions) {
        const list = document.getElementById("prescriptionsList");
        if (
          !prescriptions ||
          !Array.isArray(prescriptions) ||
          prescriptions.length === 0
        ) {
          list.innerHTML = renderEmptyState(
            "prescriptions",
            "Ch∆∞a c√≥ ƒë∆°n thu·ªëc n√†o",
            "ƒê∆°n thu·ªëc c·ªßa b·∫°n s·∫Ω hi·ªán ·ªü ƒë√¢y",
          );
          return;
        }

        list.innerHTML = prescriptions
          .slice(0, 5)
          .map(
            (p) => `
          <div class="p-4 hover:bg-blue-50/50 dark:hover:bg-slate-700/50 transition-all cursor-pointer group" onclick="viewPrescription(${p.id})">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-blue-50 dark:from-blue-900/50 dark:to-blue-800/30 rounded-xl flex items-center justify-center group-hover:scale-105 transition-transform">
                  <span class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-[22px]">prescriptions</span>
                </div>
                <div>
                  <p class="font-semibold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">${p.diagnosis || "ƒê∆°n thu·ªëc #" + p.id}</p>
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-sm text-slate-500 dark:text-slate-400">BS. ${p.doctor?.userInfo?.fullName || "N/A"}</span>
                    <span class="w-1 h-1 bg-slate-300 dark:bg-slate-600 rounded-full"></span>
                    <span class="text-sm text-slate-400">${formatDate(p.createdAt)}</span>
                  </div>
                </div>
              </div>
              <span class="material-symbols-outlined text-slate-300 dark:text-slate-600 group-hover:text-blue-500 group-hover:translate-x-1 transition-all">chevron_right</span>
            </div>
          </div>
        `,
          )
          .join("");
      }

      function updateTreatmentsList(treatments) {
        const list = document.getElementById("treatmentsList");
        if (!treatments || treatments.length === 0) {
          list.innerHTML = renderEmptyState(
            "medical_services",
            "Ch∆∞a c√≥ k·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã",
            "K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã c·ªßa b·∫°n s·∫Ω hi·ªán ·ªü ƒë√¢y",
          );
          return;
        }

        list.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${treatments
            .slice(0, 4)
            .map(
              (t) => `
            <div class="group p-5 bg-gradient-to-br from-slate-50 to-white dark:from-slate-700/50 dark:to-slate-800 border border-slate-100 dark:border-slate-700 rounded-2xl hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/20">
                    <span class="material-symbols-outlined text-white text-[20px]">medical_services</span>
                  </div>
                  <h4 class="font-bold text-slate-900 dark:text-white">${t.title || "K·∫ø ho·∫°ch ƒëi·ªÅu tr·ªã"}</h4>
                </div>
                <span class="px-3 py-1 text-xs font-bold rounded-full ${getStatusColor(t.status)}">${getStatusLabel(t.status)}</span>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-4 line-clamp-2">${t.description || "Kh√¥ng c√≥ m√¥ t·∫£"}</p>
              <div class="flex items-center justify-between text-sm pt-3 border-t border-slate-100 dark:border-slate-700">
                <div class="flex items-center gap-2">
                  <div class="w-6 h-6 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center">
                    <span class="material-symbols-outlined text-emerald-600 dark:text-emerald-400 text-[14px]">person</span>
                  </div>
                  <span class="text-slate-600 dark:text-slate-400">BS. ${t.doctor?.userInfo?.fullName || "N/A"}</span>
                </div>
                <span class="text-slate-400 flex items-center gap-1">
                  <span class="material-symbols-outlined text-[14px]">calendar_today</span>
                  ${formatDate(t.startDate)}
                </span>
              </div>
            </div>
          `,
            )
            .join("")}
        </div>`;
      }

      function updateTicketsList(tickets) {
        const list = document.getElementById("ticketsList");
        if (!tickets || tickets.length === 0) {
          list.innerHTML = renderEmptyState(
            "confirmation_number",
            "Ch∆∞a c√≥ y√™u c·∫ßu h·ªó tr·ª£",
            "T·∫°o y√™u c·∫ßu h·ªó tr·ª£ khi b·∫°n c·∫ßn gi√∫p ƒë·ª°",
          );
          return;
        }

        list.innerHTML = tickets
          .slice(0, 5)
          .map(
            (t) => `
          <div class="p-4 hover:bg-purple-50/50 dark:hover:bg-slate-700/50 transition-all group">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 ${getTicketStatusGradient(t.status)} rounded-xl flex items-center justify-center shadow-lg group-hover:scale-105 transition-transform">
                  <span class="material-symbols-outlined text-white text-[22px]">confirmation_number</span>
                </div>
                <div>
                  <p class="font-semibold text-slate-900 dark:text-white">${t.subject || "Ticket #" + t.id}</p>
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-sm text-slate-400">${formatDate(t.createdAt)}</span>
                  </div>
                </div>
              </div>
              <span class="px-3 py-1.5 text-xs font-bold rounded-full ${getStatusColor(t.status)}">${getStatusLabel(t.status)}</span>
            </div>
          </div>
        `,
          )
          .join("");
      }

      function renderEmptyState(icon, message, subtext = "") {
        return `
          <div class="p-10 text-center">
            <div class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-2xl flex items-center justify-center mx-auto mb-4">
              <span class="material-symbols-outlined text-[32px] text-slate-400 dark:text-slate-500">${icon}</span>
            </div>
            <p class="text-slate-600 dark:text-slate-400 font-medium">${message}</p>
            ${subtext ? `<p class="text-sm text-slate-400 dark:text-slate-500 mt-1">${subtext}</p>` : ""}
          </div>
        `;
      }

      function getTicketStatusGradient(status) {
        const gradients = {
          OPEN: "bg-gradient-to-br from-amber-500 to-orange-600 shadow-amber-500/30",
          IN_PROGRESS:
            "bg-gradient-to-br from-blue-500 to-indigo-600 shadow-blue-500/30",
          RESOLVED:
            "bg-gradient-to-br from-emerald-500 to-teal-600 shadow-emerald-500/30",
          CLOSED:
            "bg-gradient-to-br from-slate-400 to-slate-500 shadow-slate-400/30",
        };
        return gradients[status] || gradients["OPEN"];
      }

      function formatDate(dateStr) {
        if (!dateStr) return "-";
        return new Date(dateStr).toLocaleDateString("vi-VN");
      }

      function getStatusColor(status) {
        const colors = {
          ACTIVE:
            "bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400",
          COMPLETED:
            "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400",
          CANCELLED:
            "bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400",
          OPEN: "bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400",
          IN_PROGRESS:
            "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400",
          RESOLVED:
            "bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400",
          CLOSED:
            "bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400",
        };
        return colors[status] || colors["OPEN"];
      }

      function getStatusLabel(status) {
        const labels = {
          ACTIVE: "ƒêang th·ª±c hi·ªán",
          COMPLETED: "Ho√†n th√†nh",
          CANCELLED: "ƒê√£ h·ªßy",
          OPEN: "ƒêang ch·ªù",
          IN_PROGRESS: "ƒêang x·ª≠ l√Ω",
          RESOLVED: "ƒê√£ gi·∫£i quy·∫øt",
          CLOSED: "ƒê√£ ƒë√≥ng",
        };
        return labels[status] || status;
      }

      function getTicketStatusBg(status) {
        const bgs = {
          OPEN: "bg-amber-50 dark:bg-amber-900/30",
          IN_PROGRESS: "bg-blue-50 dark:bg-blue-900/30",
          RESOLVED: "bg-emerald-50 dark:bg-emerald-900/30",
          CLOSED: "bg-slate-100 dark:bg-slate-800",
        };
        return bgs[status] || bgs["OPEN"];
      }

      function getTicketStatusTextColor(status) {
        const colors = {
          OPEN: "text-amber-600 dark:text-amber-400",
          IN_PROGRESS: "text-blue-600 dark:text-blue-400",
          RESOLVED: "text-emerald-600 dark:text-emerald-400",
          CLOSED: "text-slate-500 dark:text-slate-400",
        };
        return colors[status] || colors["OPEN"];
      }

      async function viewPrescription(id) {
        // Open modal and load prescription details
        document.getElementById("prescriptionModal").classList.remove("hidden");
        document.getElementById("prescriptionModal").classList.add("flex");

        const content = document.getElementById("prescriptionModalContent");
        content.innerHTML =
          '<div class="text-center py-8"><div class="w-6 h-6 border-2 border-slate-200 border-t-primary rounded-full animate-spin mx-auto mb-2"></div><p class="text-sm text-slate-500">ƒêang t·∫£i...</p></div>';

        try {
          const response = await fetch(`/api/patient/prescriptions/${id}`);
          if (response.ok) {
            const prescription = await response.json();
            content.innerHTML = renderPrescriptionDetail(prescription);
          } else {
            content.innerHTML =
              '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n thu·ªëc</p>';
          }
        } catch (error) {
          content.innerHTML =
            '<p class="text-center text-red-500">L·ªói k·∫øt n·ªëi</p>';
        }
      }

      function renderPrescriptionDetail(p) {
        return `
          <div class="space-y-6">
            <div class="grid grid-cols-2 gap-6">
              <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-1">B√°c sƒ© k√™ ƒë∆°n</p>
                <p class="font-semibold text-slate-900 dark:text-white">${p.doctor?.userInfo?.fullName || "N/A"}</p>
              </div>
              <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-1">Ng√†y k√™ ƒë∆°n</p>
                <p class="font-semibold text-slate-900 dark:text-white">${formatDate(p.createdAt)}</p>
              </div>
            </div>
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800">
              <p class="text-sm text-blue-600 dark:text-blue-400 mb-1 font-medium">Ch·∫©n ƒëo√°n</p>
              <p class="font-semibold text-slate-900 dark:text-white">${p.diagnosis || "Kh√¥ng c√≥"}</p>
            </div>
            <div>
              <p class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px]">medication</span>
                Danh s√°ch thu·ªëc
              </p>
              <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden">
                <table class="w-full text-sm">
                  <thead class="bg-slate-100 dark:bg-slate-700">
                    <tr>
                      <th class="px-4 py-3 text-left text-slate-700 dark:text-slate-300 font-semibold">T√™n thu·ªëc</th>
                      <th class="px-4 py-3 text-left text-slate-700 dark:text-slate-300 font-semibold">Li·ªÅu l∆∞·ª£ng</th>
                      <th class="px-4 py-3 text-left text-slate-700 dark:text-slate-300 font-semibold">C√°ch d√πng</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    ${(p.items || [])
                      .map(
                        (item) => `
                      <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <td class="px-4 py-4 font-medium text-slate-900 dark:text-white">${item.medicationName || "N/A"}</td>
                        <td class="px-4 py-4 text-slate-600 dark:text-slate-400">${item.dosage || "N/A"}</td>
                        <td class="px-4 py-4 text-slate-600 dark:text-slate-400">${item.instructions || "N/A"}</td>
                      </tr>
                    `,
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
            </div>
            ${
              p.notes
                ? `
              <div class="p-4 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-100 dark:border-amber-800">
                <p class="text-sm text-amber-600 dark:text-amber-400 mb-1 font-medium flex items-center gap-2">
                  <span class="material-symbols-outlined text-[18px]">sticky_note_2</span>
                  Ghi ch√∫
                </p>
                <p class="text-slate-700 dark:text-slate-300">${p.notes}</p>
              </div>
            `
                : ""
            }
          </div>
        `;
      }

      function closePrescriptionModal() {
        document.getElementById("prescriptionModal").classList.add("hidden");
        document.getElementById("prescriptionModal").classList.remove("flex");
      }

      // Close modal on backdrop click
      document
        .getElementById("prescriptionModal")
        ?.addEventListener("click", function (e) {
          if (e.target === this) {
            closePrescriptionModal();
          }
        });

      // ===== INCOMING CALL NOTIFICATION =====
      const STRINGEE_SERVER_ADDRS = [
        "wss://v1.stringee.com:6899/",
        "wss://v2.stringee.com:6899/",
      ];
      var stringeeClient;
      var currentIncomingCall = null;

      // Initialize Stringee for incoming call detection
      async function initCallNotification() {
        try {
          const userRes = await fetch("/api/web-call/current-user");
          if (!userRes.ok) return;
          const userData = await userRes.json();
          if (!userData.authenticated) return;

          const tokenRes = await fetch("/api/web-call/token");
          if (!tokenRes.ok) return;
          const tokenData = await tokenRes.json();

          stringeeClient = new StringeeClient(STRINGEE_SERVER_ADDRS);

          stringeeClient.on("connect", () => {
            console.log("Stringee connected for call notification");
          });

          stringeeClient.on("incomingcall", (incomingCall) => {
            console.log("Incoming call detected:", incomingCall.fromNumber);
            currentIncomingCall = incomingCall;
            showIncomingCallNotification(incomingCall);
          });

          stringeeClient.connect(tokenData.token);
        } catch (err) {
          console.error("Error initializing call notification:", err);
        }
      }

      function showIncomingCallNotification(call) {
        if (document.getElementById("incomingCallNotification")) return;

        const notification = document.createElement("div");
        notification.id = "incomingCallNotification";
        notification.className = "fixed top-4 right-4 z-50";
        notification.innerHTML = `
          <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border-2 border-emerald-500 p-4 min-w-[320px] animate-pulse">
            <div class="flex items-center gap-4 mb-4">
              <div class="relative">
                <div class="absolute inset-0 rounded-full bg-emerald-500/30 animate-ping"></div>
                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center text-white shadow-lg">
                  <span class="material-symbols-outlined text-2xl animate-bounce">call</span>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm text-slate-500 dark:text-slate-400">Cu·ªôc g·ªçi ƒë·∫øn</p>
                <p class="text-lg font-bold text-slate-900 dark:text-white">Nh√¢n vi√™n ABClinic</p>
                <p class="text-sm text-slate-400">${call.fromNumber}</p>
              </div>
            </div>
            <div class="flex gap-3">
              <button onclick="rejectCallNotification()" class="flex-1 px-4 py-2.5 bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-[18px]">call_end</span>
                T·ª´ ch·ªëi
              </button>
              <button onclick="goToCallPage()" class="flex-1 px-4 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-[18px]">call</span>
                Tr·∫£ l·ªùi
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(notification);

        // Play notification sound
        try {
          const audio = new Audio("/audio/ringtone.mp3");
          audio.loop = true;
          audio.id = "ringtoneAudio";
          audio.play().catch(() => {});
          document.body.appendChild(audio);
        } catch (e) {}
      }

      function rejectCallNotification() {
        if (currentIncomingCall) {
          currentIncomingCall.reject(() => console.log("Call rejected"));
          currentIncomingCall = null;
        }
        removeCallNotification();
      }

      function goToCallPage() {
        removeCallNotification();
        // Disconnect current client so call page can connect
        if (stringeeClient) {
          stringeeClient.disconnect();
          stringeeClient = null;
        }
        // Small delay to ensure disconnect completes before redirect
        setTimeout(() => {
          window.location.href = "/patient/call";
        }, 100);
      }

      function removeCallNotification() {
        const notification = document.getElementById(
          "incomingCallNotification",
        );
        if (notification) notification.remove();
        const audio = document.getElementById("ringtoneAudio");
        if (audio) {
          audio.pause();
          audio.remove();
        }
      }

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        if (stringeeClient) {
          stringeeClient.disconnect();
        }
      });

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Load Stringee SDK dynamically if not present
        if (typeof StringeeClient === "undefined") {
          const script = document.createElement("script");
          script.src = "/js/vendor/stringee/sdk.bundle.min.js";
          script.onload = () => initCallNotification();
          document.body.appendChild(script);
        } else {
          initCallNotification();
        }
      });
    </script>
  </body>
</html>
