<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/layout :: head(title='Tài Liệu Y Tế')}"> </head>
  <body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 font-sans h-screen flex overflow-hidden"
  >
    <!-- Mobile Sidebar Backdrop -->
    <div th:replace="~{fragments/layout :: sidebar-backdrop}"></div>

    <!-- Patient Sidebar -->
    <aside th:replace="~{fragments/layout :: patient-sidebar}"></aside>

    <!-- Main Content -->
    <main
      class="flex-1 flex flex-col min-w-0 bg-gradient-to-br from-slate-50 via-white to-blue-50/30 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800"
    >
      <!-- Header -->
      <header
        th:replace="~{fragments/header/unified-header :: unified-header}"
      ></header>

      <!-- Content Area -->
      <div class="flex-1 overflow-y-auto p-4 lg:p-6">
        <div class="max-w-7xl mx-auto">
          <!-- Upload Section -->
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4">
              Upload Tài Liệu
            </h2>
            <form id="uploadForm" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label
                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                  >
                    Chọn file
                  </label>
                  <input
                    type="file"
                    id="documentFile"
                    name="file"
                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                    class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-orange-500"
                    required
                  />
                </div>
                <div>
                  <label
                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                  >
                    Loại tài liệu
                  </label>
                  <select
                    id="documentType"
                    name="documentType"
                    class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-orange-500 dark:bg-slate-700"
                  >
                    <option value="MEDICAL_HISTORY">Ho so y te</option>
                    <option value="TEST_RESULT">Ket qua xet nghiem</option>
                    <option value="PRESCRIPTION">Don thuoc</option>
                    <option value="OTHER">Khac</option>
                  </select>
                </div>
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >
                  Mô tả (tùy chọn)
                </label>
                <textarea
                  id="description"
                  name="description"
                  rows="2"
                  class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-orange-500 dark:bg-slate-700"
                ></textarea>
              </div>
              <div class="flex justify-end">
                <button
                  type="submit"
                  class="px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium transition-colors"
                >
                  <span class="material-symbols-outlined align-middle mr-1"
                    >upload</span
                  >
                  Upload
                </button>
              </div>
            </form>
          </div>

          <!-- Documents List -->
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-6">
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">
              Tài Liệu Y Tế
            </h2>
            <div id="documentsList">
              <div class="text-center py-8">
                <div
                  class="w-8 h-8 border-3 border-slate-200 dark:border-slate-600 border-t-orange-500 rounded-full animate-spin mx-auto mb-3"
                ></div>
                <p class="text-slate-500 dark:text-slate-400">Đang tải...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Map loai tai lieu sang tieng Viet
      const DOCUMENT_TYPE_LABELS = {
        MEDICAL_HISTORY: "Ho so y te",
        TEST_RESULT: "Ket qua xet nghiem",
        PRESCRIPTION: "Don thuoc",
        OTHER: "Khac",
      };

      document.addEventListener("DOMContentLoaded", function () {
        loadDocuments();
        setupUploadForm();
      });

      function setupUploadForm() {
        const form = document.getElementById("uploadForm");
        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData();
          const fileInput = document.getElementById("documentFile");
          const typeInput = document.getElementById("documentType");
          const descInput = document.getElementById("description");
          const submitBtn = form.querySelector('button[type="submit"]');

          if (!fileInput.files[0]) {
            showMessage("Vui long chon file", "error");
            return;
          }

          // Kiem tra kich thuoc file (max 10MB)
          if (fileInput.files[0].size > 10 * 1024 * 1024) {
            showMessage("File khong duoc vuot qua 10MB", "error");
            return;
          }

          formData.append("file", fileInput.files[0]);
          formData.append("documentType", typeInput.value);
          if (descInput.value) {
            formData.append("description", descInput.value);
          }

          // Disable button trong khi upload
          submitBtn.disabled = true;
          submitBtn.innerHTML =
            '<span class="material-symbols-outlined align-middle mr-1 animate-spin">refresh</span> Dang upload...';

          try {
            const response = await fetch("/api/patient/documents/upload", {
              method: "POST",
              body: formData,
            });

            const data = await response.json();

            if (data.success) {
              showMessage("Upload thanh cong!", "success");
              form.reset();
              loadDocuments();
            } else {
              showMessage(data.message || "Upload that bai", "error");
            }
          } catch (error) {
            console.error("Error uploading document:", error);
            showMessage("Loi khi upload tai lieu", "error");
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML =
              '<span class="material-symbols-outlined align-middle mr-1">upload</span> Upload';
          }
        });
      }

      function showMessage(message, type) {
        // Tao toast notification
        const toast = document.createElement("div");
        toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white shadow-lg z-50 transition-opacity duration-300 ${
          type === "success"
            ? "bg-green-500"
            : type === "error"
              ? "bg-red-500"
              : "bg-blue-500"
        }`;
        toast.innerHTML = `<span class="material-symbols-outlined align-middle mr-2">${type === "success" ? "check_circle" : "error"}</span>${message}`;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      async function loadDocuments() {
        try {
          const response = await fetch("/api/patient/documents");
          const data = await response.json();

          if (data.success) {
            renderDocuments(data.documents || []);
          } else {
            showError(data.message);
          }
        } catch (error) {
          console.error("Error loading documents:", error);
          showError("Khong the tai danh sach tai lieu");
        }
      }

      function renderDocuments(documents) {
        const container = document.getElementById("documentsList");

        if (documents.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12">
              <span class="material-symbols-outlined text-slate-300 text-6xl mb-4">folder_open</span>
              <p class="text-slate-500">Chua co tai lieu nao</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="grid gap-4">
            ${documents
              .map(
                (doc) => `
              <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-4 hover:shadow-md transition-shadow" id="doc-${doc.id}">
                <div class="flex justify-between items-start">
                  <div class="flex items-start gap-3 flex-1">
                    <span class="material-symbols-outlined text-orange-500 text-4xl">${getFileIcon(doc.fileName)}</span>
                    <div class="flex-1">
                      <h3 class="font-semibold text-lg mb-1 dark:text-white">${escapeHtml(doc.fileName) || "Document #" + doc.id}</h3>
                      <div class="space-y-1 text-sm text-slate-500 dark:text-slate-400">
                        <p><span class="font-medium">Loai:</span> <span class="px-2 py-0.5 rounded-full text-xs ${getDocTypeBadge(doc.documentType)}">${doc.documentTypeLabel || DOCUMENT_TYPE_LABELS[doc.documentType] || doc.documentType}</span></p>
                        <p><span class="font-medium">Kich thuoc:</span> ${doc.fileSizeFormatted || formatFileSize(doc.fileSize)}</p>
                        <p><span class="font-medium">Ngay tai len:</span> ${formatDate(doc.uploadDate)}</p>
                        ${doc.description ? `<p><span class="font-medium">Mo ta:</span> ${escapeHtml(doc.description)}</p>` : ""}
                      </div>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    ${
                      doc.viewUrl
                        ? `
                      <a href="${doc.viewUrl}" target="_blank" 
                         class="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-slate-700 rounded-lg transition-colors"
                         title="Xem/Tai xuong">
                        <span class="material-symbols-outlined">download</span>
                      </a>
                    `
                        : ""
                    }
                    <button onclick="deleteDocument(${doc.id}, '${escapeHtml(doc.fileName)}')" 
                       class="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors"
                       title="Xoa tai lieu">
                      <span class="material-symbols-outlined">delete</span>
                    </button>
                  </div>
                </div>
              </div>
            `,
              )
              .join("")}
          </div>
        `;
      }

      // Xoa tai lieu
      async function deleteDocument(docId, fileName) {
        if (!confirm(`Ban co chac muon xoa tai lieu "${fileName}"?`)) {
          return;
        }

        try {
          const response = await fetch(`/api/patient/documents/${docId}`, {
            method: "DELETE",
          });

          const data = await response.json();

          if (data.success) {
            showMessage("Xoa tai lieu thanh cong!", "success");
            // Xoa element khoi DOM
            const docElement = document.getElementById(`doc-${docId}`);
            if (docElement) {
              docElement.remove();
            }
            // Kiem tra neu khong con tai lieu nao
            const container = document.getElementById("documentsList");
            if (container.querySelectorAll('[id^="doc-"]').length === 0) {
              loadDocuments(); // Reload de hien thi thong bao "Chua co tai lieu"
            }
          } else {
            showMessage(data.message || "Xoa that bai", "error");
          }
        } catch (error) {
          console.error("Error deleting document:", error);
          showMessage("Loi khi xoa tai lieu", "error");
        }
      }

      // Lay icon cho loai file
      function getFileIcon(filename) {
        if (!filename) return "description";
        const ext = filename.split(".").pop().toLowerCase();
        const icons = {
          pdf: "picture_as_pdf",
          doc: "description",
          docx: "description",
          xls: "table_chart",
          xlsx: "table_chart",
          jpg: "image",
          jpeg: "image",
          png: "image",
          gif: "image",
        };
        return icons[ext] || "description";
      }

      // Lay badge color cho loai tai lieu
      function getDocTypeBadge(type) {
        const badges = {
          MEDICAL_HISTORY:
            "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",
          PRESCRIPTION:
            "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",
          TEST_RESULT:
            "bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200",
          OTHER:
            "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200",
        };
        return badges[type] || "bg-gray-100 text-gray-800";
      }

      function formatFileSize(bytes) {
        if (!bytes) return "N/A";
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
        return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      }

      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleDateString("vi-VN");
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showError(message) {
        document.getElementById("documentsList").innerHTML = `
          <div class="text-center py-12">
            <span class="material-symbols-outlined text-red-500 text-6xl mb-4">error</span>
            <p class="text-red-500">${message}</p>
          </div>
        `;
      }
    </script>

    <!-- Common Scripts -->
    <script th:src="@{/js/core/sidebar-controller.js}"></script>
    <script th:src="@{/js/core/notification-dropdown.js}"></script>
    <script th:src="@{/js/core/app.js}"></script>
  </body>
</html>
