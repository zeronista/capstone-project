<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" class="scroll-smooth">
  <head
    th:replace="~{fragments/layout :: head(title='Thông Tin Cá Nhân')}"
  ></head>
  <body
    class="bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-100 min-h-screen"
  >
    <!-- Sidebar Backdrop -->
    <div th:replace="~{fragments/layout :: sidebar-backdrop}"></div>

    <!-- Patient Sidebar -->
    <div th:replace="~{fragments/layout :: patient-sidebar}"></div>

    <!-- Main Content Area -->
    <div class="lg:ml-64 min-h-screen transition-all duration-300">
      <!-- Header -->
      <div
        th:replace="~{fragments/layout :: header(title='Thông Tin Cá Nhân')}"
      ></div>

      <!-- Main Content -->
      <main class="p-4 md:p-6 lg:p-8">
        <!-- Page Title -->
        <div class="mb-6">
          <h1
            class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white"
          >
            Thông Tin Cá Nhân
          </h1>
          <p class="mt-1 text-gray-600 dark:text-gray-400">
            Quản lý thông tin hồ sơ của bạn
          </p>
        </div>

        <!-- Profile Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Avatar Section -->
          <div class="lg:col-span-1">
            <div
              class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
            >
              <div class="text-center">
                <!-- Avatar -->
                <div class="relative inline-block group">
                  <img
                    id="avatarPreview"
                    th:src="${avatarUrl != null ? avatarUrl : '/images/default-avatar.png'}"
                    src="/images/default-avatar.png"
                    alt="Avatar"
                    class="w-32 h-32 rounded-full object-cover border-4 border-primary/20 shadow-lg"
                  />
                  <label
                    for="avatarInput"
                    class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
                  >
                    <span class="material-symbols-outlined text-white text-3xl"
                      >photo_camera</span
                    >
                  </label>
                  <input
                    type="file"
                    id="avatarInput"
                    accept="image/*"
                    class="hidden"
                  />
                </div>

                <!-- Name & Role -->
                <h2
                  class="mt-4 text-xl font-semibold text-gray-900 dark:text-white"
                  th:text="${user != null ? user.fullName : 'Bệnh nhân'}"
                >
                  Nguyễn Văn A
                </h2>
                <p class="text-gray-600 dark:text-gray-400">Bệnh nhân</p>

                <!-- Stats -->
                <div class="mt-6 grid grid-cols-2 gap-4">
                  <div class="bg-primary/10 dark:bg-primary/20 rounded-lg p-3">
                    <span
                      class="material-symbols-outlined text-primary text-2xl"
                      >calendar_month</span
                    >
                    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                      Lịch hẹn
                    </p>
                    <p
                      class="text-lg font-bold text-gray-900 dark:text-white"
                      th:text="${appointmentCount != null ? appointmentCount : 0}"
                    >
                      0
                    </p>
                  </div>
                  <div
                    class="bg-green-500/10 dark:bg-green-500/20 rounded-lg p-3"
                  >
                    <span
                      class="material-symbols-outlined text-green-500 text-2xl"
                      >medical_information</span
                    >
                    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                      Đơn thuốc
                    </p>
                    <p
                      class="text-lg font-bold text-gray-900 dark:text-white"
                      th:text="${prescriptionCount != null ? prescriptionCount : 0}"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Form -->
          <div class="lg:col-span-2">
            <div
              class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
            >
              <!-- Tab Navigation -->
              <div
                class="flex border-b border-gray-200 dark:border-gray-700 mb-6"
              >
                <button
                  id="tab-personal"
                  onclick="switchTab('personal')"
                  class="tab-btn active px-4 py-2 text-sm font-medium border-b-2 border-primary text-primary"
                >
                  <span
                    class="material-symbols-outlined align-middle mr-1 text-lg"
                    >person</span
                  >
                  Thông tin cá nhân
                </button>
                <button
                  id="tab-security"
                  onclick="switchTab('security')"
                  class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-primary"
                >
                  <span
                    class="material-symbols-outlined align-middle mr-1 text-lg"
                    >security</span
                  >
                  Bảo mật
                </button>
                <button
                  id="tab-health"
                  onclick="switchTab('health')"
                  class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-primary"
                >
                  <span
                    class="material-symbols-outlined align-middle mr-1 text-lg"
                    >favorite</span
                  >
                  Sức khỏe
                </button>
              </div>

              <!-- Personal Information Form -->
              <form
                id="panel-personal"
                th:action="@{/profile/update}"
                method="post"
                class="space-y-6"
              >
                <input
                  type="hidden"
                  th:name="${_csrf.parameterName}"
                  th:value="${_csrf.token}"
                />

                <!-- Row 1 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Full Name -->
                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >
                      <span
                        class="material-symbols-outlined align-middle mr-1 text-lg"
                        >badge</span
                      >
                      Họ và tên
                    </label>
                    <input
                      type="text"
                      name="fullName"
                      th:value="${user != null ? user.fullName : ''}"
                      class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                      required
                    />
                  </div>
                  <!-- Email -->
                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >
                      <span
                        class="material-symbols-outlined align-middle mr-1 text-lg"
                        >email</span
                      >
                      Email
                    </label>
                    <input
                      type="email"
                      name="email"
                      th:value="${user != null ? user.email : ''}"
                      class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed"
                      readonly
                    />
                  </div>
                </div>

                <!-- Row 2 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Phone -->
                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >
                      <span
                        class="material-symbols-outlined align-middle mr-1 text-lg"
                        >phone</span
                      >
                      Số điện thoại
                    </label>
                    <input
                      type="tel"
                      name="phone"
                      th:value="${user != null ? user.phoneNumber : ''}"
                      pattern="[0-9]{10,11}"
                      class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                    />
                  </div>
                  <!-- Date of Birth -->
                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >
                      <span
                        class="material-symbols-outlined align-middle mr-1 text-lg"
                        >cake</span
                      >
                      Ngày sinh
                    </label>
                    <input
                      type="date"
                      name="dateOfBirth"
                      th:value="${user != null ? user.dateOfBirth : ''}"
                      class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                    />
                  </div>
                </div>

                <!-- Row 3 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Gender -->
                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >
                      <span
                        class="material-symbols-outlined align-middle mr-1 text-lg"
                        >wc</span
                      >
                      Giới tính
                    </label>
                    <select
                      name="gender"
                      class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                    >
                      <option value="">-- Chọn --</option>
                      <option
                        value="MALE"
                        th:selected="${user != null and user.gender == 'MALE'}"
                      >
                        Nam
                      </option>
                      <option
                        value="FEMALE"
                        th:selected="${user != null and user.gender == 'FEMALE'}"
                      >
                        Nữ
                      </option>
                      <option
                        value="OTHER"
                        th:selected="${user != null and user.gender == 'OTHER'}"
                      >
                        Khác
                      </option>
                    </select>
                  </div>
                </div>

                <!-- Address -->
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                  >
                    <span
                      class="material-symbols-outlined align-middle mr-1 text-lg"
                      >location_on</span
                    >
                    Địa chỉ
                  </label>
                  <textarea
                    name="address"
                    rows="3"
                    th:text="${user != null ? user.address : ''}"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition resize-none"
                  ></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                  <button
                    type="submit"
                    class="inline-flex items-center gap-2 px-6 py-2.5 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg shadow-sm transition-colors"
                  >
                    <span class="material-symbols-outlined text-lg">save</span>
                    Lưu thay đổi
                  </button>
                </div>
              </form>

              <!-- Security Panel (Hidden by default) -->
              <div id="panel-security" class="hidden space-y-6">
                <form
                  th:action="@{/profile/change-password}"
                  method="post"
                  class="space-y-6"
                >
                  <input
                    type="hidden"
                    th:name="${_csrf.parameterName}"
                    th:value="${_csrf.token}"
                  />

                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >
                      <span
                        class="material-symbols-outlined align-middle mr-1 text-lg"
                        >lock</span
                      >
                      Mật khẩu hiện tại
                    </label>
                    <input
                      type="password"
                      name="currentPassword"
                      required
                      class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                    />
                  </div>

                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >
                      <span
                        class="material-symbols-outlined align-middle mr-1 text-lg"
                        >lock_reset</span
                      >
                      Mật khẩu mới
                    </label>
                    <input
                      type="password"
                      name="newPassword"
                      minlength="6"
                      required
                      class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                    />
                  </div>

                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >
                      <span
                        class="material-symbols-outlined align-middle mr-1 text-lg"
                        >check_circle</span
                      >
                      Xác nhận mật khẩu mới
                    </label>
                    <input
                      type="password"
                      name="confirmPassword"
                      minlength="6"
                      required
                      class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                    />
                  </div>

                  <div class="flex justify-end">
                    <button
                      type="submit"
                      class="inline-flex items-center gap-2 px-6 py-2.5 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg shadow-sm transition-colors"
                    >
                      <span class="material-symbols-outlined text-lg">key</span>
                      Đổi mật khẩu
                    </button>
                  </div>
                </form>
              </div>

              <!-- Health Info Panel (Hidden by default) -->
              <div id="panel-health" class="hidden space-y-6">
                <form
                  th:action="@{/profile/update-health}"
                  method="post"
                  class="space-y-6"
                >
                  <input
                    type="hidden"
                    th:name="${_csrf.parameterName}"
                    th:value="${_csrf.token}"
                  />

                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                      >
                        <span
                          class="material-symbols-outlined align-middle mr-1 text-lg"
                          >water_drop</span
                        >
                        Nhóm máu
                      </label>
                      <select
                        name="bloodType"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                      >
                        <option value="">-- Chọn --</option>
                        <option
                          value="A+"
                          th:selected="${healthInfo?.bloodType == 'A+'}"
                        >
                          A+
                        </option>
                        <option
                          value="A-"
                          th:selected="${healthInfo?.bloodType == 'A-'}"
                        >
                          A-
                        </option>
                        <option
                          value="B+"
                          th:selected="${healthInfo?.bloodType == 'B+'}"
                        >
                          B+
                        </option>
                        <option
                          value="B-"
                          th:selected="${healthInfo?.bloodType == 'B-'}"
                        >
                          B-
                        </option>
                        <option
                          value="AB+"
                          th:selected="${healthInfo?.bloodType == 'AB+'}"
                        >
                          AB+
                        </option>
                        <option
                          value="AB-"
                          th:selected="${healthInfo?.bloodType == 'AB-'}"
                        >
                          AB-
                        </option>
                        <option
                          value="O+"
                          th:selected="${healthInfo?.bloodType == 'O+'}"
                        >
                          O+
                        </option>
                        <option
                          value="O-"
                          th:selected="${healthInfo?.bloodType == 'O-'}"
                        >
                          O-
                        </option>
                      </select>
                    </div>
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                      >
                        <span
                          class="material-symbols-outlined align-middle mr-1 text-lg"
                          >height</span
                        >
                        Chiều cao (cm)
                      </label>
                      <input
                        type="number"
                        name="height"
                        min="50"
                        max="300"
                        step="0.1"
                        th:value="${healthInfo?.height}"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                      />
                    </div>
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                      >
                        <span
                          class="material-symbols-outlined align-middle mr-1 text-lg"
                          >monitor_weight</span
                        >
                        Cân nặng (kg)
                      </label>
                      <input
                        type="number"
                        name="weight"
                        min="1"
                        max="500"
                        step="0.1"
                        th:value="${healthInfo?.weight}"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                      />
                    </div>
                  </div>

                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >
                      <span
                        class="material-symbols-outlined align-middle mr-1 text-lg"
                        >medication</span
                      >
                      Dị ứng
                    </label>
                    <textarea
                      name="allergies"
                      rows="2"
                      th:text="${healthInfo?.allergies}"
                      placeholder="Liệt kê các loại dị ứng (nếu có)"
                      class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary transition resize-none"
                    ></textarea>
                  </div>

                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >
                      <span
                        class="material-symbols-outlined align-middle mr-1 text-lg"
                        >healing</span
                      >
                      Bệnh mãn tính
                    </label>
                    <textarea
                      name="chronicDiseases"
                      rows="2"
                      th:text="${healthInfo?.chronicDiseases}"
                      placeholder="Liệt kê các bệnh mãn tính (nếu có)"
                      class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary transition resize-none"
                    ></textarea>
                  </div>

                  <div class="flex justify-end">
                    <button
                      type="submit"
                      class="inline-flex items-center gap-2 px-6 py-2.5 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg shadow-sm transition-colors"
                    >
                      <span class="material-symbols-outlined text-lg"
                        >save</span
                      >
                      Cập nhật thông tin sức khỏe
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Scripts Fragment -->
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <!-- Page-specific Script -->
    <script>
      // Tab switching functionality
      function switchTab(tabName) {
        // Hide all panels
        document.querySelectorAll('[id^="panel-"]').forEach((panel) => {
          panel.classList.add("hidden");
        });

        // Remove active state from all tabs
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("border-primary", "text-primary");
          btn.classList.add(
            "border-transparent",
            "text-gray-500",
            "dark:text-gray-400",
          );
        });

        // Show selected panel
        document.getElementById("panel-" + tabName).classList.remove("hidden");

        // Add active state to selected tab
        const activeTab = document.getElementById("tab-" + tabName);
        activeTab.classList.remove(
          "border-transparent",
          "text-gray-500",
          "dark:text-gray-400",
        );
        activeTab.classList.add("border-primary", "text-primary");
      }

      // Avatar preview functionality
      document
        .getElementById("avatarInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById("avatarPreview").src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Upload avatar
            const formData = new FormData();
            formData.append("avatar", file);

            const csrfToken = document.querySelector('[name="_csrf"]')?.value;

            fetch("/profile/upload-avatar", {
              method: "POST",
              headers: {
                "X-CSRF-TOKEN": csrfToken,
              },
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  showToast("Cập nhật ảnh đại diện thành công!", "success");
                } else {
                  showToast(
                    "Có lỗi xảy ra: " +
                      (data.message || "Không thể cập nhật ảnh"),
                    "error",
                  );
                }
              })
              .catch((error) => {
                console.error("Error:", error);
                showToast("Có lỗi xảy ra khi upload ảnh", "error");
              });
          }
        });

      // Toast notification function (if not already defined)
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        const bgColor =
          type === "success"
            ? "bg-green-500"
            : type === "error"
              ? "bg-red-500"
              : "bg-primary";
        const icon =
          type === "success"
            ? "check_circle"
            : type === "error"
              ? "error"
              : "info";

        toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-fade-in`;
        toast.innerHTML = `<span class="material-symbols-outlined">${icon}</span><span>${message}</span>`;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("opacity-0", "transition-opacity");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    </script>

    <style>
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in {
        animation: fade-in 0.3s ease-out;
      }
    </style>
  </body>
</html>
