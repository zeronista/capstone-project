<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ticket Hỗ Trợ - ABClinic</title>

    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" th:href="@{/images/Logo.jpg}" />
    <link rel="shortcut icon" type="image/jpeg" th:href="@{/images/Logo.jpg}" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script th:src="@{/js/tailwind-config.js}"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap"
    />
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
      .material-symbols-outlined.fill {
        font-variation-settings: "FILL" 1;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-slate-100 font-sans"
  >
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside th:replace="~{fragments/doctor-layout :: doctor-sidebar}"></aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Header -->
        <header
          class="bg-white dark:bg-[#1a2634] border-b border-slate-200 dark:border-slate-800 px-6 py-4"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <button
                onclick="toggleSidebar()"
                class="lg:hidden p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
              >
                <span class="material-symbols-outlined">menu</span>
              </button>
              <div>
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">
                  Ticket Hỗ Trợ
                </h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Quản lý và xử lý các yêu cầu hỗ trợ từ lễ tân
                </p>
              </div>
            </div>
            <button
              onclick="refreshTickets()"
              class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors"
            >
              <span class="material-symbols-outlined text-[20px]">refresh</span>
              <span class="hidden sm:inline">Làm mới</span>
            </button>
          </div>
        </header>

        <!-- Filters -->
        <div
          class="bg-white dark:bg-[#1a2634] border-b border-slate-200 dark:border-slate-800 px-6 py-4"
        >
          <div class="flex flex-wrap items-center gap-4">
            <!-- Search -->
            <div class="flex-1 min-w-[250px] relative">
              <span
                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
                >search</span
              >
              <input
                type="text"
                id="searchInput"
                placeholder="Tìm theo tiêu đề, bệnh nhân..."
                onkeyup="debounceSearch()"
                class="w-full pl-10 pr-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              />
            </div>

            <!-- Status Filter -->
            <select
              id="statusFilter"
              onchange="filterTickets()"
              class="px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
            >
              <option value="">Tất cả trạng thái</option>
              <option value="OPEN">Mới mở</option>
              <option value="ASSIGNED">Đã gán</option>
              <option value="IN_PROGRESS">Đang xử lý</option>
              <option value="RESOLVED">Đã giải quyết</option>
              <option value="CLOSED">Đã đóng</option>
            </select>

            <!-- Priority Filter -->
            <select
              id="priorityFilter"
              onchange="filterTickets()"
              class="px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
            >
              <option value="">Tất cả mức độ</option>
              <option value="URGENT">Khẩn cấp</option>
              <option value="HIGH">Cao</option>
              <option value="MEDIUM">Trung bình</option>
              <option value="LOW">Thấp</option>
            </select>
          </div>
        </div>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-6">
          <!-- Statistics Cards -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-blue-600 dark:text-blue-400"
                    >confirmation_number</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="totalTickets"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Tổng ticket</p>
                </div>
              </div>
            </div>
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-amber-600 dark:text-amber-400"
                    >pending</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="inProgressTickets"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Đang xử lý</p>
                </div>
              </div>
            </div>
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-red-100 dark:bg-red-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-red-600 dark:text-red-400"
                    >priority_high</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="highPriorityTickets"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Ưu tiên cao</p>
                </div>
              </div>
            </div>
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-green-600 dark:text-green-400"
                    >check_circle</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="resolvedTickets"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Đã xử lý</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Tickets Table -->
          <div
            class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden"
          >
            <div
              class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
            >
              <h3 class="font-semibold text-slate-900 dark:text-white">
                Danh sách Ticket
              </h3>
              <span id="resultsInfo" class="text-sm text-slate-500"></span>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 dark:bg-slate-800/50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      ID
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Tiêu đề
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Bệnh nhân
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Lễ tân
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Mức độ
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Trạng thái
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Ngày tạo
                    </th>
                    <th
                      class="px-6 py-3 text-right text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider"
                    >
                      Thao tác
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="ticketsTableBody"
                  class="divide-y divide-slate-200 dark:divide-slate-700"
                >
                  <tr>
                    <td colspan="8" class="px-6 py-12 text-center">
                      <span
                        class="material-symbols-outlined text-5xl text-slate-300 dark:text-slate-600"
                        >hourglass_empty</span
                      >
                      <p class="mt-2 text-slate-500">Đang tải dữ liệu...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div
      id="ticketModal"
      class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-[#1a2634] rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
            Chi tiết Ticket #<span id="ticketId"></span>
          </h3>
          <button
            onclick="closeModal()"
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <div id="ticketDetailContent" class="flex-1 overflow-y-auto p-6">
          <!-- Content will be loaded dynamically -->
        </div>

        <!-- Status Update & Reply -->
        <div
          class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 space-y-4"
        >
          <!-- Update Status -->
          <div class="flex items-center gap-3">
            <label
              class="text-sm font-medium text-slate-700 dark:text-slate-300 whitespace-nowrap"
              >Đổi trạng thái:</label
            >
            <select
              id="newStatus"
              class="flex-1 px-4 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
            >
              <option value="">-- Chọn trạng thái --</option>
              <option value="IN_PROGRESS">Đang xử lý</option>
              <option value="RESOLVED">Đã giải quyết</option>
              <option value="CLOSED">Đóng ticket</option>
            </select>
            <button
              onclick="updateStatus()"
              class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors"
            >
              Cập nhật
            </button>
          </div>

          <!-- Reply -->
          <div class="flex gap-3">
            <input
              type="text"
              id="replyMessage"
              placeholder="Nhập phản hồi..."
              onkeypress="if(event.key==='Enter') sendReply()"
              class="flex-1 px-4 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
            />
            <button
              onclick="sendReply()"
              class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center gap-2"
            >
              <span class="material-symbols-outlined text-[20px]">send</span>
              Gửi
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-4 right-4 z-50 space-y-2"
    ></div>

    <!-- Scripts -->
    <script th:src="@{/js/doctor-sidebar-controller.js}"></script>
    <script>
      // Global state
      let allTickets = [];
      let filteredTickets = [];
      let currentTicketId = null;
      let searchTimeout = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadTickets();
      });

      // Load tickets
      async function loadTickets() {
        try {
          const response = await fetch("/api/doctor/tickets");
          if (!response.ok) throw new Error("Failed to load tickets");

          const data = await response.json();
          allTickets = data.tickets || [];
          filterTickets();
          updateStatistics();
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể tải danh sách ticket", "error");
        }
      }

      // Refresh tickets
      function refreshTickets() {
        loadTickets();
        showToast("Đã làm mới danh sách", "info");
      }

      // Debounced search
      function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => filterTickets(), 300);
      }

      // Filter tickets
      function filterTickets() {
        const search = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const status = document.getElementById("statusFilter").value;
        const priority = document.getElementById("priorityFilter").value;

        filteredTickets = allTickets.filter((ticket) => {
          const matchSearch =
            !search ||
            ticket.title?.toLowerCase().includes(search) ||
            ticket.patientName?.toLowerCase().includes(search) ||
            ticket.description?.toLowerCase().includes(search);
          const matchStatus = !status || ticket.status === status;
          const matchPriority = !priority || ticket.priority === priority;
          return matchSearch && matchStatus && matchPriority;
        });

        renderTickets();
      }

      // Update statistics
      function updateStatistics() {
        document.getElementById("totalTickets").textContent = allTickets.length;
        document.getElementById("inProgressTickets").textContent =
          allTickets.filter(
            (t) => t.status === "IN_PROGRESS" || t.status === "ASSIGNED",
          ).length;
        document.getElementById("highPriorityTickets").textContent =
          allTickets.filter(
            (t) => t.priority === "HIGH" || t.priority === "URGENT",
          ).length;
        document.getElementById("resolvedTickets").textContent =
          allTickets.filter(
            (t) => t.status === "RESOLVED" || t.status === "CLOSED",
          ).length;
      }

      // Render tickets table
      function renderTickets() {
        const tbody = document.getElementById("ticketsTableBody");

        if (filteredTickets.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="px-6 py-12 text-center">
                <span class="material-symbols-outlined text-5xl text-slate-300 dark:text-slate-600">inbox</span>
                <p class="mt-2 text-slate-500">Không có ticket nào</p>
              </td>
            </tr>
          `;
          document.getElementById("resultsInfo").textContent = "0 ticket";
          return;
        }

        tbody.innerHTML = filteredTickets
          .map(
            (ticket) => `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
            <td class="px-6 py-4 text-sm font-medium text-primary">#${ticket.id}</td>
            <td class="px-6 py-4">
              <div class="text-sm font-medium text-slate-900 dark:text-white">${escapeHtml(ticket.title)}</div>
              <div class="text-xs text-slate-500 truncate max-w-xs">${escapeHtml(ticket.description || "")}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-slate-900 dark:text-white">${escapeHtml(ticket.patientName || "N/A")}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-slate-600 dark:text-slate-400">${escapeHtml(ticket.createdByName || "N/A")}</div>
            </td>
            <td class="px-6 py-4">${getPriorityBadge(ticket.priority)}</td>
            <td class="px-6 py-4">${getStatusBadge(ticket.status)}</td>
            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${formatDate(ticket.createdAt)}</td>
            <td class="px-6 py-4 text-right">
              <button onclick="viewTicket(${ticket.id})" class="p-2 text-primary hover:bg-primary/10 rounded-lg transition-colors" title="Xem chi tiết">
                <span class="material-symbols-outlined text-[20px]">visibility</span>
              </button>
            </td>
          </tr>
        `,
          )
          .join("");

        document.getElementById("resultsInfo").textContent =
          `${filteredTickets.length} ticket`;
      }

      // View ticket detail
      async function viewTicket(id) {
        currentTicketId = id;
        document.getElementById("ticketId").textContent = id;

        try {
          const response = await fetch(`/api/doctor/tickets/${id}`);
          if (!response.ok) throw new Error("Failed to load ticket");

          const ticket = await response.json();
          renderTicketDetail(ticket);
          openModal();
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể tải chi tiết ticket", "error");
        }
      }

      // Render ticket detail
      function renderTicketDetail(ticket) {
        const content = document.getElementById("ticketDetailContent");

        content.innerHTML = `
          <div class="space-y-6">
            <!-- Ticket Info -->
            <div class="bg-slate-50 dark:bg-slate-800 rounded-xl p-4">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <p class="text-xs text-slate-500 mb-1">Bệnh nhân</p>
                  <p class="text-sm font-medium text-slate-900 dark:text-white">${escapeHtml(ticket.patientName || "N/A")}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 mb-1">Lễ tân tạo</p>
                  <p class="text-sm font-medium text-slate-900 dark:text-white">${escapeHtml(ticket.createdByName || "N/A")}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 mb-1">Danh mục</p>
                  <p class="text-sm font-medium text-slate-900 dark:text-white">${getCategoryName(ticket.category)}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 mb-1">Ngày tạo</p>
                  <p class="text-sm font-medium text-slate-900 dark:text-white">${formatDateTime(ticket.createdAt)}</p>
                </div>
              </div>
              <div class="flex items-center gap-4 mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                <div>
                  <p class="text-xs text-slate-500 mb-1">Mức độ</p>
                  ${getPriorityBadge(ticket.priority)}
                </div>
                <div>
                  <p class="text-xs text-slate-500 mb-1">Trạng thái</p>
                  ${getStatusBadge(ticket.status)}
                </div>
              </div>
            </div>

            <!-- Description -->
            <div>
              <h4 class="text-sm font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px]">description</span>
                Mô tả vấn đề
              </h4>
              <div class="bg-slate-50 dark:bg-slate-800 rounded-lg p-4">
                <p class="text-sm text-slate-600 dark:text-slate-400 whitespace-pre-wrap">${escapeHtml(ticket.description || "Không có mô tả")}</p>
              </div>
            </div>

            <!-- Messages -->
            <div>
              <h4 class="text-sm font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px]">chat</span>
                Lịch sử trao đổi (${ticket.messages?.length || 0})
              </h4>
              <div class="space-y-3 max-h-64 overflow-y-auto">
                ${
                  ticket.messages && ticket.messages.length > 0
                    ? ticket.messages
                        .map(
                          (msg) => `
                  <div class="flex gap-3 ${msg.isInternalNote ? "bg-amber-50 dark:bg-amber-900/20 rounded-lg p-3" : ""}">
                    <div class="w-8 h-8 rounded-full ${msg.senderRole === "RECEPTIONIST" ? "bg-purple-500" : "bg-green-500"} text-white flex items-center justify-center text-xs font-bold flex-shrink-0">
                      ${msg.senderName ? msg.senderName.charAt(0).toUpperCase() : "?"}
                    </div>
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <span class="text-sm font-medium text-slate-900 dark:text-white">${escapeHtml(msg.senderName || "Unknown")}</span>
                        <span class="px-1.5 py-0.5 ${msg.senderRole === "RECEPTIONIST" ? "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400" : "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"} text-xs rounded">${msg.senderRole === "RECEPTIONIST" ? "Lễ tân" : "Bác sĩ"}</span>
                        <span class="text-xs text-slate-500">${formatDateTime(msg.createdAt)}</span>
                        ${msg.isInternalNote ? '<span class="px-2 py-0.5 bg-amber-200 dark:bg-amber-800 text-amber-800 dark:text-amber-200 text-xs rounded">Ghi chú nội bộ</span>' : ""}
                      </div>
                      <p class="text-sm text-slate-600 dark:text-slate-400">${escapeHtml(msg.messageText)}</p>
                    </div>
                  </div>
                `,
                        )
                        .join("")
                    : '<p class="text-sm text-slate-500 text-center py-8">Chưa có tin nhắn</p>'
                }
              </div>
            </div>
          </div>
        `;

        // Set current status in dropdown
        document.getElementById("newStatus").value = "";
      }

      // Update status
      async function updateStatus() {
        const newStatus = document.getElementById("newStatus").value;
        if (!newStatus) {
          showToast("Vui lòng chọn trạng thái", "warning");
          return;
        }

        try {
          const response = await fetch(
            `/api/doctor/tickets/${currentTicketId}/status`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: newStatus, note: "" }),
            },
          );

          const result = await response.json();
          if (result.success) {
            showToast("Cập nhật trạng thái thành công", "success");
            loadTickets();
            viewTicket(currentTicketId); // Reload detail
          } else {
            showToast(result.message || "Lỗi cập nhật", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể cập nhật trạng thái", "error");
        }
      }

      // Send reply
      async function sendReply() {
        const message = document.getElementById("replyMessage").value.trim();
        if (!message) {
          showToast("Vui lòng nhập nội dung phản hồi", "warning");
          return;
        }

        try {
          const response = await fetch(
            `/api/doctor/tickets/${currentTicketId}/messages`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                messageText: message,
                messageType: "TEXT",
                isInternalNote: false,
              }),
            },
          );

          const result = await response.json();
          if (result.success) {
            document.getElementById("replyMessage").value = "";
            showToast("Gửi phản hồi thành công", "success");
            viewTicket(currentTicketId); // Reload detail
          } else {
            showToast(result.message || "Lỗi gửi phản hồi", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể gửi phản hồi", "error");
        }
      }

      // Modal functions
      function openModal() {
        document.getElementById("ticketModal").classList.remove("hidden");
        document.getElementById("ticketModal").classList.add("flex");
      }

      function closeModal() {
        document.getElementById("ticketModal").classList.add("hidden");
        document.getElementById("ticketModal").classList.remove("flex");
        currentTicketId = null;
      }

      // Helper functions
      function getPriorityBadge(priority) {
        const map = {
          URGENT:
            '<span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 text-xs font-medium rounded-full">Khẩn cấp</span>',
          HIGH: '<span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 text-xs font-medium rounded-full">Cao</span>',
          MEDIUM:
            '<span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-xs font-medium rounded-full">Trung bình</span>',
          LOW: '<span class="px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-medium rounded-full">Thấp</span>',
        };
        return map[priority] || map.MEDIUM;
      }

      function getStatusBadge(status) {
        const map = {
          OPEN: '<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-xs font-medium rounded-full">Mới mở</span>',
          ASSIGNED:
            '<span class="px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 text-xs font-medium rounded-full">Đã gán</span>',
          IN_PROGRESS:
            '<span class="px-2 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 text-xs font-medium rounded-full">Đang xử lý</span>',
          RESOLVED:
            '<span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-medium rounded-full">Đã giải quyết</span>',
          CLOSED:
            '<span class="px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-medium rounded-full">Đã đóng</span>',
        };
        return map[status] || map.OPEN;
      }

      function getCategoryName(category) {
        const map = {
          MEDICAL_QUERY: "Câu hỏi y tế",
          APPOINTMENT: "Lịch hẹn",
          PRESCRIPTION: "Đơn thuốc",
          TECHNICAL: "Kỹ thuật",
          OTHER: "Khác",
        };
        return map[category] || category || "N/A";
      }

      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleDateString("vi-VN");
      }

      function formatDateTime(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleString("vi-VN");
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showToast(message, type = "info") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");

        const colors = {
          success: "bg-green-500",
          error: "bg-red-500",
          info: "bg-blue-500",
          warning: "bg-amber-500",
        };

        const icons = {
          success: "check_circle",
          error: "error",
          info: "info",
          warning: "warning",
        };

        toast.className = `flex items-center gap-3 px-4 py-3 ${colors[type]} text-white rounded-lg shadow-lg min-w-[300px]`;
        toast.innerHTML = `
          <span class="material-symbols-outlined">${icons[type]}</span>
          <span class="flex-1">${message}</span>
          <button onclick="this.parentElement.remove()" class="p-1 hover:bg-white/20 rounded">
            <span class="material-symbols-outlined text-[18px]">close</span>
          </button>
        `;

        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    </script>
  </body>
</html>
