<!doctype html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kho tri thức Y khoa - Doctor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200..700&display=swap"
      rel="stylesheet"
    />
    <!-- Quill Editor -->
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
      .category-tree-item {
        cursor: pointer;
        transition: all 0.2s;
      }
      .category-tree-item:hover {
        background-color: rgba(59, 130, 246, 0.1);
      }
      .category-tree-item.active {
        background-color: rgba(59, 130, 246, 0.15);
        font-weight: 600;
        color: rgb(37, 99, 235);
      }
      .ql-editor {
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
      }
      .tag-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        background-color: rgb(219, 234, 254);
        color: rgb(30, 64, 175);
        border-radius: 9999px;
        font-size: 0.875rem;
        margin: 0.25rem;
      }
      .tag-remove {
        margin-left: 0.5rem;
        cursor: pointer;
        font-weight: bold;
      }
      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .status-PUBLISHED {
        background-color: #d1fae5;
        color: #065f46;
      }
      .status-DRAFT {
        background-color: #fef3c7;
        color: #92400e;
      }
      .status-ARCHIVED {
        background-color: #e5e7eb;
        color: #374151;
      }
    </style>
  </head>
  <body class="bg-slate-50 dark:bg-slate-900">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside th:replace="~{fragments/doctor-layout :: doctor-sidebar}"></aside>

      <!-- Main content -->
      <main class="flex-1 overflow-y-auto">
        <!-- Header -->
        <header class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-10">
          <div class="px-6 py-4">
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
                  Kho tri thức Y khoa
                </h1>
                <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">
                  Quản lý tài liệu và kiến thức y khoa
                </p>
              </div>
              <button
                onclick="openArticleModal()"
                class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
              >
                <span class="material-symbols-outlined text-[20px]">add</span>
                <span>Tạo bài viết mới</span>
              </button>
            </div>
          </div>
        </header>

        <!-- Content -->
        <div class="p-6">
          <!-- Statistics -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white dark:bg-slate-800 rounded-lg p-4 shadow-sm">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">
                    Tổng bài viết
                  </p>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white mt-1"
                    id="totalArticles"
                  >
                    0
                  </p>
                </div>
                <span
                  class="material-symbols-outlined text-blue-600 text-[40px]"
                  >description</span
                >
              </div>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-lg p-4 shadow-sm">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">
                    Đã xuất bản
                  </p>
                  <p
                    class="text-2xl font-bold text-green-600 mt-1"
                    id="publishedArticles"
                  >
                    0
                  </p>
                </div>
                <span
                  class="material-symbols-outlined text-green-600 text-[40px]"
                  >check_circle</span
                >
              </div>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-lg p-4 shadow-sm">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">
                    Bản nháp
                  </p>
                  <p
                    class="text-2xl font-bold text-yellow-600 mt-1"
                    id="draftArticles"
                  >
                    0
                  </p>
                </div>
                <span
                  class="material-symbols-outlined text-yellow-600 text-[40px]"
                  >edit_note</span
                >
              </div>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-lg p-4 shadow-sm">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-600 dark:text-slate-400">
                    Danh mục
                  </p>
                  <p
                    class="text-2xl font-bold text-purple-600 mt-1"
                    id="totalCategories"
                  >
                    0
                  </p>
                </div>
                <span
                  class="material-symbols-outlined text-purple-600 text-[40px]"
                  >folder</span
                >
              </div>
            </div>
          </div>

          <!-- Main content area -->
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Category Tree Sidebar -->
            <div class="lg:col-span-1">
              <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm p-4">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-slate-900 dark:text-white">
                    Danh mục
                  </h3>
                  <button
                    onclick="openCategoryModal()"
                    class="text-blue-600 hover:text-blue-700"
                    title="Thêm danh mục"
                  >
                    <span class="material-symbols-outlined text-[20px]"
                      >add</span
                    >
                  </button>
                </div>
                <div
                  class="category-tree-item px-3 py-2 rounded-md mb-1"
                  onclick="filterByCategory(null)"
                  id="category-all"
                >
                  <span
                    class="material-symbols-outlined text-[18px] align-middle"
                    >apps</span
                  >
                  <span class="ml-2">Tất cả bài viết</span>
                </div>
                <div id="categoryTree" class="space-y-1"></div>
              </div>
            </div>

            <!-- Articles List -->
            <div class="lg:col-span-3">
              <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm">
                <!-- Filters -->
                <div
                  class="p-4 border-b border-slate-200 dark:border-slate-700"
                >
                  <div class="flex flex-wrap gap-3">
                    <div class="flex-1 min-w-[200px]">
                      <input
                        type="text"
                        id="searchInput"
                        placeholder="Tìm kiếm bài viết..."
                        class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-white"
                        onkeyup="handleSearch(event)"
                      />
                    </div>
                    <select
                      id="statusFilter"
                      class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-white"
                      onchange="loadArticles()"
                    >
                      <option value="">Tất cả trạng thái</option>
                      <option value="PUBLISHED">Đã xuất bản</option>
                      <option value="DRAFT">Bản nháp</option>
                      <option value="ARCHIVED">Đã lưu trữ</option>
                    </select>
                  </div>
                </div>

                <!-- Articles Table -->
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-slate-50 dark:bg-slate-700">
                      <tr>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-slate-700 dark:text-slate-300 uppercase"
                        >
                          Tiêu đề
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-slate-700 dark:text-slate-300 uppercase"
                        >
                          Danh mục
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-slate-700 dark:text-slate-300 uppercase"
                        >
                          Trạng thái
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-slate-700 dark:text-slate-300 uppercase"
                        >
                          Lượt xem
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-slate-700 dark:text-slate-300 uppercase"
                        >
                          Ngày tạo
                        </th>
                        <th
                          class="px-6 py-3 text-right text-xs font-medium text-slate-700 dark:text-slate-300 uppercase"
                        >
                          Thao tác
                        </th>
                      </tr>
                    </thead>
                    <tbody
                      id="articlesTableBody"
                      class="divide-y divide-slate-200 dark:divide-slate-700"
                    >
                      <!-- Articles will be inserted here -->
                    </tbody>
                  </table>
                </div>

                <!-- Pagination -->
                <div
                  class="p-4 border-t border-slate-200 dark:border-slate-700"
                >
                  <div class="flex items-center justify-between">
                    <p
                      class="text-sm text-slate-600 dark:text-slate-400"
                      id="paginationInfo"
                    >
                      Đang hiển thị 0 - 0 của 0 bài viết
                    </p>
                    <div class="flex gap-2" id="paginationButtons"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Article Modal -->
    <div
      id="articleModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto"
    >
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
        >
          <div
            class="sticky top-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 py-4 flex items-center justify-between z-10"
          >
            <h3
              class="text-xl font-bold text-slate-900 dark:text-white"
              id="modalTitle"
            >
              Tạo bài viết mới
            </h3>
            <button
              onclick="closeArticleModal()"
              class="text-slate-400 hover:text-slate-600"
            >
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
          <form id="articleForm" class="p-6 space-y-4">
            <input type="hidden" id="articleId" />

            <!-- Title -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
              >
                Tiêu đề <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="articleTitle"
                required
                class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-white"
                placeholder="Nhập tiêu đề bài viết"
              />
            </div>

            <!-- Category -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
              >
                Danh mục
              </label>
              <select
                id="articleCategory"
                class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-white"
              >
                <option value="">Chưa phân loại</option>
              </select>
            </div>

            <!-- Summary -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
              >
                Tóm tắt
              </label>
              <textarea
                id="articleSummary"
                rows="2"
                class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-white"
                placeholder="Tóm tắt ngắn gọn nội dung bài viết"
              ></textarea>
            </div>

            <!-- Content Editor -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
              >
                Nội dung <span class="text-red-500">*</span>
              </label>
              <div
                id="editor"
                class="bg-white border border-slate-300 dark:border-slate-600 rounded-lg"
              ></div>
            </div>

            <!-- Tags -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
              >
                Tags
              </label>
              <div class="flex gap-2 mb-2">
                <input
                  type="text"
                  id="tagInput"
                  class="flex-1 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-white"
                  placeholder="Nhập tag và nhấn Enter"
                  onkeypress="handleTagInput(event)"
                />
              </div>
              <div id="tagsContainer" class="flex flex-wrap"></div>
            </div>

            <!-- Status & Featured -->
            <div class="flex gap-4">
              <div class="flex-1">
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >
                  Trạng thái
                </label>
                <select
                  id="articleStatus"
                  class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-white"
                >
                  <option value="DRAFT">Bản nháp</option>
                  <option value="PUBLISHED">Xuất bản</option>
                  <option value="ARCHIVED">Lưu trữ</option>
                </select>
              </div>
              <div class="flex items-end">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="articleFeatured" class="rounded" />
                  <span class="text-sm text-slate-700 dark:text-slate-300"
                    >Bài viết nổi bật</span
                  >
                </label>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-3 pt-4">
              <button
                type="submit"
                class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
              >
                Lưu bài viết
              </button>
              <button
                type="button"
                onclick="closeArticleModal()"
                class="px-6 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
              >
                Hủy
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Category Modal -->
    <div
      id="categoryModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50"
    >
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full"
        >
          <div
            class="border-b border-slate-200 dark:border-slate-700 px-6 py-4 flex items-center justify-between"
          >
            <h3 class="text-xl font-bold text-slate-900 dark:text-white">
              Thêm danh mục
            </h3>
            <button
              onclick="closeCategoryModal()"
              class="text-slate-400 hover:text-slate-600"
            >
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
          <form id="categoryForm" class="p-6 space-y-4">
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
              >
                Tên danh mục <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="categoryName"
                required
                class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-white"
              />
            </div>
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
              >
                Mô tả
              </label>
              <textarea
                id="categoryDescription"
                rows="3"
                class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-white"
              ></textarea>
            </div>
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
              >
                Danh mục cha
              </label>
              <select
                id="categoryParent"
                class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-white"
              >
                <option value="">Danh mục gốc</option>
              </select>
            </div>
            <div class="flex gap-3 pt-4">
              <button
                type="submit"
                class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
              >
                Tạo danh mục
              </button>
              <button
                type="button"
                onclick="closeCategoryModal()"
                class="px-6 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
              >
                Hủy
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      let quill;
      let allArticles = [];
      let currentPage = 0;
      let pageSize = 20;
      let totalPages = 0;
      let selectedCategoryId = null;
      let articleTags = [];
      let categories = [];

      // Initialize Quill Editor
      document.addEventListener("DOMContentLoaded", function () {
        quill = new Quill("#editor", {
          theme: "snow",
          modules: {
            toolbar: [
              [{ header: [1, 2, 3, false] }],
              ["bold", "italic", "underline", "strike"],
              [{ list: "ordered" }, { list: "bullet" }],
              [{ color: [] }, { background: [] }],
              ["link", "blockquote", "code-block"],
              ["clean"],
            ],
          },
        });

        loadCategories();
        loadArticles();
        loadStatistics();
      });

      // Load statistics
      async function loadStatistics() {
        try {
          const response = await fetch("/api/doctor/articles/statistics");
          const stats = await response.json();

          document.getElementById("totalArticles").textContent =
            stats.totalCount;
          document.getElementById("publishedArticles").textContent =
            stats.publishedCount;
          document.getElementById("draftArticles").textContent =
            stats.draftCount;
        } catch (error) {
          console.error("Error loading statistics:", error);
        }
      }

      // Load categories
      async function loadCategories() {
        try {
          const response = await fetch("/api/doctor/categories");
          categories = await response.json();

          document.getElementById("totalCategories").textContent =
            categories.length;

          // Populate category tree
          const treeContainer = document.getElementById("categoryTree");
          treeContainer.innerHTML = "";
          categories.forEach((category) =>
            renderCategory(category, treeContainer, 0),
          );

          // Populate category selects
          populateCategorySelect("articleCategory", categories);
          populateCategorySelect("categoryParent", categories);
        } catch (error) {
          console.error("Error loading categories:", error);
        }
      }

      function renderCategory(category, container, depth) {
        const item = document.createElement("div");
        item.className = "category-tree-item px-3 py-2 rounded-md mb-1";
        item.style.paddingLeft = `${depth * 16 + 12}px`;
        item.setAttribute("data-category-id", category.id);
        item.onclick = () => filterByCategory(category.id);

        item.innerHTML = `
          <span class="material-symbols-outlined text-[18px] align-middle">
            ${category.hasChildren ? "folder" : "folder_open"}
          </span>
          <span class="ml-2">${category.name}</span>
          <span class="text-xs text-slate-500 ml-2">(${category.articleCount || 0})</span>
        `;

        container.appendChild(item);

        if (category.children && category.children.length > 0) {
          category.children.forEach((child) =>
            renderCategory(child, container, depth + 1),
          );
        }
      }

      function populateCategorySelect(selectId, categories, depth = 0) {
        const select = document.getElementById(selectId);
        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category.id;
          option.textContent = "  ".repeat(depth) + category.name;
          select.appendChild(option);

          if (category.children && category.children.length > 0) {
            populateCategorySelect(selectId, category.children, depth + 1);
          }
        });
      }

      // Filter by category
      function filterByCategory(categoryId) {
        selectedCategoryId = categoryId;
        currentPage = 0;

        // Update active state
        document.querySelectorAll(".category-tree-item").forEach((item) => {
          item.classList.remove("active");
        });

        if (categoryId === null) {
          document.getElementById("category-all").classList.add("active");
        } else {
          document
            .querySelector(`[data-category-id="${categoryId}"]`)
            ?.classList.add("active");
        }

        loadArticles();
      }

      // Load articles
      async function loadArticles() {
        try {
          const status = document.getElementById("statusFilter").value;
          const keyword = document.getElementById("searchInput").value;

          let url = `/api/doctor/articles?page=${currentPage}&size=${pageSize}`;
          if (status) url += `&status=${status}`;
          if (selectedCategoryId) url += `&categoryId=${selectedCategoryId}`;
          if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;

          const response = await fetch(url);
          const data = await response.json();

          allArticles = data.articles;
          totalPages = data.totalPages;

          renderArticles();
          renderPagination(data.currentPage, data.totalPages, data.totalItems);
        } catch (error) {
          console.error("Error loading articles:", error);
          alert("Lỗi tải danh sách bài viết");
        }
      }

      // Render articles
      function renderArticles() {
        const tbody = document.getElementById("articlesTableBody");
        tbody.innerHTML = "";

        if (allArticles.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">Không có bài viết nào</td></tr>';
          return;
        }

        allArticles.forEach((article) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-slate-50 dark:hover:bg-slate-700";
          row.innerHTML = `
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                ${article.featured ? '<span class="material-symbols-outlined text-yellow-500 text-[18px]">star</span>' : ""}
                <span class="font-medium text-slate-900 dark:text-white">${article.title}</span>
              </div>
            </td>
            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">
              ${article.categoryName || "Chưa phân loại"}
            </td>
            <td class="px-6 py-4">
              <span class="status-badge status-${article.status}">${getStatusText(article.status)}</span>
            </td>
            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">
              ${article.views}
            </td>
            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">
              ${formatDate(article.createdAt)}
            </td>
            <td class="px-6 py-4 text-right space-x-2">
              <button
                onclick="viewArticle(${article.id})"
                class="text-blue-600 hover:text-blue-700"
                title="Xem chi tiết"
              >
                <span class="material-symbols-outlined text-[20px]">visibility</span>
              </button>
              <button
                onclick="editArticle(${article.id})"
                class="text-green-600 hover:text-green-700"
                title="Chỉnh sửa"
              >
                <span class="material-symbols-outlined text-[20px]">edit</span>
              </button>
              <button
                onclick="deleteArticle(${article.id})"
                class="text-red-600 hover:text-red-700"
                title="Xóa"
              >
                <span class="material-symbols-outlined text-[20px]">delete</span>
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      // Render pagination
      function renderPagination(currentPage, totalPages, totalItems) {
        const info = document.getElementById("paginationInfo");
        const start = currentPage * pageSize + 1;
        const end = Math.min((currentPage + 1) * pageSize, totalItems);
        info.textContent = `Đang hiển thị ${start} - ${end} của ${totalItems} bài viết`;

        const buttons = document.getElementById("paginationButtons");
        buttons.innerHTML = "";

        if (totalPages <= 1) return;

        // Previous button
        const prevBtn = document.createElement("button");
        prevBtn.className = `px-3 py-1 border border-slate-300 dark:border-slate-600 rounded ${currentPage === 0 ? "opacity-50 cursor-not-allowed" : "hover:bg-slate-50 dark:hover:bg-slate-700"}`;
        prevBtn.textContent = "‹";
        prevBtn.disabled = currentPage === 0;
        prevBtn.onclick = () => changePage(currentPage - 1);
        buttons.appendChild(prevBtn);

        // Page numbers
        for (let i = 0; i < totalPages; i++) {
          if (
            i === 0 ||
            i === totalPages - 1 ||
            (i >= currentPage - 1 && i <= currentPage + 1)
          ) {
            const pageBtn = document.createElement("button");
            pageBtn.className = `px-3 py-1 border border-slate-300 dark:border-slate-600 rounded ${i === currentPage ? "bg-blue-600 text-white" : "hover:bg-slate-50 dark:hover:bg-slate-700"}`;
            pageBtn.textContent = i + 1;
            pageBtn.onclick = () => changePage(i);
            buttons.appendChild(pageBtn);
          } else if (i === currentPage - 2 || i === currentPage + 2) {
            const dots = document.createElement("span");
            dots.textContent = "...";
            dots.className = "px-2";
            buttons.appendChild(dots);
          }
        }

        // Next button
        const nextBtn = document.createElement("button");
        nextBtn.className = `px-3 py-1 border border-slate-300 dark:border-slate-600 rounded ${currentPage === totalPages - 1 ? "opacity-50 cursor-not-allowed" : "hover:bg-slate-50 dark:hover:bg-slate-700"}`;
        nextBtn.textContent = "›";
        nextBtn.disabled = currentPage === totalPages - 1;
        nextBtn.onclick = () => changePage(currentPage + 1);
        buttons.appendChild(nextBtn);
      }

      function changePage(page) {
        currentPage = page;
        loadArticles();
      }

      // Search
      let searchTimeout;
      function handleSearch(event) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentPage = 0;
          loadArticles();
        }, 500);
      }

      // Article Modal
      function openArticleModal(articleId = null) {
        document.getElementById("articleModal").classList.remove("hidden");
        document.getElementById("modalTitle").textContent = articleId
          ? "Chỉnh sửa bài viết"
          : "Tạo bài viết mới";

        if (articleId) {
          loadArticleForEdit(articleId);
        } else {
          resetArticleForm();
        }
      }

      function closeArticleModal() {
        document.getElementById("articleModal").classList.add("hidden");
        resetArticleForm();
      }

      function resetArticleForm() {
        document.getElementById("articleForm").reset();
        document.getElementById("articleId").value = "";
        quill.setContents([]);
        articleTags = [];
        renderTags();
      }

      async function loadArticleForEdit(id) {
        try {
          const response = await fetch(`/api/doctor/articles/${id}`);
          const article = await response.json();

          document.getElementById("articleId").value = article.id;
          document.getElementById("articleTitle").value = article.title;
          document.getElementById("articleSummary").value =
            article.summary || "";
          document.getElementById("articleCategory").value =
            article.categoryId || "";
          document.getElementById("articleStatus").value = article.status;
          document.getElementById("articleFeatured").checked = article.featured;

          quill.root.innerHTML = article.content;
          articleTags = article.tags || [];
          renderTags();
        } catch (error) {
          console.error("Error loading article:", error);
          alert("Lỗi tải bài viết");
        }
      }

      // Submit article form
      document
        .getElementById("articleForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const id = document.getElementById("articleId").value;
          const title = document.getElementById("articleTitle").value;
          const summary = document.getElementById("articleSummary").value;
          const content = quill.root.innerHTML;
          const categoryId =
            document.getElementById("articleCategory").value || null;
          const status = document.getElementById("articleStatus").value;
          const featured = document.getElementById("articleFeatured").checked;

          const data = {
            title,
            summary,
            content,
            categoryId: categoryId ? parseInt(categoryId) : null,
            tags: articleTags,
            status,
            featured,
          };

          try {
            const url = id
              ? `/api/doctor/articles/${id}`
              : "/api/doctor/articles";
            const method = id ? "PUT" : "POST";

            const response = await fetch(url, {
              method,
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (result.success) {
              alert(result.message);
              closeArticleModal();
              loadArticles();
              loadStatistics();
            } else {
              alert(result.message);
            }
          } catch (error) {
            console.error("Error saving article:", error);
            alert("Lỗi lưu bài viết");
          }
        });

      // View article (read-only)
      async function viewArticle(id) {
        try {
          const response = await fetch(`/api/doctor/articles/${id}`);
          const article = await response.json();

          alert(
            `Tiêu đề: ${article.title}\n\nTóm tắt: ${article.summary || "Không có"}\n\nLượt xem: ${article.views}\n\n(Chức năng xem chi tiết đầy đủ sẽ được phát triển thêm)`,
          );
        } catch (error) {
          console.error("Error viewing article:", error);
        }
      }

      // Edit article
      function editArticle(id) {
        openArticleModal(id);
      }

      // Delete article
      async function deleteArticle(id) {
        if (!confirm("Bạn có chắc chắn muốn xóa bài viết này?")) return;

        try {
          const response = await fetch(`/api/doctor/articles/${id}`, {
            method: "DELETE",
          });
          const result = await response.json();

          if (result.success) {
            alert(result.message);
            loadArticles();
            loadStatistics();
          } else {
            alert(result.message);
          }
        } catch (error) {
          console.error("Error deleting article:", error);
          alert("Lỗi xóa bài viết");
        }
      }

      // Tags management
      function handleTagInput(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          const input = event.target;
          const tag = input.value.trim();

          if (tag && !articleTags.includes(tag)) {
            articleTags.push(tag);
            renderTags();
            input.value = "";
          }
        }
      }

      function removeTag(tag) {
        articleTags = articleTags.filter((t) => t !== tag);
        renderTags();
      }

      function renderTags() {
        const container = document.getElementById("tagsContainer");
        container.innerHTML = "";

        articleTags.forEach((tag) => {
          const badge = document.createElement("span");
          badge.className = "tag-badge";
          badge.innerHTML = `
            ${tag}
            <span class="tag-remove" onclick="removeTag('${tag}')">×</span>
          `;
          container.appendChild(badge);
        });
      }

      // Category Modal
      function openCategoryModal() {
        document.getElementById("categoryModal").classList.remove("hidden");
      }

      function closeCategoryModal() {
        document.getElementById("categoryModal").classList.add("hidden");
        document.getElementById("categoryForm").reset();
      }

      // Submit category form
      document
        .getElementById("categoryForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const name = document.getElementById("categoryName").value;
          const description = document.getElementById(
            "categoryDescription",
          ).value;
          const parentId =
            document.getElementById("categoryParent").value || null;

          const data = {
            name,
            description,
            parentId: parentId ? parseInt(parentId) : null,
            displayOrder: 0,
          };

          try {
            const response = await fetch("/api/doctor/categories", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (result.success) {
              alert(result.message);
              closeCategoryModal();
              loadCategories();
            } else {
              alert(result.message);
            }
          } catch (error) {
            console.error("Error creating category:", error);
            alert("Lỗi tạo danh mục");
          }
        });

      // Helper functions
      function getStatusText(status) {
        const statusMap = {
          PUBLISHED: "Đã xuất bản",
          DRAFT: "Bản nháp",
          ARCHIVED: "Đã lưu trữ",
        };
        return statusMap[status] || status;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("vi-VN");
      }
    </script>
  </body>
</html>
