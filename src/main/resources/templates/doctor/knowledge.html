<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kho Tri Thức Y Khoa - ABClinic</title>

    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" th:href="@{/images/Logo.jpg}" />
    <link rel="shortcut icon" type="image/jpeg" th:href="@{/images/Logo.jpg}" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script th:src="@{/js/config/tailwind-config.js}"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap"
    />
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
      .material-symbols-outlined.fill {
        font-variation-settings: "FILL" 1;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-slate-100 font-sans"
  >
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside th:replace="~{fragments/doctor-layout :: doctor-sidebar}"></aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Header -->
        <header
          class="bg-white dark:bg-[#1a2634] border-b border-slate-200 dark:border-slate-800 px-6 py-4"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <button
                onclick="toggleSidebar()"
                class="lg:hidden p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
              >
                <span class="material-symbols-outlined">menu</span>
              </button>
              <div>
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">
                  Kho Tri Thức Y Khoa
                </h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Quản lý và tìm kiếm tài liệu y khoa
                </p>
              </div>
            </div>
            <button
              onclick="openCreateModal()"
              class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors"
            >
              <span class="material-symbols-outlined text-[20px]">add</span>
              <span class="hidden sm:inline">Thêm tài liệu</span>
            </button>
          </div>
        </header>

        <!-- Search & Filters -->
        <div
          class="bg-white dark:bg-[#1a2634] border-b border-slate-200 dark:border-slate-800 px-6 py-4"
        >
          <div class="flex flex-wrap items-center gap-4">
            <!-- Search Bar -->
            <div class="flex-1 min-w-[300px] relative">
              <span
                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
                >search</span
              >
              <input
                type="text"
                id="searchInput"
                placeholder="Tìm kiếm theo tiêu đề, nội dung, tags..."
                onkeyup="debounceSearch()"
                class="w-full pl-10 pr-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              />
            </div>

            <!-- Category Filter -->
            <select
              id="categoryFilter"
              onchange="loadArticles()"
              class="px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary min-w-[180px]"
            >
              <option value="">Tất cả danh mục</option>
            </select>

            <!-- Status Filter -->
            <select
              id="statusFilter"
              onchange="loadArticles()"
              class="px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
            >
              <option value="">Tất cả trạng thái</option>
              <option value="PUBLISHED">Đã xuất bản</option>
              <option value="DRAFT">Bản nháp</option>
              <option value="ARCHIVED">Đã lưu trữ</option>
            </select>
          </div>

          <!-- Popular Tags -->
          <div id="popularTags" class="mt-3 flex flex-wrap gap-2">
            <!-- Tags will be loaded here -->
          </div>
        </div>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-6">
          <!-- Statistics Cards -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-blue-600 dark:text-blue-400"
                    >article</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="totalArticles"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Tổng bài viết</p>
                </div>
              </div>
            </div>
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-green-600 dark:text-green-400"
                    >publish</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="publishedArticles"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Đã xuất bản</p>
                </div>
              </div>
            </div>
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-amber-600 dark:text-amber-400"
                    >edit_note</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="draftArticles"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Bản nháp</p>
                </div>
              </div>
            </div>
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-purple-600 dark:text-purple-400"
                    >category</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="totalCategories"
                  >
                    0
                  </p>
                  <p class="text-xs text-slate-500">Danh mục</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Articles Grid -->
          <div
            id="articlesGrid"
            class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"
          >
            <!-- Articles will be loaded here -->
            <div class="col-span-full text-center py-12">
              <span
                class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600"
                >library_books</span
              >
              <p class="text-slate-500 dark:text-slate-400 mt-4">
                Đang tải dữ liệu...
              </p>
            </div>
          </div>

          <!-- Pagination -->
          <div
            id="pagination"
            class="mt-6 flex items-center justify-center gap-2"
          >
            <!-- Pagination will be loaded here -->
          </div>
        </main>
      </div>
    </div>

    <!-- Create/Edit Modal -->
    <div
      id="articleModal"
      class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-[#1a2634] rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h3
            id="modalTitle"
            class="text-lg font-semibold text-slate-900 dark:text-white"
          >
            Thêm bài viết mới
          </h3>
          <button
            onclick="closeModal()"
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <form
          id="articleForm"
          onsubmit="saveArticle(event)"
          class="flex-1 overflow-y-auto p-6"
        >
          <input type="hidden" id="articleId" />

          <div class="space-y-4">
            <!-- Title -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >
                Tiêu đề *
              </label>
              <input
                type="text"
                id="articleTitle"
                required
                placeholder="Nhập tiêu đề bài viết"
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              />
            </div>

            <!-- Category -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >
                Danh mục
              </label>
              <select
                id="articleCategory"
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              >
                <option value="">-- Chọn danh mục --</option>
              </select>
            </div>

            <!-- Summary -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >
                Tóm tắt
              </label>
              <textarea
                id="articleSummary"
                rows="2"
                placeholder="Mô tả ngắn gọn nội dung bài viết"
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary resize-none"
              ></textarea>
            </div>

            <!-- Content -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >
                Nội dung *
              </label>
              <textarea
                id="articleContent"
                rows="10"
                required
                placeholder="Nhập nội dung chi tiết bài viết..."
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary resize-none"
              ></textarea>
            </div>

            <!-- Tags -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >
                Tags (phân cách bằng dấu phẩy)
              </label>
              <input
                type="text"
                id="articleTags"
                placeholder="VD: tim mạch, huyết áp, tiểu đường"
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              />
            </div>

            <!-- Status & Featured -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                >
                  Trạng thái
                </label>
                <select
                  id="articleStatus"
                  class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                >
                  <option value="DRAFT">Bản nháp</option>
                  <option value="PUBLISHED">Xuất bản</option>
                  <option value="ARCHIVED">Lưu trữ</option>
                </select>
              </div>
              <div class="flex items-center">
                <label class="flex items-center gap-3 cursor-pointer mt-6">
                  <input
                    type="checkbox"
                    id="articleFeatured"
                    class="w-5 h-5 rounded text-primary focus:ring-primary"
                  />
                  <span class="text-sm text-slate-700 dark:text-slate-300"
                    >Đánh dấu nổi bật</span
                  >
                </label>
              </div>
            </div>
          </div>
        </form>

        <div
          class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
        >
          <button
            onclick="closeModal()"
            class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
          >
            Hủy
          </button>
          <button
            type="submit"
            form="articleForm"
            class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors"
          >
            Lưu bài viết
          </button>
        </div>
      </div>
    </div>

    <!-- View Article Modal -->
    <div
      id="viewModal"
      class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-[#1a2634] rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <div class="flex items-center gap-3">
            <span
              id="viewCategory"
              class="px-2 py-1 bg-primary/10 text-primary text-xs rounded-full"
            ></span>
            <span id="viewStatus" class="px-2 py-1 text-xs rounded-full"></span>
          </div>
          <div class="flex items-center gap-2">
            <button
              onclick="editCurrentArticle()"
              class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
              title="Chỉnh sửa"
            >
              <span class="material-symbols-outlined">edit</span>
            </button>
            <button
              onclick="closeViewModal()"
              class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
            >
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
          <h2
            id="viewTitle"
            class="text-2xl font-bold text-slate-900 dark:text-white mb-4"
          ></h2>

          <div
            class="flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400 mb-6"
          >
            <span class="flex items-center gap-1">
              <span class="material-symbols-outlined text-[18px]">person</span>
              <span id="viewAuthor"></span>
            </span>
            <span class="flex items-center gap-1">
              <span class="material-symbols-outlined text-[18px]"
                >calendar_today</span
              >
              <span id="viewDate"></span>
            </span>
            <span class="flex items-center gap-1">
              <span class="material-symbols-outlined text-[18px]"
                >visibility</span
              >
              <span id="viewViews"></span> lượt xem
            </span>
          </div>

          <div id="viewTags" class="flex flex-wrap gap-2 mb-6"></div>

          <div
            id="viewSummary"
            class="p-4 bg-slate-100 dark:bg-slate-800 rounded-lg mb-6 text-slate-700 dark:text-slate-300 italic"
          ></div>

          <div
            id="viewContent"
            class="prose dark:prose-invert max-w-none text-slate-700 dark:text-slate-300 whitespace-pre-wrap"
          ></div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-4 right-4 z-50 space-y-2"
    ></div>

    <!-- Scripts -->
    <script th:src="@{/js/modules/doctor/sidebar-controller.js}"></script>
    <script>
      // Global state
      let articles = [];
      let categories = [];
      let currentPage = 0;
      let totalPages = 0;
      let currentArticle = null;
      let searchTimeout = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadCategories();
        loadStatistics();
        loadArticles();
        loadPopularTags();
      });

      // Load categories
      async function loadCategories() {
        try {
          const response = await fetch("/api/doctor/knowledge/categories");
          if (!response.ok) throw new Error("Failed to load categories");

          categories = await response.json();
          populateCategorySelects();
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // Populate category selects
      function populateCategorySelects() {
        const filterSelect = document.getElementById("categoryFilter");
        const formSelect = document.getElementById("articleCategory");

        const options = categories
          .map((c) => `<option value="${c.id}">${c.name}</option>`)
          .join("");

        filterSelect.innerHTML =
          '<option value="">Tất cả danh mục</option>' + options;
        formSelect.innerHTML =
          '<option value="">-- Chọn danh mục --</option>' + options;
      }

      // Load statistics
      async function loadStatistics() {
        try {
          const response = await fetch("/api/doctor/knowledge/statistics");
          if (!response.ok) throw new Error("Failed to load statistics");

          const stats = await response.json();
          document.getElementById("totalArticles").textContent =
            stats.total || 0;
          document.getElementById("publishedArticles").textContent =
            stats.published || 0;
          document.getElementById("draftArticles").textContent =
            stats.draft || 0;
          document.getElementById("totalCategories").textContent =
            stats.categories || 0;
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // Load popular tags
      async function loadPopularTags() {
        try {
          const response = await fetch("/api/doctor/knowledge/tags");
          if (!response.ok) throw new Error("Failed to load tags");

          const tags = await response.json();
          const container = document.getElementById("popularTags");

          if (tags.length === 0) {
            container.innerHTML = "";
            return;
          }

          container.innerHTML =
            '<span class="text-xs text-slate-500 dark:text-slate-400 mr-2">Tags phổ biến:</span>' +
            tags
              .slice(0, 10)
              .map(
                (tag) => `
              <button onclick="searchByTag('${tag}')" 
                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 hover:bg-primary/10 hover:text-primary text-xs rounded-full transition-colors">
                #${tag}
              </button>
            `,
              )
              .join("");
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // Search by tag
      function searchByTag(tag) {
        document.getElementById("searchInput").value = tag;
        loadArticles();
      }

      // Debounced search
      function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => loadArticles(), 300);
      }

      // Load articles
      async function loadArticles(page = 0) {
        const keyword = document.getElementById("searchInput").value;
        const categoryId = document.getElementById("categoryFilter").value;
        const status = document.getElementById("statusFilter").value;

        const params = new URLSearchParams({
          page: page,
          size: 12,
          ...(keyword && { keyword }),
          ...(categoryId && { categoryId }),
          ...(status && { status }),
        });

        try {
          const response = await fetch(
            `/api/doctor/knowledge/articles?${params}`,
          );
          if (!response.ok) throw new Error("Failed to load articles");

          const data = await response.json();
          articles = data.content || [];
          currentPage = data.number || 0;
          totalPages = data.totalPages || 0;

          renderArticles();
          renderPagination();
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("articlesGrid").innerHTML = `
            <div class="col-span-full text-center py-12">
              <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600">error</span>
              <p class="text-slate-500 dark:text-slate-400 mt-4">Không thể tải dữ liệu</p>
            </div>
          `;
        }
      }

      // Render articles grid
      function renderArticles() {
        const container = document.getElementById("articlesGrid");

        if (articles.length === 0) {
          container.innerHTML = `
            <div class="col-span-full text-center py-12">
              <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600">library_books</span>
              <p class="text-slate-500 dark:text-slate-400 mt-4">Không có bài viết nào</p>
              <button onclick="openCreateModal()" class="mt-4 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg">
                Tạo bài viết đầu tiên
              </button>
            </div>
          `;
          return;
        }

        container.innerHTML = articles
          .map(
            (article) => `
          <div class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden hover:shadow-lg transition-shadow cursor-pointer"
               onclick="viewArticle(${article.id})">
            <div class="p-5">
              <div class="flex items-center justify-between mb-3">
                <span class="px-2 py-1 ${getStatusBg(article.status)} text-xs rounded-full">${getStatusName(article.status)}</span>
                ${article.featured ? '<span class="material-symbols-outlined fill text-amber-500 text-[18px]">star</span>' : ""}
              </div>
              <h3 class="font-semibold text-slate-900 dark:text-white mb-2 line-clamp-2">${article.title}</h3>
              <p class="text-sm text-slate-500 dark:text-slate-400 line-clamp-3 mb-3">${article.summary || ""}</p>
              
              <div class="flex flex-wrap gap-1 mb-3">
                ${(article.tags || "")
                  .split(",")
                  .filter((t) => t.trim())
                  .slice(0, 3)
                  .map(
                    (tag) =>
                      `<span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 text-xs rounded">#${tag.trim()}</span>`,
                  )
                  .join("")}
              </div>

              <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
                <span class="flex items-center gap-1">
                  <span class="material-symbols-outlined text-[16px]">visibility</span>
                  ${article.views || 0}
                </span>
                <span>${formatDate(article.createdAt)}</span>
              </div>
            </div>
            
            <div class="px-5 py-3 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-2">
              <button onclick="event.stopPropagation(); editArticle(${article.id})" 
                class="p-1.5 hover:bg-slate-200 dark:hover:bg-slate-700 rounded text-slate-600 dark:text-slate-400" title="Sửa">
                <span class="material-symbols-outlined text-[18px]">edit</span>
              </button>
              <button onclick="event.stopPropagation(); deleteArticle(${article.id})" 
                class="p-1.5 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-600" title="Xóa">
                <span class="material-symbols-outlined text-[18px]">delete</span>
              </button>
            </div>
          </div>
        `,
          )
          .join("");
      }

      // Render pagination
      function renderPagination() {
        const container = document.getElementById("pagination");

        if (totalPages <= 1) {
          container.innerHTML = "";
          return;
        }

        let html = "";

        // Previous
        html += `<button onclick="loadArticles(${currentPage - 1})" 
          ${currentPage === 0 ? "disabled" : ""} 
          class="p-2 rounded-lg ${currentPage === 0 ? "text-slate-300 dark:text-slate-600 cursor-not-allowed" : "hover:bg-slate-100 dark:hover:bg-slate-800"}">
          <span class="material-symbols-outlined">chevron_left</span>
        </button>`;

        // Page numbers
        for (let i = 0; i < totalPages; i++) {
          if (
            i === 0 ||
            i === totalPages - 1 ||
            (i >= currentPage - 1 && i <= currentPage + 1)
          ) {
            html += `<button onclick="loadArticles(${i})" 
              class="w-10 h-10 rounded-lg ${i === currentPage ? "bg-primary text-white" : "hover:bg-slate-100 dark:hover:bg-slate-800"}">
              ${i + 1}
            </button>`;
          } else if (i === currentPage - 2 || i === currentPage + 2) {
            html += '<span class="px-2">...</span>';
          }
        }

        // Next
        html += `<button onclick="loadArticles(${currentPage + 1})" 
          ${currentPage >= totalPages - 1 ? "disabled" : ""} 
          class="p-2 rounded-lg ${currentPage >= totalPages - 1 ? "text-slate-300 dark:text-slate-600 cursor-not-allowed" : "hover:bg-slate-100 dark:hover:bg-slate-800"}">
          <span class="material-symbols-outlined">chevron_right</span>
        </button>`;

        container.innerHTML = html;
      }

      // View article
      async function viewArticle(id) {
        try {
          const response = await fetch(`/api/doctor/knowledge/articles/${id}`);
          if (!response.ok) throw new Error("Failed to load article");

          currentArticle = await response.json();

          document.getElementById("viewTitle").textContent =
            currentArticle.title;
          document.getElementById("viewCategory").textContent =
            currentArticle.categoryName || "Chưa phân loại";
          document.getElementById("viewStatus").textContent = getStatusName(
            currentArticle.status,
          );
          document.getElementById("viewStatus").className =
            `px-2 py-1 text-xs rounded-full ${getStatusBg(currentArticle.status)}`;
          document.getElementById("viewAuthor").textContent =
            currentArticle.createdByName || "N/A";
          document.getElementById("viewDate").textContent = formatDate(
            currentArticle.createdAt,
          );
          document.getElementById("viewViews").textContent =
            currentArticle.views || 0;
          document.getElementById("viewSummary").textContent =
            currentArticle.summary || "";
          document
            .getElementById("viewSummary")
            .classList.toggle("hidden", !currentArticle.summary);
          document.getElementById("viewContent").textContent =
            currentArticle.content;

          // Tags
          const tags = (currentArticle.tags || "")
            .split(",")
            .filter((t) => t.trim());
          document.getElementById("viewTags").innerHTML = tags
            .map(
              (tag) =>
                `<span class="px-2 py-1 bg-slate-100 dark:bg-slate-800 text-sm rounded-full">#${tag.trim()}</span>`,
            )
            .join("");

          document.getElementById("viewModal").classList.remove("hidden");
          document.getElementById("viewModal").classList.add("flex");
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể tải bài viết", "error");
        }
      }

      // Close view modal
      function closeViewModal() {
        document.getElementById("viewModal").classList.add("hidden");
        document.getElementById("viewModal").classList.remove("flex");
        currentArticle = null;
      }

      // Edit current article from view modal
      function editCurrentArticle() {
        if (currentArticle) {
          closeViewModal();
          editArticle(currentArticle.id);
        }
      }

      // Open create modal
      function openCreateModal() {
        document.getElementById("modalTitle").textContent = "Thêm bài viết mới";
        document.getElementById("articleForm").reset();
        document.getElementById("articleId").value = "";
        document.getElementById("articleModal").classList.remove("hidden");
        document.getElementById("articleModal").classList.add("flex");
      }

      // Edit article
      async function editArticle(id) {
        try {
          const response = await fetch(`/api/doctor/knowledge/articles/${id}`);
          if (!response.ok) throw new Error("Failed to load article");

          const article = await response.json();

          document.getElementById("modalTitle").textContent =
            "Chỉnh sửa bài viết";
          document.getElementById("articleId").value = article.id;
          document.getElementById("articleTitle").value = article.title;
          document.getElementById("articleCategory").value =
            article.categoryId || "";
          document.getElementById("articleSummary").value =
            article.summary || "";
          document.getElementById("articleContent").value = article.content;
          document.getElementById("articleTags").value = article.tags || "";
          document.getElementById("articleStatus").value = article.status;
          document.getElementById("articleFeatured").checked =
            article.featured || false;

          document.getElementById("articleModal").classList.remove("hidden");
          document.getElementById("articleModal").classList.add("flex");
        } catch (error) {
          console.error("Error:", error);
          showToast("Không thể tải bài viết", "error");
        }
      }

      // Close modal
      function closeModal() {
        document.getElementById("articleModal").classList.add("hidden");
        document.getElementById("articleModal").classList.remove("flex");
      }

      // Save article
      async function saveArticle(event) {
        event.preventDefault();

        const id = document.getElementById("articleId").value;
        const data = {
          title: document.getElementById("articleTitle").value,
          categoryId: document.getElementById("articleCategory").value || null,
          summary: document.getElementById("articleSummary").value,
          content: document.getElementById("articleContent").value,
          tags: document.getElementById("articleTags").value,
          status: document.getElementById("articleStatus").value,
          featured: document.getElementById("articleFeatured").checked,
        };

        try {
          const url = id
            ? `/api/doctor/knowledge/articles/${id}`
            : "/api/doctor/knowledge/articles";
          const method = id ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) throw new Error("Failed to save article");

          showToast(
            id ? "Cập nhật thành công" : "Tạo bài viết thành công",
            "success",
          );
          closeModal();
          loadArticles(currentPage);
          loadStatistics();
          loadPopularTags();
        } catch (error) {
          console.error("Error:", error);
          showToast("Lỗi khi lưu bài viết", "error");
        }
      }

      // Delete article
      async function deleteArticle(id) {
        if (!confirm("Bạn có chắc muốn xóa bài viết này?")) return;

        try {
          const response = await fetch(`/api/doctor/knowledge/articles/${id}`, {
            method: "DELETE",
          });

          if (!response.ok) throw new Error("Failed to delete article");

          showToast("Xóa bài viết thành công", "success");
          loadArticles(currentPage);
          loadStatistics();
        } catch (error) {
          console.error("Error:", error);
          showToast("Lỗi khi xóa bài viết", "error");
        }
      }

      // Helpers
      function getStatusBg(status) {
        const map = {
          PUBLISHED:
            "bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400",
          DRAFT:
            "bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400",
          ARCHIVED:
            "bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400",
        };
        return map[status] || map.DRAFT;
      }

      function getStatusName(status) {
        const map = {
          PUBLISHED: "Đã xuất bản",
          DRAFT: "Bản nháp",
          ARCHIVED: "Lưu trữ",
        };
        return map[status] || status;
      }

      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleDateString("vi-VN");
      }

      function showToast(message, type = "info") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");

        const colors = {
          success: "bg-green-500",
          error: "bg-red-500",
          info: "bg-blue-500",
          warning: "bg-amber-500",
        };

        const icons = {
          success: "check_circle",
          error: "error",
          info: "info",
          warning: "warning",
        };

        toast.className = `flex items-center gap-3 px-4 py-3 ${colors[type]} text-white rounded-lg shadow-lg min-w-[300px]`;
        toast.innerHTML = `
          <span class="material-symbols-outlined">${icons[type]}</span>
          <span class="flex-1">${message}</span>
          <button onclick="this.parentElement.remove()" class="p-1 hover:bg-white/20 rounded">
            <span class="material-symbols-outlined text-[18px]">close</span>
          </button>
        `;

        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    </script>
  </body>
</html>
