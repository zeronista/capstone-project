<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D·ª± B√°o S·ª©c Kh·ªèe - ABClinic</title>
    <!-- Theme Controller - MUST be first to prevent flash -->
    <script th:src="@{/js/core/theme-controller.js}"></script>

    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" th:href="@{/images/Logo.jpg}" />
    <link rel="shortcut icon" type="image/jpeg" th:href="@{/images/Logo.jpg}" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script th:src="@{/js/config/tailwind-config.js}"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap"
    />
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
      .material-symbols-outlined.fill {
        font-variation-settings: "FILL" 1;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }
      .tab-active {
        border-bottom: 2px solid var(--color-primary, #3b82f6);
        color: var(--color-primary, #3b82f6);
      }
      .risk-meter {
        background: linear-gradient(
          90deg,
          #22c55e 0%,
          #eab308 50%,
          #ef4444 100%
        );
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-slate-100 font-sans"
  >
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside th:replace="~{fragments/doctor-layout :: doctor-sidebar}"></aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Header -->
        <header
          class="bg-white dark:bg-[#1a2634] border-b border-slate-200 dark:border-slate-800 px-6 py-4"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <button
                onclick="toggleSidebar()"
                class="lg:hidden p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
              >
                <span class="material-symbols-outlined">menu</span>
              </button>
              <div>
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">
                  D·ª± B√°o S·ª©c Kh·ªèe
                </h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Ph√¢n t√≠ch v√† d·ª± b√°o r·ªßi ro s·ª©c kh·ªèe b·ªánh nh√¢n
                </p>
              </div>
            </div>
          </div>
        </header>

        <!-- Tabs -->
        <div
          class="bg-white dark:bg-[#1a2634] border-b border-slate-200 dark:border-slate-800 px-6"
        >
          <div class="flex items-center gap-6">
            <button
              onclick="switchTab('medical-reports')"
              id="tab-medical-reports"
              class="py-4 px-2 text-sm font-medium border-b-2 border-transparent hover:text-primary transition-colors tab-active"
            >
              <span class="flex items-center gap-2">
                <span class="material-symbols-outlined text-[20px]"
                  >description</span
                >
                B√°o C√°o Y T·∫ø
              </span>
            </button>
            <button
              onclick="switchTab('family-history')"
              id="tab-family-history"
              class="py-4 px-2 text-sm font-medium border-b-2 border-transparent hover:text-primary transition-colors text-slate-600 dark:text-slate-400"
            >
              <span class="flex items-center gap-2">
                <span class="material-symbols-outlined text-[20px]"
                  >family_restroom</span
                >
                Ti·ªÅn S·ª≠ Gia ƒê√¨nh
              </span>
            </button>
            <button
              onclick="switchTab('health-forecast')"
              id="tab-health-forecast"
              class="py-4 px-2 text-sm font-medium border-b-2 border-transparent hover:text-primary transition-colors text-slate-600 dark:text-slate-400"
            >
              <span class="flex items-center gap-2">
                <span class="material-symbols-outlined text-[20px]"
                  >monitoring</span
                >
                D·ª± B√°o S·ª©c Kh·ªèe
              </span>
            </button>
          </div>
        </div>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-6">
          <!-- Patient Selection -->
          <div
            class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4 mb-6"
          >
            <div class="flex flex-wrap items-center gap-4">
              <div class="flex-1 min-w-[250px]">
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >
                  Ch·ªçn b·ªánh nh√¢n
                </label>
                <select
                  id="patientSelect"
                  onchange="loadPatientData()"
                  class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                >
                  <option value="">-- Ch·ªçn b·ªánh nh√¢n --</option>
                </select>
              </div>
              <div id="patientInfo" class="hidden flex items-center gap-4">
                <div
                  class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center"
                >
                  <span class="material-symbols-outlined text-primary"
                    >person</span
                  >
                </div>
                <div>
                  <p
                    class="font-medium text-slate-900 dark:text-white"
                    id="selectedPatientName"
                  >
                    -
                  </p>
                  <p
                    class="text-sm text-slate-500 dark:text-slate-400"
                    id="selectedPatientInfo"
                  >
                    -
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab: Medical Reports -->
          <div id="content-medical-reports" class="tab-content">
            <div class="grid lg:grid-cols-3 gap-6">
              <!-- Form nh·∫≠p b√°o c√°o -->
              <div class="lg:col-span-1">
                <div
                  class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-6"
                >
                  <h3
                    class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined text-primary"
                      >add_circle</span
                    >
                    Nh·∫≠p B√°o C√°o Y T·∫ø
                  </h3>
                  <form
                    id="medicalReportForm"
                    onsubmit="saveMedicalReport(event)"
                  >
                    <div class="space-y-4">
                      <!-- Report Type -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          Lo·∫°i b√°o c√°o *
                        </label>
                        <select
                          id="reportType"
                          required
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                        >
                          <option value="">Ch·ªçn lo·∫°i</option>
                          <option value="LAB_TEST">X√©t nghi·ªám</option>
                          <option value="IMAGING">Ch·∫©n ƒëo√°n h√¨nh ·∫£nh</option>
                          <option value="PATHOLOGY">Gi·∫£i ph·∫´u b·ªánh</option>
                          <option value="VITAL_SIGNS">Ch·ªâ s·ªë sinh t·ªìn</option>
                          <option value="CONSULTATION">Kh√°m b·ªánh</option>
                          <option value="OTHER">Kh√°c</option>
                        </select>
                      </div>

                      <!-- Report Date -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          Ng√†y b√°o c√°o *
                        </label>
                        <input
                          type="date"
                          id="reportDate"
                          required
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                        />
                      </div>

                      <!-- Title -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          Ti√™u ƒë·ªÅ *
                        </label>
                        <input
                          type="text"
                          id="reportTitle"
                          required
                          placeholder="VD: X√©t nghi·ªám m√°u ƒë·ªãnh k·ª≥"
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                        />
                      </div>

                      <!-- Content -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          N·ªôi dung *
                        </label>
                        <textarea
                          id="reportContent"
                          rows="4"
                          required
                          placeholder="Nh·∫≠p k·∫øt qu·∫£ x√©t nghi·ªám, ch·∫©n ƒëo√°n..."
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary resize-none"
                        ></textarea>
                      </div>

                      <!-- Notes -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          Ghi ch√∫ b√°c sƒ©
                        </label>
                        <textarea
                          id="reportNotes"
                          rows="2"
                          placeholder="Nh·∫≠n x√©t, l∆∞u √Ω ƒë·∫∑c bi·ªát..."
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary resize-none"
                        ></textarea>
                      </div>

                      <button
                        type="submit"
                        class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors"
                      >
                        <span class="material-symbols-outlined text-[20px]"
                          >save</span
                        >
                        L∆∞u b√°o c√°o
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Danh s√°ch b√°o c√°o -->
              <div class="lg:col-span-2">
                <div
                  class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-6"
                >
                  <div class="flex items-center justify-between mb-4">
                    <h3
                      class="font-semibold text-slate-900 dark:text-white flex items-center gap-2"
                    >
                      <span class="material-symbols-outlined text-primary"
                        >folder_open</span
                      >
                      L·ªãch S·ª≠ B√°o C√°o
                    </h3>
                    <select
                      id="reportFilterType"
                      onchange="filterReports()"
                      class="px-3 py-1.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg text-sm"
                    >
                      <option value="">T·∫•t c·∫£ lo·∫°i</option>
                      <option value="LAB_TEST">X√©t nghi·ªám</option>
                      <option value="IMAGING">Ch·∫©n ƒëo√°n h√¨nh ·∫£nh</option>
                      <option value="VITAL_SIGNS">Ch·ªâ s·ªë sinh t·ªìn</option>
                    </select>
                  </div>

                  <div id="medicalReportsList" class="space-y-3">
                    <div class="text-center py-8">
                      <span
                        class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600"
                        >description</span
                      >
                      <p class="text-slate-500 dark:text-slate-400 mt-2">
                        Ch·ªçn b·ªánh nh√¢n ƒë·ªÉ xem b√°o c√°o
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab: Family History -->
          <div id="content-family-history" class="tab-content hidden">
            <div class="grid lg:grid-cols-3 gap-6">
              <!-- Form nh·∫≠p ti·ªÅn s·ª≠ -->
              <div class="lg:col-span-1">
                <div
                  class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-6"
                >
                  <h3
                    class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined text-primary"
                      >add_circle</span
                    >
                    Nh·∫≠p Ti·ªÅn S·ª≠ Gia ƒê√¨nh
                  </h3>
                  <form
                    id="familyHistoryForm"
                    onsubmit="saveFamilyHistory(event)"
                  >
                    <div class="space-y-4">
                      <!-- Relationship -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          Quan h·ªá *
                        </label>
                        <select
                          id="relationship"
                          required
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                        >
                          <option value="">Ch·ªçn quan h·ªá</option>
                          <option value="FATHER">Cha</option>
                          <option value="MOTHER">M·∫π</option>
                          <option value="GRANDFATHER_P">√îng n·ªôi</option>
                          <option value="GRANDMOTHER_P">B√† n·ªôi</option>
                          <option value="GRANDFATHER_M">√îng ngo·∫°i</option>
                          <option value="GRANDMOTHER_M">B√† ngo·∫°i</option>
                          <option value="SIBLING">Anh/Ch·ªã/Em ru·ªôt</option>
                          <option value="UNCLE_AUNT">C√¥/D√¨/Ch√∫/B√°c</option>
                          <option value="OTHER">Kh√°c</option>
                        </select>
                      </div>

                      <!-- Condition -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          B·ªánh l√Ω *
                        </label>
                        <select
                          id="familyCondition"
                          required
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                        >
                          <option value="">Ch·ªçn b·ªánh l√Ω</option>
                          <option value="DIABETES">Ti·ªÉu ƒë∆∞·ªùng</option>
                          <option value="HYPERTENSION">Cao huy·∫øt √°p</option>
                          <option value="HEART_DISEASE">B·ªánh tim</option>
                          <option value="STROKE">ƒê·ªôt qu·ªµ</option>
                          <option value="CANCER">Ung th∆∞</option>
                          <option value="ASTHMA">Hen suy·ªÖn</option>
                          <option value="ARTHRITIS">Vi√™m kh·ªõp</option>
                          <option value="ALZHEIMER">Alzheimer</option>
                          <option value="KIDNEY_DISEASE">B·ªánh th·∫≠n</option>
                          <option value="LIVER_DISEASE">B·ªánh gan</option>
                          <option value="OTHER">Kh√°c</option>
                        </select>
                      </div>

                      <!-- Custom Condition -->
                      <div id="customConditionWrapper" class="hidden">
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          T√™n b·ªánh c·ª• th·ªÉ
                        </label>
                        <input
                          type="text"
                          id="customCondition"
                          placeholder="Nh·∫≠p t√™n b·ªánh..."
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                        />
                      </div>

                      <!-- Age at Diagnosis -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          Tu·ªïi khi ph√°t hi·ªán
                        </label>
                        <input
                          type="number"
                          id="ageAtDiagnosis"
                          min="0"
                          max="120"
                          placeholder="VD: 55"
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                        />
                      </div>

                      <!-- Status -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          T√¨nh tr·∫°ng
                        </label>
                        <select
                          id="familyMemberStatus"
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                        >
                          <option value="ALIVE">C√≤n s·ªëng</option>
                          <option value="DECEASED">ƒê√£ m·∫•t</option>
                          <option value="UNKNOWN">Kh√¥ng r√µ</option>
                        </select>
                      </div>

                      <!-- Notes -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                        >
                          Ghi ch√∫
                        </label>
                        <textarea
                          id="familyNotes"
                          rows="2"
                          placeholder="Th√¥ng tin b·ªï sung..."
                          class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary resize-none"
                        ></textarea>
                      </div>

                      <button
                        type="submit"
                        class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors"
                      >
                        <span class="material-symbols-outlined text-[20px]"
                          >save</span
                        >
                        L∆∞u ti·ªÅn s·ª≠
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Family tree / History list -->
              <div class="lg:col-span-2">
                <div
                  class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-6"
                >
                  <h3
                    class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined text-primary"
                      >account_tree</span
                    >
                    S∆° ƒê·ªì Ti·ªÅn S·ª≠ Gia ƒê√¨nh
                  </h3>

                  <div id="familyHistoryList" class="space-y-4">
                    <div class="text-center py-8">
                      <span
                        class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600"
                        >family_restroom</span
                      >
                      <p class="text-slate-500 dark:text-slate-400 mt-2">
                        Ch·ªçn b·ªánh nh√¢n ƒë·ªÉ xem ti·ªÅn s·ª≠ gia ƒë√¨nh
                      </p>
                    </div>
                  </div>

                  <!-- Risk Summary -->
                  <div
                    id="familyRiskSummary"
                    class="hidden mt-6 p-4 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-200 dark:border-amber-800"
                  >
                    <h4
                      class="font-medium text-amber-800 dark:text-amber-300 mb-2 flex items-center gap-2"
                    >
                      <span class="material-symbols-outlined text-[20px]"
                        >warning</span
                      >
                      Y·∫øu T·ªë Nguy C∆° Di Truy·ªÅn
                    </h4>
                    <div
                      id="familyRiskContent"
                      class="text-sm text-amber-700 dark:text-amber-400"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab: Health Forecast -->
          <div id="content-health-forecast" class="tab-content hidden">
            <div class="grid lg:grid-cols-3 gap-6">
              <!-- Generate Forecast -->
              <div class="lg:col-span-1 space-y-6">
                <!-- Generate Button -->
                <div
                  class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-6"
                >
                  <h3
                    class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined text-primary"
                      >auto_awesome</span
                    >
                    T·∫°o D·ª± B√°o M·ªõi
                  </h3>
                  <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">
                    Ph√¢n t√≠ch d·ªØ li·ªáu s·ª©c kh·ªèe v√† t·∫°o d·ª± b√°o r·ªßi ro b·ªánh t·∫≠t cho
                    b·ªánh nh√¢n.
                  </p>
                  <button
                    onclick="generateForecast()"
                    id="generateForecastBtn"
                    disabled
                    class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-primary hover:bg-primary-dark disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-lg transition-colors"
                  >
                    <span class="material-symbols-outlined">insights</span>
                    T·∫°o d·ª± b√°o s·ª©c kh·ªèe
                  </button>
                </div>

                <!-- Risk Legend -->
                <div
                  class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-6"
                >
                  <h3 class="font-semibold text-slate-900 dark:text-white mb-4">
                    Ch√∫ Th√≠ch M·ª©c R·ªßi Ro
                  </h3>
                  <div class="space-y-3">
                    <div class="flex items-center gap-3">
                      <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                      <span class="text-sm">Th·∫•p (< 5%)</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="w-4 h-4 bg-yellow-500 rounded-full"></div>
                      <span class="text-sm">Trung b√¨nh (5-10%)</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="w-4 h-4 bg-orange-500 rounded-full"></div>
                      <span class="text-sm">Cao (10-20%)</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                      <span class="text-sm">R·∫•t cao (> 20%)</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Forecast Results -->
              <div class="lg:col-span-2">
                <div
                  class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-6"
                >
                  <div class="flex items-center justify-between mb-4">
                    <h3
                      class="font-semibold text-slate-900 dark:text-white flex items-center gap-2"
                    >
                      <span class="material-symbols-outlined text-primary"
                        >monitoring</span
                      >
                      K·∫øt Qu·∫£ D·ª± B√°o
                    </h3>
                    <span
                      id="forecastDate"
                      class="text-sm text-slate-500 dark:text-slate-400"
                    ></span>
                  </div>

                  <div id="forecastContent">
                    <div class="text-center py-12">
                      <span
                        class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600"
                        >analytics</span
                      >
                      <p class="text-slate-500 dark:text-slate-400 mt-4">
                        Ch·ªçn b·ªánh nh√¢n v√† nh·∫•n "T·∫°o d·ª± b√°o" ƒë·ªÉ xem k·∫øt qu·∫£
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Forecast History -->
                <div
                  class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-6 mt-6"
                >
                  <h3
                    class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined text-primary"
                      >history</span
                    >
                    L·ªãch S·ª≠ D·ª± B√°o
                  </h3>
                  <div id="forecastHistory" class="space-y-3">
                    <div class="text-center py-4">
                      <p class="text-slate-500 dark:text-slate-400 text-sm">
                        Ch∆∞a c√≥ d·ªØ li·ªáu
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-4 right-4 z-50 space-y-2"
    ></div>

    <!-- Scripts -->
    <script>
      // Global state
      let selectedPatientId = null;
      let patients = [];
      let medicalReports = [];
      let familyHistory = [];
      let forecasts = [];

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadPatients();
        document.getElementById("reportDate").valueAsDate = new Date();

        // Show custom condition input when "OTHER" is selected
        document
          .getElementById("familyCondition")
          .addEventListener("change", function () {
            const wrapper = document.getElementById("customConditionWrapper");
            wrapper.classList.toggle("hidden", this.value !== "OTHER");
          });
      });

      // Load patients
      async function loadPatients() {
        try {
          const response = await fetch("/doctor/api/patients");
          if (!response.ok) throw new Error("Failed to load patients");

          patients = await response.json();
          populatePatientSelect();
        } catch (error) {
          console.error("Error loading patients:", error);
          showToast("L·ªói khi t·∫£i danh s√°ch b·ªánh nh√¢n", "error");
        }
      }

      // Populate patient select
      function populatePatientSelect() {
        const select = document.getElementById("patientSelect");
        select.innerHTML = '<option value="">-- Ch·ªçn b·ªánh nh√¢n --</option>';
        patients.forEach((p) => {
          select.innerHTML += `<option value="${p.id}">${p.fullName} - ${p.phone || p.email || "N/A"}</option>`;
        });
      }

      // Load patient data when selected
      function loadPatientData() {
        const patientId = document.getElementById("patientSelect").value;

        if (!patientId) {
          selectedPatientId = null;
          document.getElementById("patientInfo").classList.add("hidden");
          document.getElementById("generateForecastBtn").disabled = true;
          resetAllTabs();
          return;
        }

        selectedPatientId = patientId;
        const patient = patients.find((p) => p.id == patientId);

        if (patient) {
          document.getElementById("selectedPatientName").textContent =
            patient.fullName;
          document.getElementById("selectedPatientInfo").textContent =
            `${patient.phone || ""} ${patient.email ? "‚Ä¢ " + patient.email : ""}`;
          document.getElementById("patientInfo").classList.remove("hidden");
          document.getElementById("generateForecastBtn").disabled = false;
        }

        // Load data for all tabs
        loadMedicalReports();
        loadFamilyHistory();
        loadForecastHistory();
      }

      // Reset all tabs
      function resetAllTabs() {
        document.getElementById("medicalReportsList").innerHTML = `
          <div class="text-center py-8">
            <span class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600">description</span>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Ch·ªçn b·ªánh nh√¢n ƒë·ªÉ xem b√°o c√°o</p>
          </div>
        `;
        document.getElementById("familyHistoryList").innerHTML = `
          <div class="text-center py-8">
            <span class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600">family_restroom</span>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Ch·ªçn b·ªánh nh√¢n ƒë·ªÉ xem ti·ªÅn s·ª≠ gia ƒë√¨nh</p>
          </div>
        `;
        document.getElementById("forecastContent").innerHTML = `
          <div class="text-center py-12">
            <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600">analytics</span>
            <p class="text-slate-500 dark:text-slate-400 mt-4">Ch·ªçn b·ªánh nh√¢n v√† nh·∫•n "T·∫°o d·ª± b√°o" ƒë·ªÉ xem k·∫øt qu·∫£</p>
          </div>
        `;
        document.getElementById("familyRiskSummary").classList.add("hidden");
      }

      // Switch tab
      function switchTab(tabId) {
        // Hide all content
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.add("hidden"));

        // Show selected content
        document.getElementById("content-" + tabId).classList.remove("hidden");

        // Update tab styles
        document.querySelectorAll("[id^='tab-']").forEach((el) => {
          el.classList.remove("tab-active");
          el.classList.add("text-slate-600", "dark:text-slate-400");
        });

        const activeTab = document.getElementById("tab-" + tabId);
        activeTab.classList.add("tab-active");
        activeTab.classList.remove("text-slate-600", "dark:text-slate-400");
      }

      // ================== MEDICAL REPORTS ==================

      // Load medical reports
      async function loadMedicalReports() {
        if (!selectedPatientId) return;

        try {
          const response = await fetch(
            `/api/doctor/health-forecast/reports/${selectedPatientId}`,
          );
          if (!response.ok) throw new Error("Failed to load reports");

          const data = await response.json();
          medicalReports = data.reports || [];
          renderMedicalReports();
        } catch (error) {
          console.error("Error:", error);
          // Show empty state for now (API may not exist yet)
          medicalReports = [];
          renderMedicalReports();
        }
      }

      // Render medical reports
      function renderMedicalReports() {
        const container = document.getElementById("medicalReportsList");

        if (medicalReports.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8">
              <span class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600">description</span>
              <p class="text-slate-500 dark:text-slate-400 mt-2">Ch∆∞a c√≥ b√°o c√°o y t·∫ø n√†o</p>
            </div>
          `;
          return;
        }

        container.innerHTML = medicalReports
          .map(
            (report) => `
          <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 ${getReportTypeBg(report.type)} rounded-lg flex items-center justify-center">
                  <span class="material-symbols-outlined ${getReportTypeColor(report.type)}">${getReportTypeIcon(report.type)}</span>
                </div>
                <div>
                  <h4 class="font-medium text-slate-900 dark:text-white">${report.title}</h4>
                  <p class="text-xs text-slate-500 dark:text-slate-400">${getReportTypeName(report.type)} ‚Ä¢ ${formatDate(report.reportDate)}</p>
                </div>
              </div>
              <button onclick="deleteReport(${report.id})" class="p-1.5 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-600">
                <span class="material-symbols-outlined text-[18px]">delete</span>
              </button>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400 whitespace-pre-wrap">${report.content}</p>
            ${report.notes ? `<p class="text-xs text-slate-500 dark:text-slate-400 mt-2 italic">üìù ${report.notes}</p>` : ""}
          </div>
        `,
          )
          .join("");
      }

      // Save medical report
      async function saveMedicalReport(event) {
        event.preventDefault();

        if (!selectedPatientId) {
          showToast("Vui l√≤ng ch·ªçn b·ªánh nh√¢n tr∆∞·ªõc", "warning");
          return;
        }

        const data = {
          patientId: selectedPatientId,
          type: document.getElementById("reportType").value,
          reportDate: document.getElementById("reportDate").value,
          title: document.getElementById("reportTitle").value,
          content: document.getElementById("reportContent").value,
          notes: document.getElementById("reportNotes").value,
        };

        try {
          const response = await fetch("/api/doctor/health-forecast/reports", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) throw new Error("Failed to save report");

          showToast("L∆∞u b√°o c√°o th√†nh c√¥ng", "success");
          document.getElementById("medicalReportForm").reset();
          document.getElementById("reportDate").valueAsDate = new Date();
          loadMedicalReports();
        } catch (error) {
          console.error("Error:", error);
          showToast("L·ªói khi l∆∞u b√°o c√°o", "error");
        }
      }

      // Report type helpers
      function getReportTypeBg(type) {
        const map = {
          LAB_TEST: "bg-blue-100 dark:bg-blue-900/30",
          IMAGING: "bg-purple-100 dark:bg-purple-900/30",
          PATHOLOGY: "bg-red-100 dark:bg-red-900/30",
          VITAL_SIGNS: "bg-green-100 dark:bg-green-900/30",
          CONSULTATION: "bg-amber-100 dark:bg-amber-900/30",
          OTHER: "bg-slate-100 dark:bg-slate-800",
        };
        return map[type] || map.OTHER;
      }

      function getReportTypeColor(type) {
        const map = {
          LAB_TEST: "text-blue-600 dark:text-blue-400",
          IMAGING: "text-purple-600 dark:text-purple-400",
          PATHOLOGY: "text-red-600 dark:text-red-400",
          VITAL_SIGNS: "text-green-600 dark:text-green-400",
          CONSULTATION: "text-amber-600 dark:text-amber-400",
          OTHER: "text-slate-600 dark:text-slate-400",
        };
        return map[type] || map.OTHER;
      }

      function getReportTypeIcon(type) {
        const map = {
          LAB_TEST: "science",
          IMAGING: "radiology",
          PATHOLOGY: "biotech",
          VITAL_SIGNS: "monitor_heart",
          CONSULTATION: "stethoscope",
          OTHER: "description",
        };
        return map[type] || map.OTHER;
      }

      function getReportTypeName(type) {
        const map = {
          LAB_TEST: "X√©t nghi·ªám",
          IMAGING: "Ch·∫©n ƒëo√°n h√¨nh ·∫£nh",
          PATHOLOGY: "Gi·∫£i ph·∫´u b·ªánh",
          VITAL_SIGNS: "Ch·ªâ s·ªë sinh t·ªìn",
          CONSULTATION: "Kh√°m b·ªánh",
          OTHER: "Kh√°c",
        };
        return map[type] || map.OTHER;
      }

      // Filter reports
      function filterReports() {
        const filterType = document.getElementById("reportFilterType").value;
        // Client-side filter for now
        const filtered = filterType
          ? medicalReports.filter((r) => r.type === filterType)
          : medicalReports;

        const container = document.getElementById("medicalReportsList");
        if (filtered.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8">
              <span class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600">description</span>
              <p class="text-slate-500 dark:text-slate-400 mt-2">Kh√¥ng c√≥ b√°o c√°o n√†o</p>
            </div>
          `;
          return;
        }
        // Re-render with filtered data
        const temp = medicalReports;
        medicalReports = filtered;
        renderMedicalReports();
        medicalReports = temp;
      }

      // ================== FAMILY HISTORY ==================

      // Load family history
      async function loadFamilyHistory() {
        if (!selectedPatientId) return;

        try {
          const response = await fetch(
            `/api/doctor/health-forecast/family-history/${selectedPatientId}`,
          );
          if (!response.ok) throw new Error("Failed to load family history");

          const data = await response.json();
          familyHistory = data.history || [];
          renderFamilyHistory();
        } catch (error) {
          console.error("Error:", error);
          familyHistory = [];
          renderFamilyHistory();
        }
      }

      // Render family history
      function renderFamilyHistory() {
        const container = document.getElementById("familyHistoryList");
        const riskSummary = document.getElementById("familyRiskSummary");

        if (familyHistory.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8">
              <span class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600">family_restroom</span>
              <p class="text-slate-500 dark:text-slate-400 mt-2">Ch∆∞a c√≥ ti·ªÅn s·ª≠ gia ƒë√¨nh</p>
            </div>
          `;
          riskSummary.classList.add("hidden");
          return;
        }

        // Group by relationship
        const grouped = {};
        familyHistory.forEach((h) => {
          if (!grouped[h.relationship]) grouped[h.relationship] = [];
          grouped[h.relationship].push(h);
        });

        container.innerHTML = Object.entries(grouped)
          .map(
            ([relation, items]) => `
          <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
            <h4 class="font-medium text-slate-900 dark:text-white mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined text-primary text-[20px]">person</span>
              ${getRelationshipName(relation)}
            </h4>
            <div class="space-y-2">
              ${items
                .map(
                  (item) => `
                <div class="flex items-center justify-between pl-7">
                  <div>
                    <span class="text-sm text-slate-700 dark:text-slate-300">${getConditionName(item.condition)}</span>
                    ${item.ageAtDiagnosis ? `<span class="text-xs text-slate-500 ml-2">(ph√°t hi·ªán l√∫c ${item.ageAtDiagnosis} tu·ªïi)</span>` : ""}
                  </div>
                  <button onclick="deleteFamilyHistory(${item.id})" class="p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-600">
                    <span class="material-symbols-outlined text-[16px]">close</span>
                  </button>
                </div>
              `,
                )
                .join("")}
            </div>
          </div>
        `,
          )
          .join("");

        // Show risk summary
        const riskConditions = [
          ...new Set(familyHistory.map((h) => h.condition)),
        ];
        if (riskConditions.length > 0) {
          document.getElementById("familyRiskContent").innerHTML = `
            B·ªánh nh√¢n c√≥ ti·ªÅn s·ª≠ gia ƒë√¨nh v·ªõi c√°c b·ªánh l√Ω: <strong>${riskConditions.map((c) => getConditionName(c)).join(", ")}</strong>. 
            C·∫ßn theo d√µi v√† t·∫ßm so√°t ƒë·ªãnh k·ª≥ c√°c b·ªánh n√†y.
          `;
          riskSummary.classList.remove("hidden");
        } else {
          riskSummary.classList.add("hidden");
        }
      }

      // Save family history
      async function saveFamilyHistory(event) {
        event.preventDefault();

        if (!selectedPatientId) {
          showToast("Vui l√≤ng ch·ªçn b·ªánh nh√¢n tr∆∞·ªõc", "warning");
          return;
        }

        const condition = document.getElementById("familyCondition").value;
        const data = {
          patientId: selectedPatientId,
          relationship: document.getElementById("relationship").value,
          condition:
            condition === "OTHER"
              ? document.getElementById("customCondition").value
              : condition,
          ageAtDiagnosis:
            document.getElementById("ageAtDiagnosis").value || null,
          status: document.getElementById("familyMemberStatus").value,
          notes: document.getElementById("familyNotes").value,
        };

        try {
          const response = await fetch(
            "/api/doctor/health-forecast/family-history",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            },
          );

          if (!response.ok) throw new Error("Failed to save family history");

          showToast("L∆∞u ti·ªÅn s·ª≠ gia ƒë√¨nh th√†nh c√¥ng", "success");
          document.getElementById("familyHistoryForm").reset();
          loadFamilyHistory();
        } catch (error) {
          console.error("Error:", error);
          showToast("L·ªói khi l∆∞u ti·ªÅn s·ª≠ gia ƒë√¨nh", "error");
        }
      }

      // Relationship helpers
      function getRelationshipName(rel) {
        const map = {
          FATHER: "Cha",
          MOTHER: "M·∫π",
          GRANDFATHER_P: "√îng n·ªôi",
          GRANDMOTHER_P: "B√† n·ªôi",
          GRANDFATHER_M: "√îng ngo·∫°i",
          GRANDMOTHER_M: "B√† ngo·∫°i",
          SIBLING: "Anh/Ch·ªã/Em ru·ªôt",
          UNCLE_AUNT: "C√¥/D√¨/Ch√∫/B√°c",
          OTHER: "Kh√°c",
        };
        return map[rel] || rel;
      }

      function getConditionName(cond) {
        const map = {
          DIABETES: "Ti·ªÉu ƒë∆∞·ªùng",
          HYPERTENSION: "Cao huy·∫øt √°p",
          HEART_DISEASE: "B·ªánh tim",
          STROKE: "ƒê·ªôt qu·ªµ",
          CANCER: "Ung th∆∞",
          ASTHMA: "Hen suy·ªÖn",
          ARTHRITIS: "Vi√™m kh·ªõp",
          ALZHEIMER: "Alzheimer",
          KIDNEY_DISEASE: "B·ªánh th·∫≠n",
          LIVER_DISEASE: "B·ªánh gan",
        };
        return map[cond] || cond;
      }

      // ================== HEALTH FORECAST ==================

      // Generate forecast
      async function generateForecast() {
        if (!selectedPatientId) {
          showToast("Vui l√≤ng ch·ªçn b·ªánh nh√¢n tr∆∞·ªõc", "warning");
          return;
        }

        const btn = document.getElementById("generateForecastBtn");
        btn.disabled = true;
        btn.innerHTML =
          '<span class="material-symbols-outlined animate-spin">refresh</span> ƒêang ph√¢n t√≠ch...';

        try {
          const response = await fetch("/api/doctor/forecasts/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ patientId: selectedPatientId }),
          });

          if (!response.ok) throw new Error("Failed to generate forecast");

          const data = await response.json();

          if (data.success) {
            showToast("T·∫°o d·ª± b√°o th√†nh c√¥ng", "success");
            renderForecastResult(data.forecast);
            loadForecastHistory();
          } else {
            throw new Error(data.message || "Unknown error");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("L·ªói khi t·∫°o d·ª± b√°o: " + error.message, "error");
        } finally {
          btn.disabled = false;
          btn.innerHTML =
            '<span class="material-symbols-outlined">insights</span> T·∫°o d·ª± b√°o s·ª©c kh·ªèe';
        }
      }

      // Load forecast history
      async function loadForecastHistory() {
        if (!selectedPatientId) return;

        try {
          const response = await fetch(
            `/api/doctor/forecasts?patientId=${selectedPatientId}`,
          );
          if (!response.ok) throw new Error("Failed to load forecasts");

          const data = await response.json();
          forecasts = data.forecasts || [];
          renderForecastHistory();

          // Show latest forecast if exists
          if (forecasts.length > 0) {
            const latestId = forecasts[0].id;
            loadForecastDetail(latestId);
          }
        } catch (error) {
          console.error("Error:", error);
          forecasts = [];
          renderForecastHistory();
        }
      }

      // Load forecast detail
      async function loadForecastDetail(id) {
        try {
          const response = await fetch(`/api/doctor/forecasts/${id}`);
          if (!response.ok) throw new Error("Failed to load forecast");

          const forecast = await response.json();
          renderForecastResult(forecast);
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // Render forecast result
      function renderForecastResult(forecast) {
        const container = document.getElementById("forecastContent");
        document.getElementById("forecastDate").textContent =
          `C·∫≠p nh·∫≠t: ${formatDate(forecast.forecastDate)}`;

        const riskScores = forecast.riskScores || {};
        const predictions = forecast.predictions || {};

        container.innerHTML = `
          <!-- Overall Risk -->
          <div class="mb-6 p-4 rounded-xl ${getRiskBg(riskScores.overallRisk)}">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="font-semibold text-lg ${getRiskTextColor(riskScores.overallRisk)}">
                  M·ª©c R·ªßi Ro T·ªïng Th·ªÉ: ${getRiskLevelName(riskScores.overallRisk)}
                </h4>
                <p class="text-sm opacity-80">D·ª±a tr√™n ph√¢n t√≠ch c√°c y·∫øu t·ªë nguy c∆°</p>
              </div>
              <div class="w-16 h-16 rounded-full ${getRiskBg(riskScores.overallRisk)} flex items-center justify-center">
                <span class="material-symbols-outlined text-3xl ${getRiskTextColor(riskScores.overallRisk)}">${getRiskIcon(riskScores.overallRisk)}</span>
              </div>
            </div>
          </div>

          <!-- Risk Scores -->
          <div class="grid md:grid-cols-2 gap-4 mb-6">
            ${renderRiskCard("Tim m·∫°ch", riskScores.cardiovascularRisk, "cardiology")}
            ${renderRiskCard("Ti·ªÉu ƒë∆∞·ªùng", riskScores.diabetesRisk, "glucose")}
            ${renderRiskCard("Huy·∫øt √°p", riskScores.hypertensionRisk, "bloodtype")}
            ${renderRiskCard("ƒê·ªôt qu·ªµ", riskScores.strokeRisk, "neurology")}
          </div>

          <!-- Predictions -->
          <div class="mb-6">
            <h4 class="font-semibold text-slate-900 dark:text-white mb-3">Xu H∆∞·ªõng S·ª©c Kh·ªèe</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              ${renderTrendBadge("Huy·∫øt √°p", predictions.bloodPressureTrend)}
              ${renderTrendBadge("C√¢n n·∫∑ng", predictions.weightTrend)}
              ${renderTrendBadge("BMI", predictions.bmiTrend)}
              ${renderTrendBadge("ƒê∆∞·ªùng huy·∫øt", predictions.bloodSugarTrend)}
            </div>
          </div>

          <!-- Recommendations -->
          ${
            forecast.recommendations
              ? `
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
              <h4 class="font-semibold text-blue-800 dark:text-blue-300 mb-2 flex items-center gap-2">
                <span class="material-symbols-outlined">recommend</span>
                Khuy·∫øn Ngh·ªã
              </h4>
              <p class="text-sm text-blue-700 dark:text-blue-400 whitespace-pre-wrap">${forecast.recommendations}</p>
            </div>
          `
              : ""
          }
        `;
      }

      // Render risk card
      function renderRiskCard(title, value, icon) {
        const riskPercent = value ? Math.round(value) : 0;
        const riskLevel = getRiskLevelFromPercent(riskPercent);

        return `
          <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-slate-600 dark:text-slate-400">${title}</span>
              <span class="material-symbols-outlined text-slate-400">${icon}</span>
            </div>
            <div class="flex items-end gap-2">
              <span class="text-2xl font-bold ${getRiskTextColor(riskLevel)}">${riskPercent}%</span>
              <span class="text-xs text-slate-500 mb-1">r·ªßi ro 10 nƒÉm</span>
            </div>
            <div class="mt-2 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
              <div class="h-full ${getRiskBarColor(riskLevel)} transition-all" style="width: ${Math.min(riskPercent, 100)}%"></div>
            </div>
          </div>
        `;
      }

      // Render trend badge
      function renderTrendBadge(title, trend) {
        const trendMap = {
          IMPROVING: {
            icon: "trending_up",
            color: "text-green-600 bg-green-100 dark:bg-green-900/30",
            text: "C·∫£i thi·ªán",
          },
          STABLE: {
            icon: "trending_flat",
            color: "text-blue-600 bg-blue-100 dark:bg-blue-900/30",
            text: "·ªîn ƒë·ªãnh",
          },
          WORSENING: {
            icon: "trending_down",
            color: "text-red-600 bg-red-100 dark:bg-red-900/30",
            text: "X·∫•u ƒëi",
          },
        };
        const info = trendMap[trend] || {
          icon: "help",
          color: "bg-slate-100 dark:bg-slate-800 text-slate-500",
          text: "Ch∆∞a r√µ",
        };

        return `
          <div class="p-3 rounded-lg ${info.color} text-center">
            <span class="material-symbols-outlined text-[20px]">${info.icon}</span>
            <p class="text-xs font-medium mt-1">${title}</p>
            <p class="text-[10px] opacity-75">${info.text}</p>
          </div>
        `;
      }

      // Render forecast history
      function renderForecastHistory() {
        const container = document.getElementById("forecastHistory");

        if (forecasts.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <p class="text-slate-500 dark:text-slate-400 text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu d·ª± b√°o</p>
            </div>
          `;
          return;
        }

        container.innerHTML = forecasts
          .slice(0, 5)
          .map(
            (f) => `
          <button 
            onclick="loadForecastDetail(${f.id})"
            class="w-full flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-left"
          >
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 ${getRiskBg(f.overallRisk)} rounded-lg flex items-center justify-center">
                <span class="material-symbols-outlined ${getRiskTextColor(f.overallRisk)} text-[20px]">${getRiskIcon(f.overallRisk)}</span>
              </div>
              <div>
                <p class="font-medium text-slate-900 dark:text-white">${formatDate(f.forecastDate)}</p>
                <p class="text-xs text-slate-500">${getRiskLevelName(f.overallRisk)}</p>
              </div>
            </div>
            <span class="material-symbols-outlined text-slate-400">chevron_right</span>
          </button>
        `,
          )
          .join("");
      }

      // Risk helpers
      function getRiskLevelFromPercent(percent) {
        if (percent < 5) return "LOW";
        if (percent < 10) return "MODERATE";
        if (percent < 20) return "HIGH";
        return "VERY_HIGH";
      }

      function getRiskLevelName(level) {
        const map = {
          LOW: "Th·∫•p",
          MODERATE: "Trung b√¨nh",
          HIGH: "Cao",
          VERY_HIGH: "R·∫•t cao",
        };
        return map[level] || "Ch∆∞a x√°c ƒë·ªãnh";
      }

      function getRiskBg(level) {
        const map = {
          LOW: "bg-green-100 dark:bg-green-900/30",
          MODERATE: "bg-yellow-100 dark:bg-yellow-900/30",
          HIGH: "bg-orange-100 dark:bg-orange-900/30",
          VERY_HIGH: "bg-red-100 dark:bg-red-900/30",
        };
        return map[level] || "bg-slate-100 dark:bg-slate-800";
      }

      function getRiskTextColor(level) {
        const map = {
          LOW: "text-green-600 dark:text-green-400",
          MODERATE: "text-yellow-600 dark:text-yellow-400",
          HIGH: "text-orange-600 dark:text-orange-400",
          VERY_HIGH: "text-red-600 dark:text-red-400",
        };
        return map[level] || "text-slate-600 dark:text-slate-400";
      }

      function getRiskBarColor(level) {
        const map = {
          LOW: "bg-green-500",
          MODERATE: "bg-yellow-500",
          HIGH: "bg-orange-500",
          VERY_HIGH: "bg-red-500",
        };
        return map[level] || "bg-slate-400";
      }

      function getRiskIcon(level) {
        const map = {
          LOW: "check_circle",
          MODERATE: "info",
          HIGH: "warning",
          VERY_HIGH: "error",
        };
        return map[level] || "help";
      }

      // ================== UTILITIES ==================

      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleDateString("vi-VN");
      }

      function showToast(message, type = "info") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");

        const colors = {
          success: "bg-green-500",
          error: "bg-red-500",
          info: "bg-blue-500",
          warning: "bg-amber-500",
        };

        const icons = {
          success: "check_circle",
          error: "error",
          info: "info",
          warning: "warning",
        };

        toast.className = `flex items-center gap-3 px-4 py-3 ${colors[type]} text-white rounded-lg shadow-lg min-w-[300px]`;
        toast.innerHTML = `
          <span class="material-symbols-outlined">${icons[type]}</span>
          <span class="flex-1">${message}</span>
          <button onclick="this.parentElement.remove()" class="p-1 hover:bg-white/20 rounded">
            <span class="material-symbols-outlined text-[18px]">close</span>
          </button>
        `;

        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    </script>

    <!-- Common Scripts -->
    <th:block th:replace="~{fragments/doctor-layout :: scripts}"></th:block>
  </body>
</html>
