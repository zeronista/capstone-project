<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kê Đơn Thuốc Mới - ABClinic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#e6f4ff",
                100: "#bae0ff",
                200: "#91caff",
                300: "#69b1ff",
                400: "#4096ff",
                500: "#0d7cf2",
                600: "#096dd9",
                700: "#0958d9",
                800: "#003eb3",
                900: "#002c8c",
              },
            },
            fontFamily: {
              sans: ["Be Vietnam Pro", "sans-serif"],
            },
            animation: {
              "slide-in": "slideIn 0.3s ease-out",
              "fade-out": "fadeOut 0.3s ease-out",
            },
            keyframes: {
              slideIn: {
                "0%": { transform: "translateX(100%)", opacity: "0" },
                "100%": { transform: "translateX(0)", opacity: "1" },
              },
              fadeOut: {
                "0%": { opacity: "1" },
                "100%": { opacity: "0" },
              },
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-slate-50 font-sans">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside
        class="w-64 bg-white border-r border-slate-200 flex-none flex flex-col hidden lg:flex"
      >
        <!-- Logo -->
        <div class="p-6 border-b border-slate-200">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-primary-500 rounded-lg flex items-center justify-center"
            >
              <span class="material-symbols-outlined text-white text-2xl"
                >medication</span
              >
            </div>
            <div>
              <div class="font-bold text-slate-900 text-lg">ABClinic</div>
              <div class="text-xs text-slate-500">Bác sĩ</div>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-1">
          <a
            href="/doctor/dashboard"
            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors group"
          >
            <span class="material-symbols-outlined text-xl">dashboard</span>
            <span class="font-medium">Tổng quan</span>
          </a>
          <a
            href="/doctor/patients"
            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors group"
          >
            <span class="material-symbols-outlined text-xl">group</span>
            <span class="font-medium">Bệnh nhân</span>
          </a>
          <a
            href="/doctor/prescriptions"
            class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary-50 text-primary-600 border-l-4 border-primary-500 transition-colors group"
          >
            <span
              class="material-symbols-outlined text-xl"
              style="font-variation-settings: &quot;FILL&quot; 1"
              >description</span
            >
            <span class="font-medium">Đơn thuốc</span>
          </a>
          <a
            href="/doctor/treatments"
            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors group"
          >
            <span class="material-symbols-outlined text-xl">healing</span>
            <span class="font-medium">Lộ trình điều trị</span>
          </a>
          <a
            href="/doctor/appointments"
            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors group"
          >
            <span class="material-symbols-outlined text-xl">event</span>
            <span class="font-medium">Lịch hẹn</span>
          </a>
          <a
            href="/doctor/tickets"
            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors group"
          >
            <span class="material-symbols-outlined text-xl">support_agent</span>
            <span class="font-medium">Tickets</span>
          </a>
        </nav>

        <!-- User Profile -->
        <div class="p-4 border-t border-slate-200">
          <div class="flex items-center gap-3 mb-3">
            <div
              class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center"
              th:if="${doctor != null && doctor.avatarUrl != null}"
            >
              <img
                th:src="${doctor.avatarUrl}"
                alt="Avatar"
                class="w-full h-full rounded-full object-cover"
              />
            </div>
            <div
              class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center"
              th:if="${doctor == null || doctor.avatarUrl == null}"
            >
              <span class="material-symbols-outlined text-primary-600"
                >person</span
              >
            </div>
            <div class="flex-1 min-w-0">
              <div
                class="font-medium text-sm text-slate-900 truncate"
                th:text="${doctor != null ? doctor.fullName : 'Bác sĩ'}"
              >
                Bác sĩ
              </div>
              <div
                class="text-xs text-slate-500 truncate"
                th:text="${doctor != null ? doctor.email : ''}"
              ></div>
            </div>
          </div>
          <form th:action="@{/auth/logout}" method="post" class="w-full">
            <button
              type="submit"
              class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm font-medium"
            >
              <span class="material-symbols-outlined text-lg">logout</span>
              <span>Đăng xuất</span>
            </button>
          </form>
        </div>
      </aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Mobile Header -->
        <header
          class="lg:hidden bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between"
        >
          <div class="flex items-center gap-3">
            <button
              onclick="toggleMobileSidebar()"
              class="p-2 hover:bg-slate-100 rounded-lg"
            >
              <span class="material-symbols-outlined">menu</span>
            </button>
            <h1 class="font-bold text-slate-900">Kê Đơn Thuốc</h1>
          </div>
        </header>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto">
          <div class="h-full lg:flex">
            <!-- Patient Info Sidebar - 1/3 -->
            <div
              class="lg:w-1/3 bg-white border-r border-slate-200 p-6 space-y-6"
            >
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-bold text-slate-900">
                  Thông tin bệnh nhân
                </h2>
                <a
                  href="/doctor/patients"
                  class="text-sm text-primary-600 hover:text-primary-700 font-medium"
                >
                  Quay lại
                </a>
              </div>

              <!-- Patient Card -->
              <div th:if="${patient != null}">
                <!-- Avatar & Basic Info -->
                <div class="text-center mb-6">
                  <div
                    class="w-24 h-24 mx-auto mb-4 rounded-full ring-4 ring-primary-50 overflow-hidden"
                    th:if="${patient.avatarUrl != null}"
                  >
                    <img
                      th:src="${patient.avatarUrl}"
                      alt="Avatar"
                      class="w-full h-full object-cover"
                    />
                  </div>
                  <div
                    class="w-24 h-24 mx-auto mb-4 rounded-full ring-4 ring-primary-50 bg-slate-100 flex items-center justify-center"
                    th:if="${patient.avatarUrl == null}"
                  >
                    <span
                      class="text-3xl font-bold text-slate-400"
                      th:text="${patient.fullName != null ? #strings.substring(patient.fullName, 0, 1) : 'P'}"
                      >P</span
                    >
                  </div>
                  <h3
                    class="text-xl font-bold text-slate-900 mb-1"
                    th:text="${patient.fullName}"
                  >
                    Nguyễn Văn A
                  </h3>
                  <div
                    class="flex items-center justify-center gap-2 text-sm text-slate-600"
                  >
                    <span class="material-symbols-outlined text-sm">badge</span>
                    <span th:text="'ID: ' + ${patient.id}">ID: 001</span>
                  </div>
                </div>

                <!-- Contact Info -->
                <div class="space-y-3 mb-6">
                  <div class="flex items-start gap-3">
                    <span
                      class="material-symbols-outlined text-slate-400 text-lg"
                      >phone</span
                    >
                    <div>
                      <div class="text-xs text-slate-500 mb-0.5">
                        Số điện thoại
                      </div>
                      <div
                        class="text-sm font-medium text-slate-900"
                        th:text="${patient.phoneNumber != null ? patient.phoneNumber : 'Chưa cập nhật'}"
                      >
                        0123456789
                      </div>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <span
                      class="material-symbols-outlined text-slate-400 text-lg"
                      >mail</span
                    >
                    <div>
                      <div class="text-xs text-slate-500 mb-0.5">Email</div>
                      <div
                        class="text-sm font-medium text-slate-900 break-all"
                        th:text="${patient.email}"
                      >
                        patient@example.com
                      </div>
                    </div>
                  </div>
                  <div
                    class="flex items-start gap-3"
                    th:if="${patient.dateOfBirth != null}"
                  >
                    <span
                      class="material-symbols-outlined text-slate-400 text-lg"
                      >cake</span
                    >
                    <div>
                      <div class="text-xs text-slate-500 mb-0.5">Ngày sinh</div>
                      <div
                        class="text-sm font-medium text-slate-900"
                        th:text="${#temporals.format(patient.dateOfBirth, 'dd/MM/yyyy')}"
                      >
                        01/01/1990
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Vital Signs Grid -->
                <div class="mb-6">
                  <div class="text-sm font-semibold text-slate-900 mb-3">
                    Chỉ số sinh tồn
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <!-- Blood Pressure -->
                    <div class="bg-red-50 border border-red-100 rounded-lg p-3">
                      <div class="flex items-center gap-2 mb-2">
                        <span
                          class="material-symbols-outlined text-red-600 text-lg"
                          >favorite</span
                        >
                        <span class="text-xs text-red-700 font-medium"
                          >Huyết áp</span
                        >
                      </div>
                      <div class="text-lg font-bold text-red-900">120/80</div>
                      <div class="text-xs text-red-600">mmHg</div>
                    </div>

                    <!-- Heart Rate -->
                    <div
                      class="bg-pink-50 border border-pink-100 rounded-lg p-3"
                    >
                      <div class="flex items-center gap-2 mb-2">
                        <span
                          class="material-symbols-outlined text-pink-600 text-lg"
                          >ecg_heart</span
                        >
                        <span class="text-xs text-pink-700 font-medium"
                          >Nhịp tim</span
                        >
                      </div>
                      <div class="text-lg font-bold text-pink-900">72</div>
                      <div class="text-xs text-pink-600">bpm</div>
                    </div>

                    <!-- Weight -->
                    <div
                      class="bg-blue-50 border border-blue-100 rounded-lg p-3"
                    >
                      <div class="flex items-center gap-2 mb-2">
                        <span
                          class="material-symbols-outlined text-blue-600 text-lg"
                          >monitor_weight</span
                        >
                        <span class="text-xs text-blue-700 font-medium"
                          >Cân nặng</span
                        >
                      </div>
                      <div class="text-lg font-bold text-blue-900">65.5</div>
                      <div class="text-xs text-blue-600">kg</div>
                    </div>

                    <!-- Temperature -->
                    <div
                      class="bg-orange-50 border border-orange-100 rounded-lg p-3"
                    >
                      <div class="flex items-center gap-2 mb-2">
                        <span
                          class="material-symbols-outlined text-orange-600 text-lg"
                          >thermostat</span
                        >
                        <span class="text-xs text-orange-700 font-medium"
                          >Nhiệt độ</span
                        >
                      </div>
                      <div class="text-lg font-bold text-orange-900">36.5</div>
                      <div class="text-xs text-orange-600">°C</div>
                    </div>
                  </div>
                </div>

                <!-- Allergy Warning -->
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                  <div class="flex items-start gap-3">
                    <span class="material-symbols-outlined text-red-600 text-lg"
                      >warning</span
                    >
                    <div>
                      <div class="text-sm font-semibold text-red-900 mb-1">
                        Cảnh báo dị ứng
                      </div>
                      <div class="text-sm text-red-700">
                        Penicillin, Aspirin
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Active Treatment Plan -->
                <div
                  th:if="${activePlan != null}"
                  class="bg-emerald-50 border border-emerald-200 rounded-lg p-4 mt-4"
                >
                  <div class="flex items-start gap-3">
                    <span
                      class="material-symbols-outlined text-emerald-600 text-lg"
                      >healing</span
                    >
                    <div class="flex-1">
                      <div class="text-sm font-semibold text-emerald-900 mb-1">
                        Lộ trình điều trị
                      </div>
                      <div
                        class="text-sm text-emerald-700 mb-2"
                        th:text="${activePlan.planName}"
                      >
                        Điều trị cao huyết áp
                      </div>
                      <div
                        class="text-xs text-emerald-600"
                        th:text="${activePlan.diagnosis}"
                      >
                        Chẩn đoán: Tăng huyết áp độ 1
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- No Patient Selected -->
              <div th:if="${patient == null}" class="text-center py-12">
                <span
                  class="material-symbols-outlined text-slate-300 text-6xl mb-4"
                  >person_off</span
                >
                <div class="text-slate-600 font-medium mb-2">
                  Chưa chọn bệnh nhân
                </div>
                <div class="text-sm text-slate-500 mb-4">
                  Vui lòng chọn bệnh nhân từ danh sách
                </div>
                <a
                  href="/doctor/patients"
                  class="inline-flex items-center gap-2 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors text-sm font-medium"
                >
                  <span class="material-symbols-outlined text-lg">group</span>
                  <span>Chọn bệnh nhân</span>
                </a>
              </div>
            </div>

            <!-- Prescription Form - 2/3 -->
            <div class="lg:w-2/3 bg-slate-50 p-6">
              <form id="prescriptionForm" th:if="${patient != null}">
                <!-- Form Header -->
                <div
                  class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6"
                >
                  <h2 class="text-xl font-bold text-slate-900 mb-4">
                    Kê Đơn Thuốc
                  </h2>

                  <!-- Diagnosis Input -->
                  <div class="mb-4">
                    <label
                      class="block text-sm font-medium text-slate-700 mb-2"
                    >
                      <span
                        class="material-symbols-outlined text-sm align-middle"
                        >clinical_notes</span
                      >
                      Chẩn đoán <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      name="diagnosis"
                      required
                      class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all"
                      placeholder="Nhập chẩn đoán bệnh..."
                    />
                  </div>
                </div>

                <!-- Medication Table -->
                <div
                  class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6"
                >
                  <div
                    class="p-4 border-b border-slate-200 flex items-center justify-between sticky top-0 bg-white z-10"
                  >
                    <h3 class="font-semibold text-slate-900">
                      Danh sách thuốc
                    </h3>
                    <button
                      type="button"
                      onclick="addMedicationRow()"
                      class="flex items-center gap-2 px-3 py-1.5 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors text-sm font-medium"
                    >
                      <span class="material-symbols-outlined text-lg">add</span>
                      <span>Thêm thuốc</span>
                    </button>
                  </div>

                  <div class="overflow-x-auto">
                    <table class="w-full">
                      <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                          <th
                            class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider w-8"
                          >
                            #
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider"
                          >
                            Tên thuốc
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider w-32"
                          >
                            Số lượng
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider w-48"
                          >
                            Liều lượng
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider"
                          >
                            Hướng dẫn sử dụng
                          </th>
                          <th
                            class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider w-16"
                          >
                            Xóa
                          </th>
                        </tr>
                      </thead>
                      <tbody
                        id="medicationTableBody"
                        class="divide-y divide-slate-200"
                      >
                        <!-- Initial row -->
                        <tr class="medication-row hover:bg-slate-50">
                          <td
                            class="px-4 py-3 text-sm text-slate-600 row-number"
                          >
                            1
                          </td>
                          <td class="px-4 py-3">
                            <input
                              type="text"
                              name="medicationName[]"
                              required
                              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none text-sm"
                              placeholder="Tên thuốc..."
                            />
                          </td>
                          <td class="px-4 py-3">
                            <input
                              type="number"
                              name="quantity[]"
                              required
                              min="1"
                              value="1"
                              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none text-sm"
                              placeholder="SL"
                            />
                          </td>
                          <td class="px-4 py-3">
                            <input
                              type="text"
                              name="dosage[]"
                              required
                              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none text-sm"
                              placeholder="Ví dụ: 500mg"
                            />
                          </td>
                          <td class="px-4 py-3">
                            <input
                              type="text"
                              name="instructions[]"
                              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none text-sm"
                              placeholder="Ngày 2 lần, sau ăn..."
                            />
                          </td>
                          <td class="px-4 py-3 text-center">
                            <button
                              type="button"
                              onclick="removeMedicationRow(this)"
                              class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            >
                              <span class="material-symbols-outlined text-lg"
                                >delete</span
                              >
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Additional Notes -->
                <div
                  class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6"
                >
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    <span class="material-symbols-outlined text-sm align-middle"
                      >note</span
                    >
                    Ghi chú của bác sĩ
                  </label>
                  <textarea
                    name="notes"
                    rows="4"
                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all resize-none"
                    placeholder="Lưu ý cho bệnh nhân hoặc dược sĩ..."
                  ></textarea>
                </div>

                <!-- Revisit Checkbox -->
                <div
                  class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6"
                >
                  <label class="flex items-start gap-3 cursor-pointer">
                    <input
                      type="checkbox"
                      name="requireRevisit"
                      class="mt-1 w-4 h-4 text-primary-600 border-slate-300 rounded focus:ring-primary-500"
                    />
                    <div>
                      <div class="text-sm font-medium text-slate-900">
                        Yêu cầu tái khám
                      </div>
                      <div class="text-xs text-slate-500 mt-1">
                        Bệnh nhân cần quay lại khám sau một thời gian để theo
                        dõi tình trạng
                      </div>
                    </div>
                  </label>
                  <div id="revisitDateField" class="mt-4 hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-2"
                      >Ngày tái khám</label
                    >
                    <input
                      type="date"
                      name="revisitDate"
                      class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all"
                    />
                  </div>
                </div>

                <!-- Form Actions -->
                <div class="flex items-center justify-end gap-3">
                  <a
                    href="/doctor/patients"
                    class="px-6 py-2.5 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors font-medium"
                  >
                    Hủy
                  </a>
                  <button
                    type="submit"
                    class="flex items-center gap-2 px-6 py-2.5 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors font-medium shadow-sm hover:shadow-md"
                  >
                    <span class="material-symbols-outlined text-lg">save</span>
                    <span>Lưu & Kê đơn</span>
                  </button>
                </div>
              </form>

              <!-- No Patient Form -->
              <div
                th:if="${patient == null}"
                class="bg-white rounded-xl shadow-sm border border-slate-200 p-12 text-center"
              >
                <span
                  class="material-symbols-outlined text-slate-300 text-6xl mb-4"
                  >description</span
                >
                <div class="text-slate-600 font-medium mb-2">
                  Không thể kê đơn
                </div>
                <div class="text-sm text-slate-500">
                  Vui lòng chọn bệnh nhân để tiếp tục
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Hidden input for doctor ID from Thymeleaf -->
    <input type="hidden" id="doctorId" th:value="${doctor?.id}" />
    
    <!-- External JavaScript Module -->
    <script type="module">
        import * as prescriptionCreate from '/static/js/doctor-prescription-create.js';
        
        // Initialize the module
        document.addEventListener('DOMContentLoaded', () => {
            prescriptionCreate.init();
        });
        
        // Expose functions to window for inline onclick handlers
        window.prescriptionCreate = {
            toggleMobileSidebar: prescriptionCreate.toggleMobileSidebar,
            addMedicationRow: prescriptionCreate.addMedicationRow,
            removeMedicationRow: prescriptionCreate.removeMedicationRow
        };
    </script>
  </body>
</html>
        const sidebar = document.querySelector("aside");
        sidebar.classList.toggle("hidden");
      }

      // Add medication row
      function addMedicationRow() {
        const tbody = document.getElementById("medicationTableBody");
        const rowCount = tbody.querySelectorAll(".medication-row").length + 1;

        const newRow = document.createElement("tr");
        newRow.className = "medication-row hover:bg-slate-50";
        newRow.innerHTML = `
                <td class="px-4 py-3 text-sm text-slate-600 row-number">${rowCount}</td>
                <td class="px-4 py-3">
                    <input type="text" name="medicationName[]" required
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none text-sm"
                           placeholder="Tên thuốc..." />
                </td>
                <td class="px-4 py-3">
                    <input type="number" name="quantity[]" required min="1" value="1"
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none text-sm"
                           placeholder="SL" />
                </td>
                <td class="px-4 py-3">
                    <input type="text" name="dosage[]" required
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none text-sm"
                           placeholder="Ví dụ: 500mg" />
                </td>
                <td class="px-4 py-3">
                    <input type="text" name="instructions[]"
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none text-sm"
                           placeholder="Ngày 2 lần, sau ăn..." />
                </td>
                <td class="px-4 py-3 text-center">
                    <button type="button" onclick="removeMedicationRow(this)"
                            class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                        <span class="material-symbols-outlined text-lg">delete</span>
                    </button>
                </td>
            `;

        tbody.appendChild(newRow);
        updateRowNumbers();
      }

      // Remove medication row
      function removeMedicationRow(button) {
        const tbody = document.getElementById("medicationTableBody");
        const rows = tbody.querySelectorAll(".medication-row");

        if (rows.length > 1) {
          button.closest("tr").remove();
          updateRowNumbers();
        } else {
          alert("Phải có ít nhất một loại thuốc trong đơn!");
        }
      }

      // Update row numbers
      function updateRowNumbers() {
        const rows = document.querySelectorAll(".medication-row");
        rows.forEach((row, index) => {
          row.querySelector(".row-number").textContent = index + 1;
        });
      }

      // Toggle revisit date field
      document.addEventListener("DOMContentLoaded", function () {
        const revisitCheckbox = document.querySelector(
          'input[name="requireRevisit"]',
        );
        const revisitDateField = document.getElementById("revisitDateField");

        if (revisitCheckbox) {
          revisitCheckbox.addEventListener("change", function () {
            if (this.checked) {
              revisitDateField.classList.remove("hidden");
              revisitDateField.querySelector("input").required = true;
            } else {
              revisitDateField.classList.add("hidden");
              revisitDateField.querySelector("input").required = false;
            }
          });
        }

        // Validation helper functions
        function showFieldError(fieldName, message) {
          const field = document.querySelector(`[name="${fieldName}"]`);
          if (!field) return;

          // Remove existing error
          clearFieldError(fieldName);

          // Add error styling
          field.classList.add(
            "border-red-500",
            "focus:ring-red-500",
            "focus:border-red-500",
          );
          field.classList.remove("border-slate-300");

          // Add error message
          const errorDiv = document.createElement("div");
          errorDiv.className =
            "field-error text-red-600 text-xs mt-1 flex items-start gap-1";
          errorDiv.innerHTML = `
            <span class="material-symbols-outlined text-sm">error</span>
            <span>${message}</span>
          `;
          field.parentElement.appendChild(errorDiv);
        }

        function clearFieldError(fieldName) {
          const field = document.querySelector(`[name="${fieldName}"]`);
          if (!field) return;

          // Remove error styling
          field.classList.remove(
            "border-red-500",
            "focus:ring-red-500",
            "focus:border-red-500",
          );
          field.classList.add("border-slate-300");

          // Remove error message
          const errorDiv = field.parentElement.querySelector(".field-error");
          if (errorDiv) {
            errorDiv.remove();
          }
        }

        function clearAllErrors() {
          document
            .querySelectorAll(".field-error")
            .forEach((el) => el.remove());
          document.querySelectorAll(".border-red-500").forEach((el) => {
            el.classList.remove(
              "border-red-500",
              "focus:ring-red-500",
              "focus:border-red-500",
            );
            el.classList.add("border-slate-300");
          });
        }

        function validateDiagnosis(diagnosis) {
          if (!diagnosis || diagnosis.trim().length < 5) {
            return "Chẩn đoán phải có ít nhất 5 ký tự";
          }
          if (diagnosis.length > 500) {
            return "Chẩn đoán không được vượt quá 500 ký tự";
          }
          return null;
        }

        function validateMedication(med) {
          const errors = [];

          if (!med.name || med.name.trim().length < 2) {
            errors.push("Tên thuốc phải có ít nhất 2 ký tự");
          }
          if (med.name && med.name.length > 200) {
            errors.push("Tên thuốc không được vượt quá 200 ký tự");
          }
          if (!med.quantity || med.quantity < 1 || med.quantity > 1000) {
            errors.push("Số lượng phải từ 1 đến 1000");
          }
          if (!med.dosage || med.dosage.trim().length === 0) {
            errors.push("Liều dùng không được để trống");
          }
          if (med.instructions && med.instructions.length > 500) {
            errors.push("Hướng dẫn sử dụng không được vượt quá 500 ký tự");
          }

          return errors.length > 0 ? errors.join(", ") : null;
        }

        function validateForm(data) {
          const errors = {};

          // Validate diagnosis
          const diagnosisError = validateDiagnosis(data.diagnosis);
          if (diagnosisError) {
            errors.diagnosis = [diagnosisError];
          }

          // Validate medications
          if (!data.medications || data.medications.length === 0) {
            errors.medications = ["Phải có ít nhất một loại thuốc"];
          } else {
            data.medications.forEach((med, index) => {
              const medError = validateMedication(med);
              if (medError) {
                errors[`medication_${index}`] = [medError];
              }
            });
          }

          // Validate revisit date
          if (data.requireRevisit && !data.revisitDate) {
            errors.revisitDate = ["Vui lòng chọn ngày tái khám"];
          }
          if (data.revisitDate) {
            const revisitDateObj = new Date(data.revisitDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (revisitDateObj <= today) {
              errors.revisitDate = [
                "Ngày tái khám phải là ngày trong tương lai",
              ];
            }
          }

          return errors;
        }

        function displayValidationErrors(errors) {
          clearAllErrors();

          // Display field-level errors
          for (const [field, messages] of Object.entries(errors)) {
            const message = Array.isArray(messages)
              ? messages.join(", ")
              : messages;

            if (field.startsWith("medication_")) {
              // Show medication table error
              const index = parseInt(field.split("_")[1]);
              const row = document.querySelectorAll(".medication-row")[index];
              if (row) {
                const nameField = row.querySelector(
                  'input[name="medicationName[]"]',
                );
                if (nameField) {
                  nameField.classList.add("border-red-500");
                  const errorDiv = document.createElement("div");
                  errorDiv.className = "field-error text-red-600 text-xs mt-1";
                  errorDiv.textContent = message;
                  nameField.parentElement.appendChild(errorDiv);
                }
              }
            } else if (field === "medications") {
              // Show general medication error above table
              const table = document.getElementById("medicationTable");
              const existingError = table.previousElementSibling;
              if (
                !existingError ||
                !existingError.classList.contains("medication-table-error")
              ) {
                const errorDiv = document.createElement("div");
                errorDiv.className =
                  "medication-table-error bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4";
                errorDiv.textContent = message;
                table.parentElement.insertBefore(errorDiv, table);
              }
            } else {
              showFieldError(field, message);
            }
          }

          // Scroll to first error
          const firstError = document.querySelector(
            ".border-red-500, .medication-table-error",
          );
          if (firstError) {
            firstError.scrollIntoView({ behavior: "smooth", block: "center" });
          }

          // Show toast notification
          showToast("Vui lòng kiểm tra lại các trường đã nhập", "error");
        }

        function showToast(message, type = "info") {
          const toast = document.createElement("div");
          toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 animate-slide-in ${
            type === "error"
              ? "bg-red-500"
              : type === "success"
                ? "bg-green-500"
                : "bg-blue-500"
          }`;
          toast.textContent = message;
          document.body.appendChild(toast);

          setTimeout(() => {
            toast.classList.add("animate-fade-out");
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }

        // Form submission with validation and API integration
        const form = document.getElementById("prescriptionForm");
        if (form) {
          form.addEventListener("submit", async function (e) {
            e.preventDefault();

            // Clear previous errors
            clearAllErrors();
            document
              .querySelectorAll(".medication-table-error")
              .forEach((el) => el.remove());

            // Collect form data
            const formData = new FormData(form);
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get("patientId");

            // Get doctor ID from the model (passed from controller)
            const doctorId = /*[[${doctor?.id}]]*/ null;

            const data = {
              patientId: patientId ? parseInt(patientId) : null,
              doctorId: doctorId,
              diagnosis: formData.get("diagnosis"),
              notes: formData.get("notes") || "",
              requireRevisit: formData.get("requireRevisit") === "on",
              revisitDate: formData.get("revisitDate") || null,
              medications: [],
            };

            // Collect medications
            const medicationNames = formData.getAll("medicationName[]");
            const quantities = formData.getAll("quantity[]");
            const dosages = formData.getAll("dosage[]");
            const instructions = formData.getAll("instructions[]");

            for (let i = 0; i < medicationNames.length; i++) {
              if (medicationNames[i].trim()) {
                data.medications.push({
                  name: medicationNames[i].trim(),
                  quantity: parseInt(quantities[i]) || 1,
                  dosage: dosages[i].trim(),
                  instructions: instructions[i].trim() || "",
                });
              }
            }

            // Client-side validation
            const validationErrors = validateForm(data);
            if (Object.keys(validationErrors).length > 0) {
              displayValidationErrors(validationErrors);
              return;
            }

            // Disable submit button
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonHTML = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML =
              '<span class="material-symbols-outlined animate-spin">progress_activity</span><span>Đang lưu...</span>';

            try {
              // Send to backend API
              const response = await fetch("/api/prescriptions/create", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
              });

              if (response.ok) {
                const result = await response.json();
                showToast("Đơn thuốc đã được lưu thành công!", "success");

                // Redirect after short delay
                setTimeout(() => {
                  window.location.href = `/doctor/patients?id=${patientId}`;
                }, 1500);
              } else {
                const errorData = await response.json();

                if (
                  errorData.errors &&
                  Object.keys(errorData.errors).length > 0
                ) {
                  // Display field-level validation errors from server
                  displayValidationErrors(errorData.errors);
                } else {
                  // Display general error message
                  showToast(
                    errorData.message || "Có lỗi xảy ra khi lưu đơn thuốc",
                    "error",
                  );
                }
              }
            } catch (error) {
              console.error("Error submitting prescription:", error);
              showToast(
                "Không thể kết nối đến máy chủ. Vui lòng thử lại.",
                "error",
              );
            } finally {
              // Re-enable submit button
              submitButton.disabled = false;
              submitButton.innerHTML = originalButtonHTML;
            }
          });
        }
      });
    </script>

    <!-- Common Scripts -->
    <th:block th:replace="~{fragments/doctor-layout :: scripts}"></th:block>
  </body>
</html>
