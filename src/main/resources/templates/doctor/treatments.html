<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lộ Trình Điều Trị - ABClinic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script th:src="@{/js/tailwind-config.js}"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap"
    />
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
      .material-symbols-outlined.fill {
        font-variation-settings: "FILL" 1;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }
      @media print {
        .no-print {
          display: none !important;
        }
        .print-only {
          display: block !important;
        }
        body {
          background: white !important;
          color: black !important;
        }
        .print-container {
          box-shadow: none !important;
          border: none !important;
        }
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-slate-100 font-sans"
  >
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside th:replace="~{fragments/doctor-layout :: doctor-sidebar}"></aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Header -->
        <header
          class="bg-white dark:bg-[#1a2634] border-b border-slate-200 dark:border-slate-800 px-6 py-4 no-print"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <!-- Mobile menu button -->
              <button
                onclick="toggleSidebar()"
                class="lg:hidden p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
              >
                <span class="material-symbols-outlined">menu</span>
              </button>
              <div>
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">
                  Lộ Trình Điều Trị
                </h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Quản lý kế hoạch và lịch tái khám
                </p>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <a
                href="/doctor/treatments/create"
                class="flex items-center gap-2 px-4 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors"
              >
                <span class="material-symbols-outlined text-[20px]">add</span>
                <span class="hidden sm:inline">Tạo lộ trình mới</span>
              </a>
            </div>
          </div>
        </header>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-6">
          <!-- Statistics Cards -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-blue-600 dark:text-blue-400"
                    >assignment</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="totalTreatments"
                  >
                    0
                  </p>
                  <p class="text-sm text-slate-500 dark:text-slate-400">
                    Tổng lộ trình
                  </p>
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-green-600 dark:text-green-400"
                    >play_circle</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="activeTreatments"
                  >
                    0
                  </p>
                  <p class="text-sm text-slate-500 dark:text-slate-400">
                    Đang thực hiện
                  </p>
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-purple-600 dark:text-purple-400"
                    >check_circle</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="completedTreatments"
                  >
                    0
                  </p>
                  <p class="text-sm text-slate-500 dark:text-slate-400">
                    Hoàn thành
                  </p>
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-amber-600 dark:text-amber-400"
                    >event</span
                  >
                </div>
                <div>
                  <p
                    class="text-2xl font-bold text-slate-900 dark:text-white"
                    id="upcomingCheckups"
                  >
                    0
                  </p>
                  <p class="text-sm text-slate-500 dark:text-slate-400">
                    Tái khám sắp tới
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Filter Bar -->
          <div
            class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 p-4 mb-6 no-print"
          >
            <div class="flex flex-wrap items-center gap-4">
              <div class="flex-1 min-w-[200px]">
                <div class="relative">
                  <span
                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
                    >search</span
                  >
                  <input
                    type="text"
                    id="searchInput"
                    placeholder="Tìm kiếm theo tên bệnh nhân, chẩn đoán..."
                    class="w-full pl-10 pr-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                    onkeyup="filterTreatments()"
                  />
                </div>
              </div>
              <select
                id="statusFilter"
                onchange="filterTreatments()"
                class="px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              >
                <option value="">Tất cả trạng thái</option>
                <option value="DRAFT">Nháp</option>
                <option value="ACTIVE">Đang thực hiện</option>
                <option value="COMPLETED">Hoàn thành</option>
                <option value="CANCELLED">Đã hủy</option>
              </select>
              <input
                type="date"
                id="dateFilter"
                onchange="filterTreatments()"
                class="px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              />
            </div>
          </div>

          <!-- Treatments Grid -->
          <div id="treatmentsGrid" class="grid lg:grid-cols-2 gap-4">
            <!-- Treatment cards will be loaded here -->
          </div>

          <!-- Empty State -->
          <div
            id="emptyState"
            class="hidden text-center py-16 bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800"
          >
            <span
              class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600 mb-4"
              >assignment</span
            >
            <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-2">
              Chưa có lộ trình điều trị
            </h3>
            <p class="text-slate-500 dark:text-slate-400 mb-4">
              Bắt đầu tạo lộ trình điều trị cho bệnh nhân của bạn
            </p>
            <a
              href="/doctor/treatments/create"
              class="inline-flex items-center gap-2 px-4 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors"
            >
              <span class="material-symbols-outlined text-[20px]">add</span>
              Tạo lộ trình mới
            </a>
          </div>

          <!-- Loading State -->
          <div id="loadingState" class="text-center py-16">
            <div
              class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"
            ></div>
            <p class="text-slate-500 dark:text-slate-400">
              Đang tải dữ liệu...
            </p>
          </div>
        </main>
      </div>
    </div>

    <!-- Treatment Detail Modal -->
    <div id="treatmentDetailModal" class="fixed inset-0 z-50 hidden">
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeDetailModal()"
      ></div>
      <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-3xl max-h-[90vh] bg-white dark:bg-[#1a2634] rounded-2xl shadow-2xl overflow-hidden"
      >
        <div
          class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between"
        >
          <h2 class="text-lg font-bold text-slate-900 dark:text-white">
            Chi Tiết Lộ Trình Điều Trị
          </h2>
          <div class="flex items-center gap-2">
            <button
              onclick="printTreatment()"
              class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
              title="In lộ trình"
            >
              <span class="material-symbols-outlined">print</span>
            </button>
            <button
              onclick="exportTreatment()"
              class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
              title="Xuất PDF"
            >
              <span class="material-symbols-outlined">download</span>
            </button>
            <button
              onclick="closeDetailModal()"
              class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
            >
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>
        <div
          class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]"
          id="treatmentDetailContent"
        >
          <!-- Detail content will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Create/Edit Treatment Modal -->
    <div id="treatmentFormModal" class="fixed inset-0 z-50 hidden">
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeFormModal()"
      ></div>
      <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl max-h-[90vh] bg-white dark:bg-[#1a2634] rounded-2xl shadow-2xl overflow-hidden"
      >
        <div
          class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between"
        >
          <h2
            class="text-lg font-bold text-slate-900 dark:text-white"
            id="formModalTitle"
          >
            Tạo Lộ Trình Điều Trị
          </h2>
          <button
            onclick="closeFormModal()"
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
          <form id="treatmentForm" onsubmit="saveTreatment(event)">
            <input type="hidden" id="treatmentId" />

            <!-- Patient Selection -->
            <div class="mb-4">
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >Bệnh nhân *</label
              >
              <select
                id="patientSelect"
                required
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              >
                <option value="">Chọn bệnh nhân</option>
              </select>
            </div>

            <!-- Diagnosis -->
            <div class="mb-4">
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >Chẩn đoán *</label
              >
              <textarea
                id="diagnosisInput"
                rows="3"
                required
                placeholder="Nhập chẩn đoán bệnh..."
                class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary resize-none"
              ></textarea>
            </div>

            <!-- Treatment Goal -->
            <div class="mb-4">
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >Mục tiêu điều trị</label
              >
              <textarea
                id="treatmentGoalInput"
                rows="2"
                placeholder="Mục tiêu cần đạt được..."
                class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary resize-none"
              ></textarea>
            </div>

            <!-- Date Range -->
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                  >Ngày bắt đầu *</label
                >
                <input
                  type="date"
                  id="startDateInput"
                  required
                  class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                />
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                  >Ngày dự kiến kết thúc</label
                >
                <input
                  type="date"
                  id="endDateInput"
                  class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
                />
              </div>
            </div>

            <!-- Status -->
            <div class="mb-6">
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >Trạng thái</label
              >
              <select
                id="statusInput"
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              >
                <option value="DRAFT">Nháp</option>
                <option value="ACTIVE">Đang thực hiện</option>
                <option value="COMPLETED">Hoàn thành</option>
                <option value="CANCELLED">Đã hủy</option>
              </select>
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-end gap-4">
              <button
                type="button"
                onclick="closeFormModal()"
                class="px-6 py-2.5 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors"
              >
                Hủy
              </button>
              <button
                type="submit"
                class="flex items-center gap-2 px-6 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors"
              >
                <span class="material-symbols-outlined text-[20px]">save</span>
                Lưu
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Create Checkup Modal -->
    <div id="checkupFormModal" class="fixed inset-0 z-50 hidden">
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeCheckupModal()"
      ></div>
      <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-white dark:bg-[#1a2634] rounded-2xl shadow-2xl overflow-hidden"
      >
        <div
          class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between"
        >
          <h2 class="text-lg font-bold text-slate-900 dark:text-white">
            Thiết Lập Lịch Tái Khám
          </h2>
          <button
            onclick="closeCheckupModal()"
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="p-6">
          <form id="checkupForm" onsubmit="saveCheckup(event)">
            <input type="hidden" id="checkupTreatmentId" />

            <!-- Checkup Date -->
            <div class="mb-4">
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >Ngày tái khám *</label
              >
              <input
                type="date"
                id="checkupDateInput"
                required
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              />
            </div>

            <!-- Quick Schedule Options -->
            <div class="mb-4">
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >Lịch định kỳ</label
              >
              <div class="grid grid-cols-3 gap-2">
                <button
                  type="button"
                  onclick="setCheckupDate(1)"
                  class="px-3 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-primary/10 hover:text-primary rounded-lg text-sm transition-colors"
                >
                  1 tháng
                </button>
                <button
                  type="button"
                  onclick="setCheckupDate(3)"
                  class="px-3 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-primary/10 hover:text-primary rounded-lg text-sm transition-colors"
                >
                  3 tháng
                </button>
                <button
                  type="button"
                  onclick="setCheckupDate(6)"
                  class="px-3 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-primary/10 hover:text-primary rounded-lg text-sm transition-colors"
                >
                  6 tháng
                </button>
              </div>
            </div>

            <!-- Checkup Type -->
            <div class="mb-4">
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >Loại tái khám</label
              >
              <select
                id="checkupTypeInput"
                class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary"
              >
                <option value="routine">Định kỳ</option>
                <option value="follow_up">Theo dõi</option>
                <option value="emergency">Khẩn cấp</option>
              </select>
            </div>

            <!-- Notes -->
            <div class="mb-6">
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                >Ghi chú</label
              >
              <textarea
                id="checkupNotesInput"
                rows="2"
                placeholder="Ghi chú cho lần tái khám..."
                class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 border-0 rounded-lg focus:ring-2 focus:ring-primary resize-none"
              ></textarea>
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-end gap-4">
              <button
                type="button"
                onclick="closeCheckupModal()"
                class="px-6 py-2.5 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors"
              >
                Hủy
              </button>
              <button
                type="submit"
                class="flex items-center gap-2 px-6 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors"
              >
                <span class="material-symbols-outlined text-[20px]">event</span>
                Tạo lịch
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Status Change Modal -->
    <div id="statusChangeModal" class="fixed inset-0 z-50 hidden">
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeStatusModal()"
      ></div>
      <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-[#1a2634] rounded-2xl shadow-2xl overflow-hidden"
      >
        <div
          class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between"
        >
          <h2 class="text-lg font-bold text-slate-900 dark:text-white">
            Thay Đổi Trạng Thái
          </h2>
          <button
            onclick="closeStatusModal()"
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="p-6">
          <input type="hidden" id="statusChangeTreatmentId" />
          <p class="text-slate-600 dark:text-slate-400 mb-4">
            Chọn trạng thái mới cho lộ trình:
          </p>
          <div class="space-y-2">
            <button
              onclick="updateTreatmentStatus('DRAFT')"
              class="w-full flex items-center gap-3 px-4 py-3 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors"
            >
              <span class="w-3 h-3 bg-slate-400 rounded-full"></span>
              <span>Nháp</span>
            </button>
            <button
              onclick="updateTreatmentStatus('ACTIVE')"
              class="w-full flex items-center gap-3 px-4 py-3 bg-slate-100 dark:bg-slate-800 hover:bg-green-100 dark:hover:bg-green-900/30 hover:text-green-600 rounded-lg transition-colors"
            >
              <span class="w-3 h-3 bg-green-500 rounded-full"></span>
              <span>Đang thực hiện</span>
            </button>
            <button
              onclick="updateTreatmentStatus('COMPLETED')"
              class="w-full flex items-center gap-3 px-4 py-3 bg-slate-100 dark:bg-slate-800 hover:bg-purple-100 dark:hover:bg-purple-900/30 hover:text-purple-600 rounded-lg transition-colors"
            >
              <span class="w-3 h-3 bg-purple-500 rounded-full"></span>
              <span>Hoàn thành</span>
            </button>
            <button
              onclick="updateTreatmentStatus('CANCELLED')"
              class="w-full flex items-center gap-3 px-4 py-3 bg-slate-100 dark:bg-slate-800 hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 rounded-lg transition-colors"
            >
              <span class="w-3 h-3 bg-red-500 rounded-full"></span>
              <span>Đã hủy</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Print Template (Hidden) -->
    <div id="printTemplate" class="hidden print-only">
      <!-- Will be populated for printing -->
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-4 right-4 z-50 space-y-2"
    ></div>

    <!-- Scripts -->
    <script th:src="@{/js/doctor-sidebar-controller.js}"></script>
    <script>
      // Global state
      let treatments = [];
      let patients = [];
      let currentTreatmentId = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadTreatments();
        loadPatients();
      });

      // Load treatments from API
      async function loadTreatments() {
        try {
          const response = await fetch("/api/doctor/treatments");
          if (!response.ok) throw new Error("Failed to load treatments");

          const data = await response.json();
          treatments = data.treatments || [];

          updateStatistics();
          renderTreatments();
        } catch (error) {
          console.error("Error loading treatments:", error);
          showToast("Lỗi khi tải danh sách lộ trình", "error");
        } finally {
          document.getElementById("loadingState").classList.add("hidden");
        }
      }

      // Load patients for form
      async function loadPatients() {
        try {
          const response = await fetch("/doctor/api/patients");
          if (!response.ok) throw new Error("Failed to load patients");

          patients = await response.json();
          populatePatientSelect();
        } catch (error) {
          console.error("Error loading patients:", error);
        }
      }

      // Populate patient select
      function populatePatientSelect() {
        const select = document.getElementById("patientSelect");
        select.innerHTML = '<option value="">Chọn bệnh nhân</option>';
        patients.forEach((p) => {
          select.innerHTML += `<option value="${p.id}">${p.fullName} - ${p.phone || p.email}</option>`;
        });
      }

      // Update statistics
      function updateStatistics() {
        document.getElementById("totalTreatments").textContent =
          treatments.length;
        document.getElementById("activeTreatments").textContent =
          treatments.filter((t) => t.status === "ACTIVE").length;
        document.getElementById("completedTreatments").textContent =
          treatments.filter((t) => t.status === "COMPLETED").length;

        // Count upcoming checkups
        let upcomingCount = 0;
        treatments.forEach((t) => {
          if (t.checkupCount) upcomingCount += t.checkupCount;
        });
        document.getElementById("upcomingCheckups").textContent = upcomingCount;
      }

      // Render treatments
      function renderTreatments() {
        const grid = document.getElementById("treatmentsGrid");
        const emptyState = document.getElementById("emptyState");

        // Apply filters
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter").value;
        const dateFilter = document.getElementById("dateFilter").value;

        let filtered = treatments.filter((t) => {
          const matchSearch =
            !searchTerm ||
            (t.patientName &&
              t.patientName.toLowerCase().includes(searchTerm)) ||
            (t.diagnosis && t.diagnosis.toLowerCase().includes(searchTerm));
          const matchStatus = !statusFilter || t.status === statusFilter;
          const matchDate =
            !dateFilter || (t.startDate && t.startDate.startsWith(dateFilter));
          return matchSearch && matchStatus && matchDate;
        });

        if (filtered.length === 0) {
          grid.classList.add("hidden");
          emptyState.classList.remove("hidden");
          return;
        }

        emptyState.classList.add("hidden");
        grid.classList.remove("hidden");

        grid.innerHTML = filtered
          .map(
            (treatment) => `
          <div class="bg-white dark:bg-[#1a2634] rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden hover:shadow-lg transition-shadow">
            <div class="p-5">
              <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center">
                    <span class="material-symbols-outlined text-primary">assignment</span>
                  </div>
                  <div>
                    <h3 class="font-semibold text-slate-900 dark:text-white">${treatment.patientName || "N/A"}</h3>
                    <p class="text-xs text-slate-500 dark:text-slate-400">LT-${String(treatment.id).padStart(4, "0")}</p>
                  </div>
                </div>
                ${getStatusBadge(treatment.status)}
              </div>
              
              <div class="mb-4">
                <p class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2">${treatment.diagnosis || "Chưa có chẩn đoán"}</p>
              </div>
              
              <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
                  <span class="material-symbols-outlined text-[18px]">calendar_today</span>
                  <span>${formatDate(treatment.startDate)}</span>
                </div>
                <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
                  <span class="material-symbols-outlined text-[18px]">event</span>
                  <span>${treatment.checkupCount || 0} lịch tái khám</span>
                </div>
              </div>
              
              <div class="flex items-center gap-2 pt-4 border-t border-slate-200 dark:border-slate-700">
                <button onclick="viewTreatmentDetail(${treatment.id})" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors text-sm">
                  <span class="material-symbols-outlined text-[18px]">visibility</span>
                  Chi tiết
                </button>
                <button onclick="openCheckupModal(${treatment.id})" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-primary/10 hover:bg-primary/20 text-primary rounded-lg transition-colors text-sm">
                  <span class="material-symbols-outlined text-[18px]">event_available</span>
                  Tái khám
                </button>
                <div class="relative group">
                  <button class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
                    <span class="material-symbols-outlined">more_vert</span>
                  </button>
                  <div class="absolute right-0 top-full mt-1 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
                    <button onclick="openStatusModal(${treatment.id})" class="w-full flex items-center gap-2 px-4 py-2.5 hover:bg-slate-100 dark:hover:bg-slate-700 text-left">
                      <span class="material-symbols-outlined text-[18px]">sync</span>
                      Đổi trạng thái
                    </button>
                    <button onclick="editTreatment(${treatment.id})" class="w-full flex items-center gap-2 px-4 py-2.5 hover:bg-slate-100 dark:hover:bg-slate-700 text-left">
                      <span class="material-symbols-outlined text-[18px]">edit</span>
                      Chỉnh sửa
                    </button>
                    <button onclick="deleteTreatment(${treatment.id})" class="w-full flex items-center gap-2 px-4 py-2.5 hover:bg-red-50 dark:hover:bg-red-900/30 text-red-600 text-left">
                      <span class="material-symbols-outlined text-[18px]">delete</span>
                      Xóa
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `,
          )
          .join("");
      }

      // Get status badge HTML
      function getStatusBadge(status) {
        const badges = {
          DRAFT:
            '<span class="px-2.5 py-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-full text-xs font-medium">Nháp</span>',
          ACTIVE:
            '<span class="px-2.5 py-1 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full text-xs font-medium">Đang thực hiện</span>',
          COMPLETED:
            '<span class="px-2.5 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-full text-xs font-medium">Hoàn thành</span>',
          CANCELLED:
            '<span class="px-2.5 py-1 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full text-xs font-medium">Đã hủy</span>',
        };
        return badges[status] || badges.DRAFT;
      }

      // Filter treatments
      function filterTreatments() {
        renderTreatments();
      }

      // View treatment detail
      async function viewTreatmentDetail(id) {
        try {
          const response = await fetch(`/api/doctor/treatments/${id}`);
          if (!response.ok) throw new Error("Failed to load treatment");

          const treatment = await response.json();
          currentTreatmentId = id;
          renderTreatmentDetail(treatment);
          document
            .getElementById("treatmentDetailModal")
            .classList.remove("hidden");
        } catch (error) {
          console.error("Error:", error);
          showToast("Lỗi khi tải chi tiết lộ trình", "error");
        }
      }

      // Render treatment detail
      function renderTreatmentDetail(treatment) {
        const content = document.getElementById("treatmentDetailContent");

        content.innerHTML = `
          <div class="print-container">
            <!-- Header -->
            <div class="flex items-start justify-between mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
              <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-primary/10 rounded-xl flex items-center justify-center">
                  <span class="material-symbols-outlined text-primary text-3xl">assignment</span>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-slate-900 dark:text-white">LT-${String(treatment.id).padStart(4, "0")}</h3>
                  <p class="text-slate-500 dark:text-slate-400">${treatment.patientName || "N/A"}</p>
                </div>
              </div>
              ${getStatusBadge(treatment.status)}
            </div>
            
            <!-- Info Grid -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div>
                <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Chẩn đoán</h4>
                <p class="text-slate-900 dark:text-white">${treatment.diagnosis || "Chưa có"}</p>
              </div>
              <div>
                <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Mục tiêu điều trị</h4>
                <p class="text-slate-900 dark:text-white">${treatment.treatmentGoal || "Chưa thiết lập"}</p>
              </div>
              <div>
                <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Ngày bắt đầu</h4>
                <p class="text-slate-900 dark:text-white">${formatDate(treatment.startDate)}</p>
              </div>
              <div>
                <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Ngày dự kiến kết thúc</h4>
                <p class="text-slate-900 dark:text-white">${formatDate(treatment.expectedEndDate) || "Chưa xác định"}</p>
              </div>
            </div>
            
            <!-- Checkup Schedules -->
            <div class="mb-6">
              <div class="flex items-center justify-between mb-4">
                <h4 class="font-semibold text-slate-900 dark:text-white flex items-center gap-2">
                  <span class="material-symbols-outlined text-primary">event</span>
                  Lịch Tái Khám
                </h4>
                <button onclick="openCheckupModal(${treatment.id})" class="flex items-center gap-1 px-3 py-1.5 bg-primary/10 hover:bg-primary/20 text-primary rounded-lg text-sm no-print">
                  <span class="material-symbols-outlined text-[16px]">add</span>
                  Thêm lịch
                </button>
              </div>
              
              ${
                treatment.checkups && treatment.checkups.length > 0
                  ? `
                <div class="space-y-3">
                  ${treatment.checkups
                    .map(
                      (c) => `
                    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 ${getCheckupStatusBg(c.status)} rounded-lg flex items-center justify-center">
                          <span class="material-symbols-outlined ${getCheckupStatusColor(c.status)}">${getCheckupStatusIcon(c.status)}</span>
                        </div>
                        <div>
                          <p class="font-medium text-slate-900 dark:text-white">${formatDate(c.scheduledDate)}</p>
                          <p class="text-sm text-slate-500 dark:text-slate-400">${getCheckupTypeName(c.checkupType)}</p>
                        </div>
                      </div>
                      <div class="flex items-center gap-2">
                        ${getCheckupStatusBadge(c.status)}
                        <button onclick="updateCheckupStatus(${c.id}, '${c.status}')" class="p-1.5 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg no-print" title="Cập nhật trạng thái">
                          <span class="material-symbols-outlined text-[18px]">edit</span>
                        </button>
                      </div>
                    </div>
                  `,
                    )
                    .join("")}
                </div>
              `
                  : `
                <div class="text-center py-8 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                  <span class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600 mb-2">event_busy</span>
                  <p class="text-slate-500 dark:text-slate-400">Chưa có lịch tái khám</p>
                </div>
              `
              }
            </div>
            
            <!-- Quick Actions -->
            <div class="flex items-center gap-3 pt-4 border-t border-slate-200 dark:border-slate-700 no-print">
              <button onclick="openStatusModal(${treatment.id}); closeDetailModal();" class="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors">
                <span class="material-symbols-outlined text-[20px]">sync</span>
                Đổi trạng thái
              </button>
              <button onclick="editTreatment(${treatment.id}); closeDetailModal();" class="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors">
                <span class="material-symbols-outlined text-[20px]">edit</span>
                Chỉnh sửa
              </button>
            </div>
          </div>
        `;
      }

      // Checkup helpers
      function getCheckupStatusBg(status) {
        const map = {
          SCHEDULED: "bg-blue-100 dark:bg-blue-900/30",
          CONFIRMED: "bg-green-100 dark:bg-green-900/30",
          COMPLETED: "bg-purple-100 dark:bg-purple-900/30",
          CANCELLED: "bg-red-100 dark:bg-red-900/30",
          NO_SHOW: "bg-amber-100 dark:bg-amber-900/30",
        };
        return map[status] || map.SCHEDULED;
      }

      function getCheckupStatusColor(status) {
        const map = {
          SCHEDULED: "text-blue-600 dark:text-blue-400",
          CONFIRMED: "text-green-600 dark:text-green-400",
          COMPLETED: "text-purple-600 dark:text-purple-400",
          CANCELLED: "text-red-600 dark:text-red-400",
          NO_SHOW: "text-amber-600 dark:text-amber-400",
        };
        return map[status] || map.SCHEDULED;
      }

      function getCheckupStatusIcon(status) {
        const map = {
          SCHEDULED: "event",
          CONFIRMED: "event_available",
          COMPLETED: "check_circle",
          CANCELLED: "cancel",
          NO_SHOW: "person_off",
        };
        return map[status] || map.SCHEDULED;
      }

      function getCheckupStatusBadge(status) {
        const badges = {
          SCHEDULED:
            '<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded text-xs">Đã lên lịch</span>',
          CONFIRMED:
            '<span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded text-xs">Đã xác nhận</span>',
          COMPLETED:
            '<span class="px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded text-xs">Hoàn thành</span>',
          CANCELLED:
            '<span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded text-xs">Đã hủy</span>',
          NO_SHOW:
            '<span class="px-2 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 rounded text-xs">Không đến</span>',
        };
        return badges[status] || badges.SCHEDULED;
      }

      function getCheckupTypeName(type) {
        const names = {
          routine: "Tái khám định kỳ",
          follow_up: "Theo dõi",
          emergency: "Khẩn cấp",
        };
        return names[type] || "Tái khám";
      }

      // Close detail modal
      function closeDetailModal() {
        document.getElementById("treatmentDetailModal").classList.add("hidden");
        currentTreatmentId = null;
      }

      // Open form modal for create
      function openFormModal() {
        document.getElementById("formModalTitle").textContent =
          "Tạo Lộ Trình Điều Trị";
        document.getElementById("treatmentId").value = "";
        document.getElementById("patientSelect").value = "";
        document.getElementById("diagnosisInput").value = "";
        document.getElementById("treatmentGoalInput").value = "";
        document.getElementById("startDateInput").value = new Date()
          .toISOString()
          .split("T")[0];
        document.getElementById("endDateInput").value = "";
        document.getElementById("statusInput").value = "DRAFT";
        document
          .getElementById("treatmentFormModal")
          .classList.remove("hidden");
      }

      // Edit treatment
      async function editTreatment(id) {
        try {
          const response = await fetch(`/api/doctor/treatments/${id}`);
          if (!response.ok) throw new Error("Failed to load treatment");

          const treatment = await response.json();

          document.getElementById("formModalTitle").textContent =
            "Chỉnh Sửa Lộ Trình";
          document.getElementById("treatmentId").value = id;
          document.getElementById("patientSelect").value =
            treatment.patientId || "";
          document.getElementById("diagnosisInput").value =
            treatment.diagnosis || "";
          document.getElementById("treatmentGoalInput").value =
            treatment.treatmentGoal || "";
          document.getElementById("startDateInput").value =
            treatment.startDate || "";
          document.getElementById("endDateInput").value =
            treatment.expectedEndDate || "";
          document.getElementById("statusInput").value =
            treatment.status || "DRAFT";
          document
            .getElementById("treatmentFormModal")
            .classList.remove("hidden");
        } catch (error) {
          console.error("Error:", error);
          showToast("Lỗi khi tải thông tin lộ trình", "error");
        }
      }

      // Close form modal
      function closeFormModal() {
        document.getElementById("treatmentFormModal").classList.add("hidden");
      }

      // Save treatment
      async function saveTreatment(event) {
        event.preventDefault();

        const id = document.getElementById("treatmentId").value;
        const data = {
          patientId: document.getElementById("patientSelect").value,
          diagnosis: document.getElementById("diagnosisInput").value,
          treatmentGoal: document.getElementById("treatmentGoalInput").value,
          startDate: document.getElementById("startDateInput").value,
          expectedEndDate:
            document.getElementById("endDateInput").value || null,
          status: document.getElementById("statusInput").value,
        };

        try {
          const url = id
            ? `/api/doctor/treatments/${id}`
            : "/api/doctor/treatments";
          const method = id ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) throw new Error("Failed to save treatment");

          const result = await response.json();

          if (result.success) {
            showToast(
              id ? "Cập nhật lộ trình thành công" : "Tạo lộ trình thành công",
              "success",
            );
            closeFormModal();
            loadTreatments();
          } else {
            throw new Error(result.message || "Unknown error");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Lỗi khi lưu lộ trình: " + error.message, "error");
        }
      }

      // Delete treatment
      async function deleteTreatment(id) {
        if (
          !confirm(
            "Bạn có chắc chắn muốn xóa lộ trình này? Hành động này không thể hoàn tác.",
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`/api/doctor/treatments/${id}`, {
            method: "DELETE",
          });

          if (!response.ok) throw new Error("Failed to delete treatment");

          showToast("Xóa lộ trình thành công", "success");
          loadTreatments();
        } catch (error) {
          console.error("Error:", error);
          showToast("Lỗi khi xóa lộ trình", "error");
        }
      }

      // Open status modal
      function openStatusModal(id) {
        document.getElementById("statusChangeTreatmentId").value = id;
        document.getElementById("statusChangeModal").classList.remove("hidden");
      }

      // Close status modal
      function closeStatusModal() {
        document.getElementById("statusChangeModal").classList.add("hidden");
      }

      // Update treatment status
      async function updateTreatmentStatus(status) {
        const id = document.getElementById("statusChangeTreatmentId").value;

        try {
          const response = await fetch(
            `/api/doctor/treatments/${id}/status?status=${status}`,
            {
              method: "PUT",
            },
          );

          if (!response.ok) throw new Error("Failed to update status");

          showToast("Cập nhật trạng thái thành công", "success");
          closeStatusModal();
          loadTreatments();
        } catch (error) {
          console.error("Error:", error);
          showToast("Lỗi khi cập nhật trạng thái", "error");
        }
      }

      // Open checkup modal
      function openCheckupModal(treatmentId) {
        document.getElementById("checkupTreatmentId").value = treatmentId;
        document.getElementById("checkupDateInput").value = "";
        document.getElementById("checkupTypeInput").value = "routine";
        document.getElementById("checkupNotesInput").value = "";
        document.getElementById("checkupFormModal").classList.remove("hidden");
      }

      // Close checkup modal
      function closeCheckupModal() {
        document.getElementById("checkupFormModal").classList.add("hidden");
      }

      // Set checkup date (months from now)
      function setCheckupDate(months) {
        const date = new Date();
        date.setMonth(date.getMonth() + months);
        document.getElementById("checkupDateInput").value = date
          .toISOString()
          .split("T")[0];
      }

      // Save checkup
      async function saveCheckup(event) {
        event.preventDefault();

        const treatmentId = document.getElementById("checkupTreatmentId").value;
        const data = {
          scheduledDate: document.getElementById("checkupDateInput").value,
          checkupType: document.getElementById("checkupTypeInput").value,
          notes: document.getElementById("checkupNotesInput").value,
        };

        try {
          const response = await fetch(
            `/api/doctor/treatments/${treatmentId}/checkups`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            },
          );

          if (!response.ok) throw new Error("Failed to create checkup");

          const result = await response.json();

          if (result.success) {
            showToast("Tạo lịch tái khám thành công", "success");
            closeCheckupModal();
            loadTreatments();

            // Refresh detail modal if open
            if (currentTreatmentId) {
              viewTreatmentDetail(currentTreatmentId);
            }
          } else {
            throw new Error(result.message || "Unknown error");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Lỗi khi tạo lịch tái khám: " + error.message, "error");
        }
      }

      // Update checkup status
      async function updateCheckupStatus(checkupId, currentStatus) {
        const newStatus = prompt(
          "Nhập trạng thái mới:\n- SCHEDULED (Đã lên lịch)\n- CONFIRMED (Đã xác nhận)\n- COMPLETED (Hoàn thành)\n- CANCELLED (Đã hủy)\n- NO_SHOW (Không đến)",
          currentStatus,
        );

        if (!newStatus || newStatus === currentStatus) return;

        const validStatuses = [
          "SCHEDULED",
          "CONFIRMED",
          "COMPLETED",
          "CANCELLED",
          "NO_SHOW",
        ];
        if (!validStatuses.includes(newStatus.toUpperCase())) {
          showToast("Trạng thái không hợp lệ", "error");
          return;
        }

        try {
          const response = await fetch(
            `/api/doctor/checkups/${checkupId}/status`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: newStatus.toUpperCase() }),
            },
          );

          if (!response.ok) throw new Error("Failed to update checkup status");

          showToast("Cập nhật trạng thái tái khám thành công", "success");

          // Refresh detail modal
          if (currentTreatmentId) {
            viewTreatmentDetail(currentTreatmentId);
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Lỗi khi cập nhật trạng thái", "error");
        }
      }

      // Print treatment
      function printTreatment() {
        window.print();
      }

      // Export treatment as PDF (using browser print)
      function exportTreatment() {
        showToast(
          "Đang xuất PDF... Vui lòng chọn 'Save as PDF' trong hộp thoại in",
          "info",
        );
        setTimeout(() => {
          window.print();
        }, 500);
      }

      // Format date helper
      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleDateString("vi-VN");
      }

      // Toast helper
      function showToast(message, type = "info") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");

        const colors = {
          success: "bg-green-500",
          error: "bg-red-500",
          info: "bg-blue-500",
          warning: "bg-amber-500",
        };

        const icons = {
          success: "check_circle",
          error: "error",
          info: "info",
          warning: "warning",
        };

        toast.className = `flex items-center gap-3 px-4 py-3 ${colors[type]} text-white rounded-lg shadow-lg min-w-[300px]`;
        toast.innerHTML = `
          <span class="material-symbols-outlined">${icons[type]}</span>
          <span class="flex-1">${message}</span>
          <button onclick="this.parentElement.remove()" class="p-1 hover:bg-white/20 rounded">
            <span class="material-symbols-outlined text-[18px]">close</span>
          </button>
        `;

        container.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
    </script>
  </body>
</html>
