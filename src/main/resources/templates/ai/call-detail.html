<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết bệnh nhân - ABClinic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0"
    />
    <script src="/js/vendor/stringee/sdk.bundle.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#0d7cf2",
              secondary: "#6c757d",
              success: "#10b981",
              danger: "#ef4444",
              warning: "#f59e0b",
              dark: "#1e293b",
              darker: "#0f172a",
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .material-symbols-rounded {
        font-variation-settings:
          "FILL" 1,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      @keyframes pulse-ring {
        0% {
          transform: scale(0.8);
          opacity: 1;
        }
        100% {
          transform: scale(1.5);
          opacity: 0;
        }
      }
      .pulse-ring {
        animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
      }
      @keyframes recording-blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0.3;
        }
      }
      .recording-blink {
        animation: recording-blink 1s infinite;
      }
      .call-btn-active {
        animation: call-pulse 2s infinite;
      }
      @keyframes call-pulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(13, 124, 242, 0.4);
        }
        50% {
          box-shadow: 0 0 0 15px rgba(13, 124, 242, 0);
        }
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
      .status-dot.connected {
        background: #0d7cf2;
        box-shadow: 0 0 0 3px rgba(13, 124, 242, 0.2);
      }
      .status-dot.connecting {
        background: #f59e0b;
        animation: recording-blink 1s infinite;
      }
      .status-dot.disconnected {
        background: #ef4444;
      }
      .tab-active {
        border-bottom: 2px solid #0d7cf2;
        color: #0d7cf2;
      }
      
      /* Hierarchical recordings styles */
      .accordion-header {
        transition: all 0.2s ease;
      }
      .accordion-header:hover {
        background: #f8fafc;
      }
      .accordion-header .expand-icon {
        transition: transform 0.3s ease;
      }
      .accordion-header.expanded .expand-icon {
        transform: rotate(180deg);
      }
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .accordion-content.expanded {
        max-height: 5000px;
        transition: max-height 0.5s ease-in;
      }
      
      /* Recording section border */
      .recording-section {
        border: 2px solid #e2e8f0;
        transition: border-color 0.2s ease;
      }
      .recording-section.active {
        border-color: #ef4444;
      }
      
      /* Improved recording indicator */
      .recording-timer {
        font-size: 1.5rem;
        font-weight: 700;
        font-family: 'Courier New', monospace;
        letter-spacing: 0.05em;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <a
              href="/receptionist/callbot"
              class="flex items-center gap-2 text-gray-600 hover:text-primary transition-colors"
            >
              <span class="material-symbols-rounded">arrow_back</span>
              <span class="hidden sm:inline">Danh sách bệnh nhân</span>
            </a>
            <div class="h-6 w-px bg-gray-300"></div>
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center"
              >
                <span class="material-symbols-rounded text-white">person</span>
              </div>
              <div>
                <h1 class="text-lg font-semibold text-gray-800">
                  Chi tiết bệnh nhân
                </h1>
                <p class="text-xs text-gray-500" id="patientNameHeader">
                  Đang tải...
                </p>
              </div>
            </div>
          </div>
          <div
            id="headerStatus"
            class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100"
          >
            <div class="status-dot connecting" id="statusDot"></div>
            <span class="text-sm font-medium text-gray-600" id="statusText"
              >Đang kết nối...</span
            >
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: Patient Info & Call -->
        <div class="lg:col-span-1 space-y-6">
          <!-- Patient Info Card -->
          <div
            class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
          >
            <div
              class="bg-gradient-to-br from-primary to-blue-600 p-6 text-white text-center"
            >
              <div
                id="patientAvatar"
                class="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center mx-auto text-2xl font-bold mb-3"
              >
                ...
              </div>
              <h2 id="patientName" class="text-xl font-semibold">
                Đang tải...
              </h2>
              <p id="patientMeta" class="text-white/70 text-sm mt-1">---</p>
            </div>
            <div class="p-4 space-y-3">
              <div class="flex items-center gap-3 text-gray-600">
                <span class="material-symbols-rounded text-primary">phone</span>
                <span id="patientPhone">---</span>
              </div>
              <div class="flex items-center gap-3 text-gray-600">
                <span class="material-symbols-rounded text-primary">mail</span>
                <span id="patientEmail" class="truncate">---</span>
              </div>
              <div class="flex items-center gap-3 text-gray-600">
                <span class="material-symbols-rounded text-primary"
                  >location_on</span
                >
                <span id="patientAddress" class="truncate">---</span>
              </div>
              <div class="flex items-center gap-3 text-gray-600">
                <span class="material-symbols-rounded text-primary">badge</span>
                <span id="patientStringeeId" class="font-mono text-sm"
                  >---</span
                >
              </div>
            </div>
          </div>

          <!-- Call Control Card -->
          <div
            class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
          >
            <div
              class="bg-gradient-to-r from-gray-50 to-white px-6 py-4 border-b border-gray-100"
            >
              <h2 class="font-semibold text-gray-800 flex items-center gap-2">
                <span class="material-symbols-rounded text-primary"
                  >phone_in_talk</span
                >
                Gọi điện
              </h2>
            </div>
            <div class="p-6">
              <!-- Auto Record -->
              <div class="mb-4 p-3 bg-gray-50 rounded-xl">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    id="autoRecordCheckbox"
                    checked
                    class="w-5 h-5 rounded text-primary focus:ring-primary"
                  />
                  <div>
                    <span class="font-medium text-gray-800 text-sm"
                      >Tự động ghi âm</span
                    >
                    <p class="text-xs text-gray-500">Ghi lại cuộc hội thoại</p>
                  </div>
                </label>
              </div>

              <!-- Call Status -->
              <div
                id="callStatusBox"
                class="mb-4 p-4 rounded-xl bg-gray-100 text-center hidden"
              >
                <p id="callStatus" class="text-lg font-medium text-gray-700">
                  Sẵn sàng
                </p>
                <p
                  id="callDuration"
                  class="text-3xl font-light text-gray-800 mt-2 hidden"
                >
                  00:00
                </p>
              </div>

              <!-- Recording Section with Border and Header -->
              <div class="mb-4 recording-section rounded-xl p-4 hidden" id="recordingSection">
                <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-200">
                  <span class="material-symbols-rounded text-primary">mic</span>
                  <h4 class="font-semibold text-gray-800">Ghi âm cuộc gọi</h4>
                </div>
                
                <!-- Recording Indicator with Larger Timer -->
                <div
                  id="recordingInfo"
                  class="hidden"
                >
                  <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full bg-red-500 recording-blink"></div>
                        <span class="font-semibold text-red-700">Đang ghi âm...</span>
                      </div>
                      <span
                        id="recordingDuration"
                        class="recording-timer text-red-600"
                      >00:00</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Call Buttons -->
              <!-- Call Buttons -->
              <div class="flex flex-col gap-3">
                <button
                  id="btnCall"
                  onclick="makeCall()"
                  class="flex items-center justify-center gap-2 w-full px-6 py-4 bg-primary text-white rounded-xl font-semibold hover:bg-primary/90 transition-all shadow-lg shadow-primary/30 call-btn-active"
                >
                  <span class="material-symbols-rounded text-2xl">call</span>
                  Gọi ngay
                </button>
                <button
                  id="btnHangup"
                  onclick="hangupCall()"
                  class="flex items-center justify-center gap-2 w-full px-6 py-4 bg-danger text-white rounded-xl font-semibold hover:bg-danger/90 transition-all hidden"
                >
                  <span class="material-symbols-rounded text-2xl"
                    >call_end</span
                  >
                  Kết thúc cuộc gọi
                </button>
                <button
                  id="btnAnswer"
                  onclick="answerCall()"
                  class="flex items-center justify-center gap-2 w-full px-6 py-4 bg-success text-white rounded-xl font-semibold hidden"
                >
                  <span class="material-symbols-rounded text-2xl">call</span>
                  Trả lời cuộc gọi
                </button>
              </div>

              <!-- Call Controls (Mute & Speaker) - Hiện khi đang trong cuộc gọi -->
              <div
                id="callControls"
                class="hidden flex justify-center gap-4 mt-4"
              >
                <button
                  id="btnMute"
                  onclick="toggleMute()"
                  class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 transition-all"
                >
                  <div
                    id="muteIconWrapper"
                    class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center"
                  >
                    <span
                      id="muteIcon"
                      class="material-symbols-rounded text-xl text-gray-600"
                      >mic</span
                    >
                  </div>
                  <span id="muteLabel" class="text-xs text-gray-500"
                    >Tắt mic</span
                  >
                </button>
                <button
                  id="btnSpeaker"
                  onclick="toggleSpeaker()"
                  class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 transition-all"
                >
                  <div
                    id="speakerIconWrapper"
                    class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center"
                  >
                    <span
                      id="speakerIcon"
                      class="material-symbols-rounded text-xl text-gray-600"
                      >volume_up</span
                    >
                  </div>
                  <span id="speakerLabel" class="text-xs text-gray-500"
                    >Tắt loa</span
                  >
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Tabs Content -->
        <div class="lg:col-span-2">
          <div
            class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
          >
            <!-- Tabs -->
            <div class="flex border-b border-gray-200">
              <button
                onclick="switchTab('recordings')"
                id="tabRecordings"
                class="flex-1 px-6 py-4 text-sm font-medium text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors tab-active"
              >
                <span class="material-symbols-rounded text-lg align-middle mr-2"
                  >audio_file</span
                >
                File ghi âm
              </button>
              <button
                onclick="switchTab('activity')"
                id="tabActivity"
                class="flex-1 px-6 py-4 text-sm font-medium text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors"
              >
                <span class="material-symbols-rounded text-lg align-middle mr-2"
                  >history</span
                >
                Nhật ký hoạt động
              </button>
            </div>

            <!-- Tab Content: Recordings -->
            <div id="contentRecordings" class="p-4">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-800">
                  File ghi âm của bệnh nhân này
                </h3>
                <button
                  onclick="loadRecordings()"
                  class="flex items-center gap-1 px-3 py-1.5 text-sm text-primary hover:bg-primary/10 rounded-lg"
                >
                  <span class="material-symbols-rounded text-lg">refresh</span>
                  Làm mới
                </button>
              </div>
              <div
                id="recordingsList"
                class="space-y-3 max-h-[500px] overflow-y-auto custom-scrollbar"
              >
                <div class="p-8 text-center text-gray-500">
                  <span class="material-symbols-rounded text-4xl text-gray-300"
                    >audio_file</span
                  >
                  <p class="mt-2">Đang tải danh sách file...</p>
                </div>
              </div>
            </div>

            <!-- Tab Content: Activity Log -->
            <div id="contentActivity" class="p-4 hidden">
              <div
                id="logConsole"
                class="h-[500px] overflow-y-auto custom-scrollbar bg-gray-900 rounded-xl p-4 font-mono text-sm"
              >
                <div class="text-blue-400">
                  <span class="text-gray-500">[System]</span> Đang khởi tạo...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Hidden elements -->
    <div id="remote_videos" style="display: none"></div>

    <!-- Audio Player Modal -->
    <div
      id="audioPlayerModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-gray-800 flex items-center gap-2">
            <span class="material-symbols-rounded text-primary"
              >music_note</span
            >
            <span id="audioPlayerTitle">Đang phát...</span>
          </h3>
          <button
            onclick="closeAudioPlayer()"
            class="text-gray-400 hover:text-gray-600"
          >
            <span class="material-symbols-rounded">close</span>
          </button>
        </div>
        <audio id="audioPlayer" controls class="w-full"></audio>
      </div>
    </div>

    <script th:inline="javascript">
      const STRINGEE_SERVER_ADDRS = [
        "wss://v1.stringee.com:6899/",
        "wss://v2.stringee.com:6899/",
      ];

      // Get patient ID from URL
      const patientId = /*[[${patientId}]]*/ null;

      var stringeeClient,
        currentCall,
        myToken,
        currentUser = null,
        patient = null;
      
      // 3 MediaRecorders for caller, receiver, combined
      var mediaRecorderCaller,
        mediaRecorderReceiver,
        mediaRecorderCombined;
      var recordedChunksCaller = [],
        recordedChunksReceiver = [],
        recordedChunksCombined = [];
      var recordingStartTime,
        recordingInterval,
        callDurationInterval,
        callStartTime;
      var localStream = null,
        remoteStream = null,
        audioContext = null,
        mixedStream = null;
      var isRecording = false; // Trạng thái ghi âm
      
      // Database call ID - để liên kết recording với WebCallLog
      var currentDbCallId = null;
      
      // Trạng thái mic và loa
      var isMuted = false;
      var isSpeakerOn = true;

      document.addEventListener("DOMContentLoaded", function () {
        loadPatientInfo();
        loadCurrentUser();
      });

      function switchTab(tab) {
        document
          .querySelectorAll('[id^="tab"]')
          .forEach((t) => t.classList.remove("tab-active"));
        document
          .querySelectorAll('[id^="content"]')
          .forEach((c) => c.classList.add("hidden"));
        document
          .getElementById("tab" + tab.charAt(0).toUpperCase() + tab.slice(1))
          .classList.add("tab-active");
        document
          .getElementById(
            "content" + tab.charAt(0).toUpperCase() + tab.slice(1),
          )
          .classList.remove("hidden");
      }

      async function loadPatientInfo() {
        if (!patientId) {
          showNotification("Lỗi", "Không tìm thấy ID bệnh nhân", "error", 5000);
          return;
        }
        try {
          const response = await fetch("/api/patients/" + patientId);
          if (!response.ok)
            throw new Error("Không thể tải thông tin bệnh nhân");
          patient = await response.json();

          const fullName =
            patient.fullName ||
            (patient.userInfo && patient.userInfo.fullName) ||
            "Chưa có tên";
          const gender =
            patient.gender || (patient.userInfo && patient.userInfo.gender);
          const dob =
            patient.dateOfBirth ||
            (patient.userInfo && patient.userInfo.dateOfBirth);
          const age = dob ? calculateAge(dob) : "?";
          const initials = getInitials(fullName);

          document.getElementById("patientNameHeader").textContent = fullName;
          document.getElementById("patientAvatar").textContent = initials;
          document.getElementById("patientName").textContent = fullName;
          document.getElementById("patientMeta").textContent =
            (gender === "MALE"
              ? "Nam"
              : gender === "FEMALE"
                ? "Nữ"
                : "Chưa rõ") +
            " • " +
            age +
            " tuổi";
          document.getElementById("patientPhone").textContent =
            patient.phoneNumber || "Chưa có";
          document.getElementById("patientEmail").textContent =
            patient.email || "Chưa có";
          document.getElementById("patientAddress").textContent =
            patient.address ||
            (patient.userInfo && patient.userInfo.address) ||
            "Chưa có";
          document.getElementById("patientStringeeId").textContent =
            "user_" + patient.id;

          addLog("Đã tải thông tin bệnh nhân: " + fullName, "success");
          showNotification("Đã tải thông tin", `Thông tin bệnh nhân ${fullName} đã sẵn sàng`, "success", 2000);
        } catch (err) {
          console.error("Lỗi:", err);
          addLog("Lỗi tải thông tin bệnh nhân: " + err.message, "error");
          showNotification("Lỗi tải thông tin", `Không thể tải thông tin bệnh nhân: ${err.message}`, "error", 5000);
        }
      }

      async function loadCurrentUser() {
        try {
          const response = await fetch("/api/web-call/current-user");
          if (!response.ok) throw new Error("Không thể lấy thông tin user");
          const data = await response.json();
          if (data.authenticated) {
            currentUser = data;
            addLog("Đăng nhập với: " + currentUser.fullName, "info");
            await connectStringee();
          } else {
            addLog("Chưa đăng nhập", "error");
            alert("Vui lòng đăng nhập để sử dụng chức năng gọi điện");
          }
        } catch (err) {
          console.error("Lỗi:", err);
          addLog("Lỗi: " + err.message, "error");
        }
      }

      function updateConnectionStatus(status) {
        const dot = document.getElementById("statusDot");
        const text = document.getElementById("statusText");
        dot.className = "status-dot " + status;
        switch (status) {
          case "connected":
            text.textContent = "Đã kết nối";
            text.className = "text-sm font-medium text-primary";
            break;
          case "connecting":
            text.textContent = "Đang kết nối...";
            text.className = "text-sm font-medium text-yellow-600";
            break;
          case "disconnected":
            text.textContent = "Mất kết nối";
            text.className = "text-sm font-medium text-red-600";
            break;
        }
      }

      function addLog(message, type = "info") {
        const logBox = document.getElementById("logConsole");
        const timestamp = new Date().toLocaleTimeString();

        const colors = {
          info: "text-blue-400",
          success: "text-green-400",
          error: "text-red-400",
          warning: "text-yellow-400",
        };
        const icons = { info: "ℹ️", success: "✅", error: "❌", warning: "⚠️" };
        const logEntry = document.createElement("div");
        logEntry.className = `${colors[type]} py-1`;
        logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${icons[type]} ${message}`;
        logBox.appendChild(logEntry);
        logBox.scrollTop = logBox.scrollHeight;
      }

      async function connectStringee() {
        if (!currentUser) return;
        try {
          const res = await fetch("/api/web-call/token");
          if (!res.ok) throw new Error("HTTP error! status: " + res.status);
          const data = await res.json();
          if (!data.token) throw new Error("Token không có trong response");
          myToken = data.token;
          addLog("Đã nhận access token", "success");
        } catch (err) {
          addLog("Lỗi lấy token: " + err.message, "error");
          showNotification("Lỗi kết nối", `Không thể lấy token: ${err.message}`, "error", 5000);
          return;
        }

        stringeeClient = new StringeeClient(STRINGEE_SERVER_ADDRS);
        stringeeClient.on("connect", () => {
          updateConnectionStatus("connected");
          addLog("Đã kết nối Stringee", "success");
          showNotification("Đã kết nối", "Hệ thống cuộc gọi đã sẵn sàng", "success", 2000);
        });
        stringeeClient.on("authen", (res) => {
          if (res.r === 0) {
            addLog("Xác thực thành công!", "success");
            loadRecordings();
          } else {
            addLog("Xác thực thất bại: " + res.message, "error");
            showNotification("Xác thực thất bại", `Lỗi: ${res.message}`, "error", 5000);
          }
        });
        stringeeClient.on("disconnect", () => {
          updateConnectionStatus("disconnected");
          addLog("Mất kết nối", "error");
          showNotification("Mất kết nối", "Đã mất kết nối với hệ thống cuộc gọi", "error", 5000);
        });
        stringeeClient.on("incomingcall", (incomingCall) => {
          addLog("Cuộc gọi đến từ: " + incomingCall.fromNumber, "info");
          currentCall = incomingCall;
          settingCallEvents(currentCall);
          // Hiển thị UI cho cuộc gọi đến
          document.getElementById("btnAnswer").classList.remove("hidden");
          document.getElementById("btnAnswer").classList.add("animate-pulse");
          document.getElementById("btnCall").classList.add("hidden");
          showCallStatus("Cuộc gọi đến...", "calling");
          // Hiển thị thông báo
          showNotification(
            "Cuộc gọi đến",
            "Có cuộc gọi từ " + incomingCall.fromNumber,
            "info",
          );
        });
        stringeeClient.connect(myToken);
      }

      function makeCall() {
        if (!currentUser || !patient) {
          showNotification("Chưa sẵn sàng", "Vui lòng đợi tải xong thông tin", "warning", 3000);
          return;
        }
        const calleeId = "user_" + patient.id;
        addLog("Đang gọi tới: " + calleeId, "info");
        showCallStatus("Đang gọi...", "calling");
        showNotification("Đang gọi", `Đang kết nối đến ${patient.fullName || 'bệnh nhân'}`, "info", 2000);

        currentCall = new StringeeCall(
          stringeeClient,
          currentUser.stringeeUserId,
          calleeId,
          false,
        );
        
        // Tạo WebCallLog trong database trước khi gọi
        createWebCallLog(patient.id, currentCall.callId || 'temp_' + Date.now());
        
        settingCallEvents(currentCall);
        currentCall.makeCall(function (res) {
          if (res.r !== 0) {
            addLog("Gọi thất bại: " + res.message, "error");
            // Cập nhật trạng thái cuộc gọi thất bại
            if (currentDbCallId) {
              updateCallStatus(currentDbCallId, 'FAILED');
            }
            resetUI();
          }
        });
        showInCallUI();
      }
      
      // Tạo WebCallLog trong database
      async function createWebCallLog(receiverId, stringeeCallId) {
        try {
          const response = await fetch('/api/web-call/initiate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              receiverId: receiverId,
              stringeeCallId: stringeeCallId
            })
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.callLogId) {
              currentDbCallId = result.callLogId;
              addLog(`Đã tạo call log #${currentDbCallId}`, "info");
            } else {
              addLog("API trả về không hợp lệ: " + JSON.stringify(result), "warning");
            }
          } else {
            const errorText = await response.text();
            addLog("API lỗi: " + response.status + " - " + errorText, "error");
          }
        } catch (err) {
          console.error("Error creating call log:", err);
          addLog("Không thể tạo call log: " + err.message, "warning");
        }
      }
      
      // Cập nhật trạng thái cuộc gọi
      async function updateCallStatus(callId, status) {
        try {
          const response = await fetch(`/api/web-call/${callId}/status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: status })
          });
          if (response.ok) {
            addLog(`Cập nhật trạng thái: ${status}`, "info");
          }
        } catch (err) {
          console.error("Error updating call status:", err);
        }
      }

      function settingCallEvents(call) {
        // Event: Nhan luong am thanh tu remote
        // Stringee SDK tra ve MediaStream object, can gan vao srcObject cua video/audio element
        call.on("addremotestream", (stream) => {
          addLog("Da nhan luong am thanh tu remote", "success");
          console.log("Remote stream received:", stream);

          // Lưu remoteStream để dùng cho recording
          if (stream instanceof MediaStream) {
            remoteStream = stream;
          } else if (stream && stream.stream instanceof MediaStream) {
            remoteStream = stream.stream;
          }

          // Xoa video element cu neu co
          const oldElement = document.getElementById("remoteAudio");
          if (oldElement) {
            oldElement.remove();
          }

          // Tao video element moi de phat am thanh
          var videoElement = document.createElement("video");
          videoElement.setAttribute("autoplay", "");
          videoElement.setAttribute("playsinline", "");
          videoElement.setAttribute("id", "remoteAudio");
          videoElement.style.display = "none"; // An vi chi can am thanh
          document.getElementById("remote_videos").appendChild(videoElement);

          // Gan MediaStream vao srcObject (cach dung cua Web API)
          // Stringee SDK co the tra ve MediaStream truc tiep hoac object co stream property
          if (stream instanceof MediaStream) {
            videoElement.srcObject = stream;
          } else if (stream && stream.stream instanceof MediaStream) {
            videoElement.srcObject = stream.stream;
          } else if (stream && typeof stream.play === "function") {
            // Fallback cho Stringee SDK cu
            stream.play(videoElement);
          } else {
            console.warn("Khong the xu ly remote stream:", stream);
            addLog("Loi: Khong the phat am thanh tu remote", "error");
          }

          // Tu dong bat dau ghi am neu duoc bat
          if (document.getElementById("autoRecordCheckbox").checked) {
            setTimeout(() => startRecording(), 500);
          }
        });

        // Event: Luong local da san sang
        call.on("addlocalstream", (stream) => {
          addLog("Luong local da san sang", "info");
          console.log("Local stream added:", stream);
        });

        // Event: Trạng thái media thay đổi
        call.on("mediastate", (state) => {
          console.log("Media state:", state);
          addLog("Media: " + state.reason, "info");
        });

        // Event: Trạng thái signaling thay đổi (quan trọng nhất)
        call.on("signalingstate", (state) => {
          console.log("Signaling state:", state.code, state.reason);
          addLog("Trạng thái: " + state.reason, "info");

          switch (state.code) {
            case 1: // Calling
              showCallStatus("Đang gọi...", "calling");
              break;
            case 2: // Ringing
              showCallStatus("Đang đổ chuông...", "calling");
              if (currentDbCallId) updateCallStatus(currentDbCallId, 'RINGING');
              break;
            case 3: // Answered - đã bắt máy
              showCallStatus("Đang trong cuộc gọi", "connected");
              showInCallUI();
              startCallDurationTimer();
              if (currentDbCallId) updateCallStatus(currentDbCallId, 'ANSWERED');
              break;
            case 4: // Busy
              addLog("Máy bận", "warning");
              showCallStatus("Máy bận", "ended");
              if (currentDbCallId) updateCallStatus(currentDbCallId, 'MISSED');
              showNotification(
                "Máy bận",
                "Bệnh nhân đang bận, vui lòng thử lại sau",
                "warning",
              );
              setTimeout(() => resetUI(), 2000);
              break;
            case 5: // Ended - cuộc gọi kết thúc bình thường
              console.log('Call ended normally (state 5)');
              addLog("Cuộc gọi đã kết thúc", "success");
              showCallStatus("Đã kết thúc", "ended");
              if (currentDbCallId) updateCallStatus(currentDbCallId, 'COMPLETED');
              showNotification(
                "Cuộc gọi kết thúc",
                "Cuộc gọi đã được kết thúc",
                "info",
              );
              // Dừng và upload recordings trước khi reset UI
              if (isRecording) {
                console.log('Stopping recording on call end (state 5)');
                stopRecording();
              }
              setTimeout(() => resetUI(), 3000);
              break;
            case 6: // Rejected hoặc Remote Hangup
              console.log('Call state 6 - checking if was answered:', callStartTime);
              // Nếu đã có callStartTime = cuộc gọi đã được trả lời => đây là remote hangup, không phải reject
              if (callStartTime) {
                addLog("Bệnh nhân đã kết thúc cuộc gọi", "info");
                showCallStatus("Đã kết thúc", "ended");
                if (currentDbCallId) updateCallStatus(currentDbCallId, 'COMPLETED');
                showNotification(
                  "Cuộc gọi kết thúc",
                  "Bệnh nhân đã kết thúc cuộc gọi",
                  "info",
                );
              } else {
                addLog("Bệnh nhân đã từ chối cuộc gọi", "warning");
                showCallStatus("Bị từ chối", "ended");
                if (currentDbCallId) updateCallStatus(currentDbCallId, 'REJECTED');
                showNotification(
                  "Cuộc gọi bị từ chối",
                  "Bệnh nhân đã từ chối cuộc gọi",
                  "error",
                );
              }
              // Dừng và upload recordings trước khi reset UI
              if (isRecording) {
                console.log('Stopping recording on state 6');
                stopRecording();
              }
              setTimeout(() => resetUI(), 3000);
              break;
          }
        });

        // Event: Cuộc gọi kết thúc từ phía remote
        call.on("remotestream", (stream) => {
          // Stream ended từ phía remote
        });

        // Event: Thông tin cuộc gọi
        call.on("info", (info) => {
          console.log("Call info:", info);
        });

        // Event: Thiết bị khác xử lý cuộc gọi
        call.on("otherdevice", (data) => {
          console.log("Other device event:", data);
          if (data.type === "answer" || data.type === "reject") {
            addLog("Cuộc gọi được xử lý từ thiết bị khác", "info");
            resetUI();
          }
        });

        // Event: Lỗi cuộc gọi
        call.on("error", (error) => {
          console.error("Call error:", error);
          addLog("Lỗi: " + (error.message || "Không xác định"), "error");
          showCallStatus("Lỗi", "ended");
          setTimeout(() => resetUI(), 2000);
        });
      }

      function showCallStatus(message, type) {
        const box = document.getElementById("callStatusBox");
        const status = document.getElementById("callStatus");
        box.classList.remove(
          "hidden",
          "bg-gray-100",
          "bg-green-100",
          "bg-red-100",
          "bg-yellow-100",
          "bg-blue-100",
        );
        box.classList.add(
          type === "calling"
            ? "bg-yellow-100"
            : type === "connected"
              ? "bg-green-100"
              : type === "ended"
                ? "bg-red-100"
                : "bg-gray-100",
        );
        status.textContent = message;
      }

      function startCallDurationTimer() {
        callStartTime = Date.now();
        document.getElementById("callDuration").classList.remove("hidden");
        callDurationInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
          document.getElementById("callDuration").textContent =
            Math.floor(elapsed / 60)
              .toString()
              .padStart(2, "0") +
            ":" +
            (elapsed % 60).toString().padStart(2, "0");
        }, 1000);
      }

      function showInCallUI() {
        document.getElementById("btnCall").classList.add("hidden");
        document.getElementById("btnAnswer").classList.add("hidden");
        document.getElementById("btnAnswer").classList.remove("animate-pulse");
        document.getElementById("btnHangup").classList.remove("hidden");
        document.getElementById("btnHangup").style.display = "flex";
        // Hiển thị nút điều khiển Mute/Speaker
        document.getElementById("callControls").classList.remove("hidden");
      }

      // Ẩn UI điều khiển cuộc gọi
      function hideCallControls() {
        document.getElementById("callControls").classList.add("hidden");
        // Reset trạng thái
        resetMuteState();
        resetSpeakerState();
      }

      // Bật/tắt mic
      function toggleMute() {
        if (!currentCall) return;

        isMuted = !isMuted;
        currentCall.mute(isMuted);

        const iconWrapper = document.getElementById("muteIconWrapper");
        const icon = document.getElementById("muteIcon");
        const label = document.getElementById("muteLabel");

        if (isMuted) {
          icon.textContent = "mic_off";
          label.textContent = "Bật mic";
          iconWrapper.classList.remove("bg-gray-100");
          iconWrapper.classList.add("bg-red-500");
          icon.classList.remove("text-gray-600");
          icon.classList.add("text-white");
          addLog("Đã tắt mic", "warning");
        } else {
          icon.textContent = "mic";
          label.textContent = "Tắt mic";
          iconWrapper.classList.remove("bg-red-500");
          iconWrapper.classList.add("bg-gray-100");
          icon.classList.remove("text-white");
          icon.classList.add("text-gray-600");
          addLog("Đã bật mic", "info");
        }
      }

      // Bật/tắt loa
      function toggleSpeaker() {
        const remoteAudio = document.getElementById("remoteAudio");
        if (!remoteAudio) return;

        isSpeakerOn = !isSpeakerOn;
        remoteAudio.muted = !isSpeakerOn;

        const iconWrapper = document.getElementById("speakerIconWrapper");
        const icon = document.getElementById("speakerIcon");
        const label = document.getElementById("speakerLabel");

        if (isSpeakerOn) {
          icon.textContent = "volume_up";
          label.textContent = "Tắt loa";
          iconWrapper.classList.remove("bg-amber-500");
          iconWrapper.classList.add("bg-gray-100");
          icon.classList.remove("text-white");
          icon.classList.add("text-gray-600");
          addLog("Đã bật loa", "info");
        } else {
          icon.textContent = "volume_off";
          label.textContent = "Bật loa";
          iconWrapper.classList.remove("bg-gray-100");
          iconWrapper.classList.add("bg-amber-500");
          icon.classList.remove("text-gray-600");
          icon.classList.add("text-white");
          addLog("Đã tắt loa", "warning");
        }
      }

      // Reset trạng thái mute
      function resetMuteState() {
        isMuted = false;
        const iconWrapper = document.getElementById("muteIconWrapper");
        const icon = document.getElementById("muteIcon");
        const label = document.getElementById("muteLabel");
        if (iconWrapper) {
          iconWrapper.classList.remove("bg-red-500");
          iconWrapper.classList.add("bg-gray-100");
        }
        if (icon) {
          icon.textContent = "mic";
          icon.classList.remove("text-white");
          icon.classList.add("text-gray-600");
        }
        if (label) label.textContent = "Tắt mic";
      }

      // Reset trạng thái speaker
      function resetSpeakerState() {
        isSpeakerOn = true;
        const iconWrapper = document.getElementById("speakerIconWrapper");
        const icon = document.getElementById("speakerIcon");
        const label = document.getElementById("speakerLabel");
        if (iconWrapper) {
          iconWrapper.classList.remove("bg-amber-500");
          iconWrapper.classList.add("bg-gray-100");
        }
        if (icon) {
          icon.textContent = "volume_up";
          icon.classList.remove("text-white");
          icon.classList.add("text-gray-600");
        }
        if (label) label.textContent = "Tắt loa";
      }

      // Create notification container if not exists
      function initNotificationContainer() {
        if (!document.getElementById('notificationContainer')) {
          const container = document.createElement('div');
          container.id = 'notificationContainer';
          container.className = 'fixed top-20 right-4 z-50 flex flex-col gap-2 pointer-events-none';
          container.style.maxWidth = '400px';
          document.body.appendChild(container);
        }
      }

      // Universal notification function with stacking support
      function showNotification(title, message, type = "info", duration = 3000) {
        initNotificationContainer();
        const container = document.getElementById('notificationContainer');
        
        // Xác định config dựa vào type
        const configs = {
          success: {
            icon: "check_circle",
            bgColor: "bg-green-500",
            defaultTitle: "Thành công"
          },
          error: {
            icon: "error",
            bgColor: "bg-red-500",
            defaultTitle: "Lỗi"
          },
          info: {
            icon: "info",
            bgColor: "bg-blue-500",
            defaultTitle: "Thông báo"
          },
          warning: {
            icon: "warning",
            bgColor: "bg-yellow-500",
            defaultTitle: "Cảnh báo"
          }
        };
        
        const config = configs[type] || configs.info;
        const finalTitle = title || config.defaultTitle;
        
        // Tạo notification element
        const notification = document.createElement("div");
        notification.className = `${config.bgColor} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transition-all duration-300 pointer-events-auto opacity-0 translate-x-full`;
        notification.innerHTML = `
          <span class="material-symbols-rounded text-2xl">${config.icon}</span>
          <div class="flex-1">
            <p class="font-semibold">${finalTitle}</p>
            <p class="text-sm text-white/90">${message}</p>
          </div>
          <button onclick="this.parentElement.remove()" class="ml-4 text-white/70 hover:text-white">
            <span class="material-symbols-rounded">close</span>
          </button>
        `;

        container.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.classList.remove("opacity-0", "translate-x-full");
        }, 100);

        // Auto remove
        setTimeout(() => {
          notification.classList.add("opacity-0", "translate-x-full");
          setTimeout(() => notification.remove(), 300);
        }, duration);
      }

      function hangupCall() {
        console.log('hangupCall() called, isRecording:', isRecording);
        addLog('Đang kết thúc cuộc gọi...', 'info');
        
        // Dừng và upload recordings trước khi reset UI
        if (isRecording) {
          console.log('Stopping recording before hangup');
          stopRecording();
        }
        
        if (currentCall) {
          console.log('Hanging up currentCall');
          currentCall.hangup(function (res) {
            console.log('Hangup result:', res);
          });
        }
        
        // Delay resetUI để đợi upload hoàn tất
        setTimeout(() => resetUI(), 500);
      }

      function answerCall() {
        if (currentCall) {
          // Cập nhật UI ngay lập tức khi nhấn nút trả lời
          showInCallUI();
          showCallStatus("Đang kết nối...", "calling");

          currentCall.answer(function (res) {
            if (res.r === 0) {
              showCallStatus("Đang trong cuộc gọi", "connected");
              startCallDurationTimer();
              if (document.getElementById("autoRecordCheckbox").checked) {
                setTimeout(() => startRecording(), 1000);
              }
            } else {
              // Lỗi khi trả lời
              addLog("Lỗi trả lời cuộc gọi: " + res.message, "error");
              showNotification(
                "Lỗi",
                "Không thể trả lời cuộc gọi: " + res.message,
                "error",
              );
              resetUI();
            }
          });
        }
      }

      function resetUI() {
        // Stop all 3 recorders if recording
        if (mediaRecorderCaller && mediaRecorderCaller.state === "recording")
          mediaRecorderCaller.stop();
        if (mediaRecorderReceiver && mediaRecorderReceiver.state === "recording")
          mediaRecorderReceiver.stop();
        if (mediaRecorderCombined && mediaRecorderCombined.state === "recording")
          mediaRecorderCombined.stop();
        
        if (callDurationInterval) {
          clearInterval(callDurationInterval);
          callDurationInterval = null;
        }
        if (localStream) {
          localStream.getTracks().forEach((t) => t.stop());
          localStream = null;
        }
        if (remoteStream) {
          remoteStream = null;
        }
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
        document.getElementById("callStatusBox").classList.add("hidden");
        document.getElementById("callDuration").classList.add("hidden");
        document.getElementById("btnCall").classList.remove("hidden");
        document.getElementById("btnAnswer").classList.add("hidden");
        document.getElementById("btnHangup").classList.add("hidden");
        document.getElementById("btnHangup").style.display = "";
        document.getElementById("recordingInfo").classList.add("hidden");
        document.getElementById("recordingSection").classList.add("hidden");
        document.getElementById("remote_videos").innerHTML = "";
        // Ẩn call controls và reset trạng thái
        hideCallControls();
        currentCall = null;
        // KHÔNG reset currentDbCallId ở đây - sẽ reset sau khi upload xong
        // currentDbCallId sẽ được reset trong onstop callback sau khi upload
      }

      // Kiem tra trinh duyet co ho tro MediaRecorder khong
      function isRecordingSupported() {
        return !!(
          navigator.mediaDevices &&
          navigator.mediaDevices.getUserMedia &&
          window.MediaRecorder
        );
      }

      // Kiem tra mimeType duoc ho tro
      function getSupportedMimeType() {
        const mimeTypes = [
          "audio/webm;codecs=opus",
          "audio/webm",
          "audio/ogg;codecs=opus",
          "audio/mp4",
        ];
        for (const mimeType of mimeTypes) {
          if (MediaRecorder.isTypeSupported(mimeType)) {
            return mimeType;
          }
        }
        return null;
      }

      async function startRecording() {
        try {
          // Kiem tra ho tro
          if (!isRecordingSupported()) {
            addLog(
              "Trinh duyet khong ho tro ghi am. Vui long su dung Chrome hoac Firefox.",
              "error",
            );
            showNotification("Không hỗ trợ ghi âm", "Trình duyệt không hỗ trợ. Vui lòng dùng Chrome hoặc Firefox", "error", 5000);
            return;
          }

          if (mediaRecorderCombined && mediaRecorderCombined.state === "recording") {
            addLog("Dang ghi am...", "warning");
            showNotification("Đang ghi âm", "Cuộc gọi đang được ghi lại", "info", 2000);
            return;
          }

          addLog("Dang khoi tao ghi am 3 streams (Caller, Receiver, Combined)...", "info");

          // Yeu cau quyen truy cap microphone cho localStream
          try {
            localStream = await navigator.mediaDevices.getUserMedia({
              audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
              },
            });
          } catch (err) {
            if (err.name === "NotAllowedError") {
              addLog("Nguoi dung tu choi quyen truy cap microphone", "error");
              showNotification("Từ chối quyền", "Bạn đã từ chối quyền truy cập microphone", "error", 5000);
            } else if (err.name === "NotFoundError") {
              addLog("Khong tim thay microphone", "error");
              showNotification("Không tìm thấy microphone", "Hệ thống không phát hiện microphone", "error", 5000);
            } else {
              addLog("Loi truy cap microphone: " + err.message, "error");
              showNotification("Lỗi microphone", `Không thể truy cập: ${err.message}`, "error", 5000);
            }
            return;
          }

          // Lay remote stream
          const remoteAudio = document.getElementById("remoteAudio");
          if (remoteAudio && remoteAudio.srcObject) {
            remoteStream = remoteAudio.srcObject;
          }

          // Kiem tra mimeType duoc ho tro
          const mimeType = getSupportedMimeType();
          if (!mimeType) {
            addLog("Trinh duyet khong ho tro dinh dang ghi am", "error");
            showNotification("Lỗi định dạng", "Trình duyệt không hỗ trợ định dạng ghi âm", "error", 5000);
            return;
          }

          addLog("Su dung dinh dang: " + mimeType, "info");

          // Reset arrays
          recordedChunksCaller = [];
          recordedChunksReceiver = [];
          recordedChunksCombined = [];

          // 1. Setup Caller (local) recorder
          if (localStream) {
            mediaRecorderCaller = new MediaRecorder(localStream, {
              mimeType: mimeType,
              audioBitsPerSecond: 128000,
            });
            mediaRecorderCaller.ondataavailable = (e) => {
              if (e.data.size > 0) recordedChunksCaller.push(e.data);
            };
            mediaRecorderCaller.start(1000);
            addLog("✅ Ghi am Caller stream", "success");
          }

          // 2. Setup Receiver (remote) recorder
          if (remoteStream) {
            mediaRecorderReceiver = new MediaRecorder(remoteStream, {
              mimeType: mimeType,
              audioBitsPerSecond: 128000,
            });
            mediaRecorderReceiver.ondataavailable = (e) => {
              if (e.data.size > 0) recordedChunksReceiver.push(e.data);
            };
            mediaRecorderReceiver.start(1000);
            addLog("✅ Ghi am Receiver stream", "success");
          }

          // 3. Setup Combined (mixed) recorder
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const destination = audioContext.createMediaStreamDestination();
          
          if (localStream) {
            const localSource = audioContext.createMediaStreamSource(localStream);
            localSource.connect(destination);
          }
          
          if (remoteStream) {
            try {
              const remoteSource = audioContext.createMediaStreamSource(remoteStream);
              remoteSource.connect(destination);
              addLog("Da ket noi remote audio vao combined stream", "success");
            } catch (e) {
              addLog("Khong the ket noi remote audio: " + e.message, "warning");
            }
          }

          mixedStream = destination.stream;
          mediaRecorderCombined = new MediaRecorder(mixedStream, {
            mimeType: mimeType,
            audioBitsPerSecond: 128000,
          });
          mediaRecorderCombined.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunksCombined.push(e.data);
          };
          mediaRecorderCombined.start(1000);
          addLog("✅ Ghi am Combined stream", "success");

          isRecording = true; // Đánh dấu đang ghi âm
          recordingStartTime = Date.now();

          // Hien thi indicator
          document.getElementById("recordingSection").classList.remove("hidden");
          document.getElementById("recordingSection").classList.add("active");
          document.getElementById("recordingInfo").classList.remove("hidden");

          // Cap nhat thoi gian ghi am
          recordingInterval = setInterval(() => {
            const d = Math.floor((Date.now() - recordingStartTime) / 1000);
            document.getElementById("recordingDuration").textContent =
              Math.floor(d / 60)
                .toString()
                .padStart(2, "0") +
              ":" +
              (d % 60).toString().padStart(2, "0");
          }, 1000);
        } catch (err) {
          addLog("Loi ghi am: " + err.message, "error");
          showNotification("Lỗi ghi âm", `Không thể ghi âm: ${err.message}`, "error", 5000);
          console.error("Recording error:", err);

          // Cleanup khi loi
          if (localStream) {
            localStream.getTracks().forEach((t) => t.stop());
            localStream = null;
          }
          if (audioContext) {
            audioContext.close();
            audioContext = null;
          }
        }
      }

      async function stopRecording() {
        isRecording = false; // Đánh dấu đã dừng ghi âm
        document.getElementById("recordingInfo").classList.add("hidden");
        addLog("Đang dừng ghi âm 3 streams...", "info");

        // Stop all 3 recorders
        if (mediaRecorderCaller && mediaRecorderCaller.state === "recording") {
          mediaRecorderCaller.stop();
        }
        if (mediaRecorderReceiver && mediaRecorderReceiver.state === "recording") {
          mediaRecorderReceiver.stop();
        }
        if (mediaRecorderCombined && mediaRecorderCombined.state === "recording") {
          mediaRecorderCombined.stop();
        }

        // Cleanup
        if (recordingInterval) {
          clearInterval(recordingInterval);
          recordingInterval = null;
        }
        if (localStream) {
          localStream.getTracks().forEach((t) => t.stop());
          localStream = null;
        }
        if (audioContext) {
          await audioContext.close();
          audioContext = null;
        }

        // Wait a bit then upload all 3 files
        setTimeout(async () => {
          const mimeType = getSupportedMimeType();
          const dbCallIdSnapshot = currentDbCallId;

          // Upload caller
          if (recordedChunksCaller.length > 0) {
            const blob = new Blob(recordedChunksCaller, { type: mimeType });
            await uploadRecording(blob, dbCallIdSnapshot, "caller");
          }

          // Upload receiver
          if (recordedChunksReceiver.length > 0) {
            const blob = new Blob(recordedChunksReceiver, { type: mimeType });
            await uploadRecording(blob, dbCallIdSnapshot, "receiver");
          }

          // Upload combined
          if (recordedChunksCombined.length > 0) {
            const blob = new Blob(recordedChunksCombined, { type: mimeType });
            await uploadRecording(blob, dbCallIdSnapshot, "combined");
          }

          // Reset currentDbCallId after all uploads
          currentDbCallId = null;
        }, 500);
      }

      async function uploadRecording(blob, dbCallIdParam, recordingType) {
        console.log("DEBUG uploadRecording: dbCallIdParam =", dbCallIdParam, "recordingType =", recordingType);
        
        // Kiem tra blob hop le
        if (!blob || blob.size === 0) {
          addLog("Khong co du lieu ghi am de upload", "warning");
          showNotification("Không có dữ liệu", "Không có dữ liệu ghi âm để lưu", "warning", 3000);
          return;
        }

        const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
        addLog(`Chuan bi upload ${recordingType} file ${sizeMB} MB...`, "info");

        // Kiem tra kich thuoc file (max 100MB)
        if (blob.size > 100 * 1024 * 1024) {
          addLog("File qua lon (>100MB), khong the upload", "error");
          showNotification("File quá lớn", "File ghi âm vượt quá 100MB, không thể lưu", "error", 5000);
          return;
        }

        try {
          const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
          const extension = blob.type.includes("webm")
            ? ".webm"
            : blob.type.includes("ogg")
              ? ".ogg"
              : blob.type.includes("mp4")
                ? ".mp4"
                : ".webm";
          const filename = `call_${currentUser.stringeeUserId}_to_user_${patient.id}_${timestamp}_${recordingType}${extension}`;

          addLog(`Dang upload ${recordingType}: ${filename}`, "info");

          const formData = new FormData();
          formData.append("file", blob, filename);
          // Sử dụng database call ID từ param (snapshot) hoặc fallback
          const callIdForUpload = dbCallIdParam || currentDbCallId || ("web_" + Date.now());
          formData.append("callId", callIdForUpload);
          formData.append("userId", currentUser.stringeeUserId);
          // Thêm recordingType từ parameter
          formData.append("recordingType", recordingType || "combined");

          console.log("DEBUG: callIdForUpload =", callIdForUpload, "(from param:", dbCallIdParam, "current:", currentDbCallId, ")");
          addLog(`📤 Upload với callId: ${callIdForUpload} (param=${dbCallIdParam || 'null'})`, "info");

          // Upload voi retry
          let retries = 3;
          let lastError = null;

          while (retries > 0) {
            try {
              const response = await fetch("/api/stringee/upload-recording", {
                method: "POST",
                body: formData,
              });

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error("HTTP " + response.status + ": " + errorText);
              }

              const result = await response.json();

              if (result.success) {
                addLog(`Upload ${recordingType} thanh cong! S3 Key: ${result.s3Key}`, "success");
                
                // Nếu có database call ID, cập nhật recording URL vào database
                const dbCallIdToSave = dbCallIdParam || currentDbCallId;
                if (dbCallIdToSave && result.s3Key) {
                  await saveRecordingToDatabase(dbCallIdToSave, result.s3Key, result.presignedUrl, recordingType);
                }
                
                // Reload danh sach recordings sau 1 giay (chỉ reload sau khi upload combined - cuối cùng)
                if (recordingType === "combined") {
                  setTimeout(() => loadRecordings(), 1000);
                }
                return;
              } else {
                throw new Error(result.error || "Upload that bai");
              }
            } catch (err) {
              lastError = err;
              retries--;
              if (retries > 0) {
                addLog(
                  "Upload that bai, thu lai (" + retries + " lan con lai)...",
                  "warning",
                );
                await new Promise((resolve) => setTimeout(resolve, 2000)); // Cho 2 giay
              }
            }
          }

          addLog(
            "Upload that bai sau 3 lan thu: " + lastError.message,
            "error",
          );
          showNotification("Lưu thất bại", `Không thể lưu file sau 3 lần thử: ${lastError.message}`, "error", 5000);
        } catch (err) {
          addLog("Loi upload: " + err.message, "error");
          showNotification("Lỗi lưu file", `Không thể lưu file ghi âm: ${err.message}`, "error", 5000);
          console.error("Upload error:", err);
        }
      }
      
      // Lưu recording URL vào database WebCallLog
      async function saveRecordingToDatabase(callId, s3Key, presignedUrl, recordingType) {
        try {
          const params = new URLSearchParams();
          params.append('callId', callId);
          params.append('s3Key', s3Key);
          params.append('recordingType', recordingType || 'combined');
          if (presignedUrl) params.append('presignedUrl', presignedUrl);
          
          const response = await fetch('/api/web-call/recording', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: params.toString()
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              addLog(`Đã lưu recording vào database (call #${callId})`, "success");
            }
          }
        } catch (err) {
          console.error("Error saving recording to database:", err);
          addLog("Lưu recording vào DB thất bại: " + err.message, "warning");
        }
      }

      async function loadRecordings() {
        try {
          // Đảm bảo patient đã được load
          if (!patient || !patient.id) {
            addLog("Chưa có thông tin bệnh nhân, chờ load...", "warning");
            showNotification("Chờ tải dữ liệu", "Đang chờ thông tin bệnh nhân...", "info", 2000);
            return;
          }

          // Load cả 2 loại: AI call recordings và Web call recordings
          const [aiRecordings, webCallRecordings] = await Promise.all([
            loadAICallRecordings(),
            loadWebCallRecordings()
          ]);

          // Merge và hiển thị
          const allRecordings = [...aiRecordings, ...webCallRecordings];
          displayRecordings(allRecordings);
          
          addLog(
            `Đã tải ${aiRecordings.length} AI call + ${webCallRecordings.length} web call = ${allRecordings.length} recordings`,
            "success",
          );
        } catch (err) {
          addLog("Lỗi tải danh sách: " + err.message, "error");
        }
      }

      // Load AI Call Recordings từ S3
      async function loadAICallRecordings() {
        try {
          const response = await fetch("/api/stringee/recordings");
          if (!response.ok) throw new Error("HTTP " + response.status);
          const result = await response.json();
          
          if (!result.success) return [];

          // Filter recordings related to this patient
          const patientUserId = `user_${patient.id}`;
          const patientRecordings = result.recordings.filter((r) => {
            const filename = r.filename || "";
            const key = r.key || "";
            const searchString = filename + " " + key;

            const pattern1 = `_to_${patientUserId}_`;
            const pattern2 = `_to_${patientUserId}.`;
            const pattern3 = `_user_${patient.id}_`;
            const pattern4 = `_user_${patient.id}.`;

            return searchString.includes(pattern1) ||
                   searchString.includes(pattern2) ||
                   searchString.includes(pattern3) ||
                   searchString.includes(pattern4);
          });

          return patientRecordings.map(r => ({
            ...r,
            type: 'ai_call',
            displayType: 'AI Callbot'
          }));
        } catch (err) {
          console.error("Error loading AI call recordings:", err);
          return [];
        }
      }

      // Load Web Call Recordings từ database
      async function loadWebCallRecordings() {
        try {
          const response = await fetch(`/api/web-call/patient/${patient.id}/recordings`);
          if (!response.ok) throw new Error("HTTP " + response.status);
          const result = await response.json();
          
          if (!result.success || !result.calls) return [];

          // Chuyển đổi web call logs thành recording format
          const recordings = [];
          result.calls.forEach(call => {
            if (!call.hasRecording) return;

            const callDate = new Date(call.startTime);
            const baseInfo = {
              type: 'web_call',
              displayType: 'Web Call',
              callId: call.id,
              duration: call.durationFormatted || '0:00',
              otherUser: call.otherUserName,
              isOutgoing: call.isOutgoing,
              lastModified: callDate.toISOString()
            };

            // Combined recording
            if (call.recordingUrl) {
              recordings.push({
                ...baseInfo,
                filename: `Web Call - ${call.otherUserName} (Combined) - ${callDate.toLocaleString('vi-VN')}`,
                url: call.recordingUrl,
                s3Key: call.recordingS3Key,
                size: 0,
                recordingType: 'combined'
              });
            }

            // Caller recording
            if (call.recordingCallerUrl) {
              recordings.push({
                ...baseInfo,
                filename: `Web Call - ${call.otherUserName} (Caller) - ${callDate.toLocaleString('vi-VN')}`,
                url: call.recordingCallerUrl,
                s3Key: call.recordingCallerS3Key,
                size: 0,
                recordingType: 'caller'
              });
            }

            // Receiver recording
            if (call.recordingReceiverUrl) {
              recordings.push({
                ...baseInfo,
                filename: `Web Call - ${call.otherUserName} (Receiver) - ${callDate.toLocaleString('vi-VN')}`,
                url: call.recordingReceiverUrl,
                s3Key: call.recordingReceiverS3Key,
                size: 0,
                recordingType: 'receiver'
              });
            }
          });

          return recordings;
        } catch (err) {
          console.error("Error loading web call recordings:", err);
          return [];
        }
      }

      function displayRecordings(recordings) {
        const container = document.getElementById("recordingsList");
        if (!recordings || recordings.length === 0) {
          container.innerHTML = `<div class="p-8 text-center text-gray-500"><span class="material-symbols-rounded text-4xl text-gray-300">audio_file</span><p class="mt-2">Chưa có file ghi âm nào</p></div>`;
          return;
        }
        
        let html = "";
        recordings.forEach((rec) => {
          const size = rec.size ? (rec.size / 1024).toFixed(2) : '~';
          const date = new Date(rec.lastModified).toLocaleString("vi-VN");
          
          // Icon và màu theo loại
          let iconColor = 'purple';
          let iconBg = 'bg-purple-100';
          let textColor = 'text-purple-600';
          let badge = '';
          
          if (rec.type === 'web_call') {
            iconColor = 'blue';
            iconBg = 'bg-blue-100';
            textColor = 'text-blue-600';
            
            // Badge cho loại recording
            if (rec.recordingType === 'caller') {
              badge = '<span class="ml-2 px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full">Caller</span>';
            } else if (rec.recordingType === 'receiver') {
              badge = '<span class="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded-full">Receiver</span>';
            } else if (rec.recordingType === 'combined') {
              badge = '<span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">Combined</span>';
            }
          }
          
          html += `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 rounded-xl ${iconBg} flex items-center justify-center">
                                <span class="material-symbols-rounded ${textColor}">${rec.type === 'web_call' ? 'phone' : 'smart_toy'}</span>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="flex items-center gap-1">
                                    <p class="font-medium text-gray-800 truncate text-sm">${rec.filename}</p>
                                    ${badge}
                                </div>
                                <p class="text-xs text-gray-500">
                                    ${date} • ${size} KB
                                    ${rec.duration ? ` • ${rec.duration}` : ''}
                                    ${rec.type === 'web_call' ? ` • <span class="${textColor}">Web Call</span>` : ' • <span class="text-purple-600">AI Callbot</span>'}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="viewTranscript('${rec.url}', '${rec.filename}', '${rec.s3Key || ''}', '${rec.type}')" class="flex items-center gap-1 px-3 py-1.5 ${rec.type === 'web_call' ? 'bg-blue-100 text-blue-700 hover:bg-blue-200' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'} rounded-lg text-sm font-medium" title="Xem nội dung cuộc gọi">
                                <span class="material-symbols-rounded text-lg">description</span>
                                <span class="hidden sm:inline">Nội dung</span>
                            </button>
                            <button onclick="playRecording('${rec.url}', '${rec.filename}')" class="flex items-center gap-1 px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-sm font-medium hover:bg-green-200">
                                <span class="material-symbols-rounded text-lg">play_arrow</span>
                            </button>
                            <button onclick="downloadRecording('${rec.url}', '${rec.filename}')" class="flex items-center gap-1 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200">
                                <span class="material-symbols-rounded text-lg">download</span>
                            </button>
                        </div>
                    </div>`;
        });
        container.innerHTML = html;
      }

      // View Transcript Modal function
      async function viewTranscript(url, filename, s3Key, recordingType) {
        // Create modal if not exists
        let modal = document.getElementById("transcriptModal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "transcriptModal";
          modal.className =
            "fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4";
          modal.innerHTML = `
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col">
              <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-slate-700">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                  <span class="material-symbols-rounded text-primary">description</span>
                  Nội dung cuộc thoại (văn bản)
                </h3>
                <button onclick="closeTranscriptModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                  <span class="material-symbols-rounded text-2xl">close</span>
                </button>
              </div>
              <div class="p-4 border-b border-gray-100 dark:border-slate-700">
                <p id="transcriptFilename" class="text-sm text-gray-500 dark:text-slate-400 truncate"></p>
              </div>
              <div id="transcriptContent" class="p-4 overflow-y-auto flex-1">
                <div class="text-center py-8">
                  <div class="w-8 h-8 border-3 border-gray-200 border-t-primary rounded-full animate-spin mx-auto mb-3"></div>
                  <p class="text-sm text-gray-500">Đang chuyển đổi giọng nói thành văn bản...</p>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }

        // Show modal
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.getElementById("transcriptFilename").textContent = filename;

        // Load transcript
        const content = document.getElementById("transcriptContent");
        content.innerHTML = `<div class="text-center py-8"><div class="w-8 h-8 border-3 border-gray-200 border-t-primary rounded-full animate-spin mx-auto mb-3"></div><p class="text-sm text-gray-500">Đang phân tích nội dung cuộc gọi...</p></div>`;
        showNotification("Đang phân tích", "Đang chuyển đổi giọng nói thành văn bản...", "info", 3000);

        // Lưu filename để dùng cho edit/delete
        window.currentTranscriptFilename = filename;

        try {
          // Xác định request body tùy theo loại recording
          let requestBody;
          
          if (recordingType === 'web_call' && s3Key) {
            // Web call - sử dụng s3Key
            requestBody = JSON.stringify({ s3Key: s3Key });
          } else {
            // AI call - sử dụng recordingKey pattern cũ
            const recordingKey = "recordings/" + filename;
            requestBody = JSON.stringify({ recordingKey: recordingKey });
          }
          
          // Call ASR API to get transcript
          const response = await fetch("/api/web-call/transcribe", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: requestBody,
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Không thể phân tích nội dung");
          }

          const result = await response.json();
          if (result.success && result.transcript) {
            showNotification("Phân tích thành công", "Nội dung cuộc thoại đã được chuyển đổi", "success", 3000);
            const cachedBadge = result.cached 
              ? '<span class="ml-2 px-2 py-0.5 bg-green-100 text-green-600 text-xs rounded-full">Đã lưu</span>' 
              : '<span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-600 text-xs rounded-full">Mới phân tích</span>';
            
            // Lưu transcript hiện tại
            window.currentTranscript = result.transcript;
            
            content.innerHTML = `
              <div class="space-y-4">
                <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border-2 border-gray-200">
                  <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-200">
                    <div class="flex items-center gap-2">
                      <span class="material-symbols-rounded text-primary">description</span>
                      <p class="text-sm font-semibold text-gray-800 dark:text-gray-200">
                        Nội dung cuộc thoại (văn bản) ${cachedBadge}
                      </p>
                    </div>
                    <div class="flex gap-2">
                      <button onclick="editTranscript()" class="px-3 py-1.5 text-xs bg-primary text-white rounded-lg hover:bg-primary/90 flex items-center gap-1" title="Chỉnh sửa nội dung văn bản">
                        <span class="material-symbols-rounded text-sm">edit</span> 
                        <span class="hidden sm:inline">Chỉnh sửa</span>
                      </button>
                      <button onclick="deleteTranscript()" class="px-3 py-1.5 text-xs bg-red-100 text-red-700 rounded-lg hover:bg-red-200 flex items-center gap-1" title="Xóa nội dung văn bản">
                        <span class="material-symbols-rounded text-sm">delete</span> 
                        <span class="hidden sm:inline">Xóa</span>
                      </button>
                    </div>
                  </div>
                  <div id="transcriptText" class="text-gray-800 dark:text-gray-200 whitespace-pre-wrap leading-relaxed">${result.transcript}</div>
                </div>
              </div>
            `;
          } else {
            content.innerHTML = `<div class="text-center py-8 text-gray-500"><span class="material-symbols-rounded text-4xl text-gray-300 mb-2">error</span><p>Chưa có nội dung cuộc gọi hoặc đang xử lý.</p></div>`;
            showNotification("Chưa có nội dung", "Chưa có nội dung cuộc gọi hoặc đang xử lý", "warning", 3000);
          }
        } catch (err) {
          console.error("Transcribe error:", err);
          content.innerHTML = `<div class="text-center py-8 text-gray-500"><span class="material-symbols-rounded text-4xl text-gray-300 mb-2">error</span><p>Không thể tải nội dung cuộc gọi.</p><p class="text-sm mt-2">${err.message}</p></div>`;
          showNotification("Phân tích thất bại", `Không thể chuyển đổi: ${err.message}`, "error", 5000);
        }
      }

      // Edit transcript
      function editTranscript() {
        const textDiv = document.getElementById("transcriptText");
        const currentText = window.currentTranscript || textDiv.innerText;
        
        textDiv.innerHTML = `
          <textarea id="transcriptEditArea" class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-y text-sm">${currentText}</textarea>
          <div class="flex justify-end gap-2 mt-3">
            <button onclick="cancelEditTranscript()" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Hủy</button>
            <button onclick="saveTranscript()" class="px-3 py-1.5 text-sm bg-primary text-white rounded-lg hover:bg-primary/90">Lưu thay đổi</button>
          </div>
        `;
      }

      // Cancel edit
      function cancelEditTranscript() {
        const textDiv = document.getElementById("transcriptText");
        textDiv.innerHTML = window.currentTranscript;
      }

      // Save transcript
      async function saveTranscript() {
        const textarea = document.getElementById("transcriptEditArea");
        const newTranscript = textarea.value.trim();
        
        if (!newTranscript) {
          showNotification("Nội dung trống", "Nội dung không được để trống", "warning", 3000);
          return;
        }
        
        try {
          const response = await fetch("/api/web-call/transcript", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              filename: window.currentTranscriptFilename,
              transcript: newTranscript 
            }),
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Không thể lưu");
          }
          
          // Update display
          window.currentTranscript = newTranscript;
          const textDiv = document.getElementById("transcriptText");
          textDiv.innerHTML = newTranscript;
          
          // Show success notification
          showNotification("Đã lưu", "Nội dung cuộc thoại đã được cập nhật", "success", 3000);
          
        } catch (err) {
          console.error("Save transcript error:", err);
          showNotification("Lỗi lưu", `Không thể lưu nội dung: ${err.message}`, "error", 5000);
        }
      }

      // Delete transcript
      async function deleteTranscript() {
        if (!confirm("Bạn có chắc muốn xóa nội dung này? Hành động này không thể hoàn tác.")) {
          return;
        }
        
        try {
          const response = await fetch(`/api/web-call/transcript?filename=${encodeURIComponent(window.currentTranscriptFilename)}`, {
            method: "DELETE",
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Không thể xóa");
          }
          
          // Close modal
          closeTranscriptModal();
          showNotification("Đã xóa", "Nội dung cuộc thoại đã được xóa", "success", 3000);
          
        } catch (err) {
          console.error("Delete transcript error:", err);
          showNotification("Lỗi xóa", `Không thể xóa nội dung: ${err.message}`, "error", 5000);
        }
      }

      // Toast notification helper
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        const bgColor = type === "success" ? "bg-green-500" : type === "error" ? "bg-red-500" : "bg-blue-500";
        toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      function closeTranscriptModal() {
        const modal = document.getElementById("transcriptModal");
        if (modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
      }

      function playRecording(url, filename) {
        document.getElementById("audioPlayerTitle").textContent = filename;
        document.getElementById("audioPlayer").src = url;
        document.getElementById("audioPlayerModal").classList.remove("hidden");
        showNotification("Đang phát", "Đang mở file ghi âm...", "info", 2000);
      }

      function closeAudioPlayer() {
        document.getElementById("audioPlayerModal").classList.add("hidden");
        document.getElementById("audioPlayer").pause();
      }

      function downloadRecording(url, filename) {
        showNotification("Đang tải xuống", `Đang tải file ${filename}`, "info", 2000);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => {
          showNotification("Tải xuống thành công", "File đã được tải về máy của bạn", "success", 3000);
        }, 500);
      }

      function getInitials(name) {
        if (!name) return "?";
        const parts = name.split(" ").filter((p) => p);
        if (parts.length >= 2)
          return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        return name.substring(0, 2).toUpperCase();
      }

      function calculateAge(dob) {
        const today = new Date();
        const birth = new Date(dob);
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
        return age;
      }
    </script>
  </body>
</html>
