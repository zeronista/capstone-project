<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Stringee Web Call Demo</title>
    <script src="/js/latest.sdk.bundle.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .status { font-weight: bold; color: blue; }
        .status-connecting { color: orange; }
        .status-connected { color: green; }
        .status-disconnected { color: red; }
        button { padding: 10px 20px; cursor: pointer; margin-right: 10px; }
        .hidden { display: none; }
        .log-box { 
            background: #f5f5f5; 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry { 
            margin: 3px 0; 
            padding: 3px;
        }
        .log-info { color: blue; }
        .log-success { color: green; }
        .log-error { color: red; }
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: red;
            border-radius: 50%;
            animation: blink 1s infinite;
            margin-left: 5px;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .recording-info {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Demo Web-to-Web Call</h1>

    <div id="login-screen" class="box">
        <h3>B∆∞·ªõc 1: K·∫øt n·ªëi</h3>
        <p>Nh·∫≠p User ID c·ªßa b·∫°n ƒë·ªÉ k·∫øt n·ªëi:</p>
        <input type="text" id="myUserId" placeholder="V√≠ d·ª•: user1">
        <button onclick="connectStringee()">K·∫øt n·ªëi</button>
    </div>

    <div id="call-screen" class="box hidden">
        <h3>Xin ch√†o: <span id="displayUserId"></span></h3>
        <p>
            Tr·∫°ng th√°i k·∫øt n·ªëi: 
            <span id="connectionStatus" class="status status-connecting">ƒêang k·∫øt n·ªëi...</span>
        </p>
        
        <div class="log-box" id="logConsole">
            <div class="log-entry log-info">Nh·∫≠t k√Ω ho·∫°t ƒë·ªông s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>
        </div>
        
        <hr>
        
        <div style="margin-bottom: 10px;">
            <label>
                <input type="checkbox" id="autoRecordCheckbox" checked>
                <strong>üéôÔ∏è T·ª± ƒë·ªông ghi √¢m khi cu·ªôc g·ªçi k·∫øt n·ªëi</strong>
            </label>
            <p style="font-size: 12px; color: #666; margin: 5px 0 0 24px;">
                (File s·∫Ω ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông v√†o S3 khi cu·ªôc g·ªçi k·∫øt th√∫c)
            </p>
        </div>
        
        <hr>
        
        <h4>Th·ª±c hi·ªán cu·ªôc g·ªçi</h4>
        <input type="text" id="remoteUserId" placeholder="Nh·∫≠p ID ng∆∞·ªùi nh·∫≠n (v√≠ d·ª•: user2)">
        
        <div style="margin-top: 10px;">
            <button id="btnCall" onclick="makeCall()">üìû G·ªçi Voice</button>
            <button id="btnReject" onclick="rejectCall()" class="hidden" style="background: #dc3545; color: white;">‚õî T·ª´ ch·ªëi</button>
            <button id="btnAnswer" onclick="answerCall()" class="hidden" style="background: green; color: white;">‚úÖ Tr·∫£ l·ªùi</button>
            <button id="btnHangup" onclick="hangupCall()" class="hidden" style="background: red; color: white;">‚ùå K·∫øt th√∫c</button>
        </div>

        <div id="manualRecordButtons" style="margin-top: 10px;">
            <button id="btnStartRecord" onclick="startRecording()" class="hidden" style="background: #007bff; color: white;">üéôÔ∏è B·∫Øt ƒë·∫ßu ghi √¢m</button>
            <button id="btnStopRecord" onclick="stopRecording()" class="hidden" style="background: #6c757d; color: white;">‚èπÔ∏è D·ª´ng ghi √¢m</button>
        </div>

        <p id="callStatus" style="font-weight: bold; margin-top: 10px;">S·∫µn s√†ng</p>
        
        <div id="recordingInfo" class="recording-info hidden">
            <p style="margin: 0;">
                <strong>üéôÔ∏è ƒêang ghi √¢m</strong>
                <span class="recording-indicator"></span>
                <span id="recordingDuration">00:00</span>
            </p>
        </div>
    </div>

    <div id="remote_videos" style="display: none;"></div>

    <script>
        // C·∫•u h√¨nh Stringee Server Addresses (Best Practice)
        const STRINGEE_SERVER_ADDRS = [
            "wss://v1.stringee.com:6899/", 
            "wss://v2.stringee.com:6899/"
        ];
        
        var stringeeClient;
        var currentCall;
        var myToken;
        var mediaRecorder;
        var recordedChunks = [];
        var recordingStartTime;
        var recordingInterval;

        // Event listener cho checkbox auto-record
        document.addEventListener('DOMContentLoaded', function() {
            const autoRecordCheckbox = document.getElementById('autoRecordCheckbox');
            autoRecordCheckbox.addEventListener('change', function() {
                const manualButtons = document.getElementById('manualRecordButtons');
                if (this.checked) {
                    addLog('‚úÖ ƒê√£ b·∫≠t t·ª± ƒë·ªông ghi √¢m', 'success');
                } else {
                    addLog('‚ÑπÔ∏è ƒê√£ t·∫Øt t·ª± ƒë·ªông ghi √¢m - B·∫°n c·∫ßn b·∫•m n√∫t ƒë·ªÉ ghi √¢m', 'info');
                }
            });
        });

        function addLog(message, type) {
            type = type || 'info';
            const logBox = document.getElementById('logConsole');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'success' ? 'log-success' : (type === 'error' ? 'log-error' : 'log-info');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry ' + logClass;
            logEntry.textContent = '[' + timestamp + '] ' + message;
            
            logBox.appendChild(logEntry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function connectStringee() {
            const userId = document.getElementById('myUserId').value;
            if (!userId) return alert('Vui l√≤ng nh·∫≠p User ID');

            console.log('B·∫Øt ƒë·∫ßu k·∫øt n·ªëi v·ªõi userId:', userId);
            addLog('ƒêang k·∫øt n·ªëi v·ªõi user: ' + userId, 'info');

            try {
                console.log('ƒêang l·∫•y access token t·ª´ server...');
                addLog('ƒêang l·∫•y access token t·ª´ server...', 'info');
                
                const res = await fetch('/api/stringee/access-token?userId=' + userId);
                
                if (!res.ok) {
                    throw new Error('HTTP error! status: ' + res.status + ' - ' + res.statusText);
                }
                
                const data = await res.json();
                
                if (!data.token) {
                    throw new Error('Token kh√¥ng c√≥ trong response t·ª´ server');
                }
                
                myToken = data.token;
                console.log('ƒê√£ nh·∫≠n ƒë∆∞·ª£c token:', myToken.substring(0, 50) + '...');
                addLog('‚úÖ ƒê√£ nh·∫≠n ƒë∆∞·ª£c access token t·ª´ server', 'success');
            } catch (err) {
                console.error('L·ªói l·∫•y token:', err);
                addLog('‚ùå L·ªói l·∫•y token: ' + err.message, 'error');
                alert('L·ªói l·∫•y token t·ª´ server: ' + err.message + '\n\nVui l√≤ng ki·ªÉm tra:\n1. Server ƒëang ch·∫°y\n2. API endpoint /api/stringee/access-token ho·∫°t ƒë·ªông\n3. UserId h·ª£p l·ªá');
                return;
            }

            stringeeClient = new StringeeClient(STRINGEE_SERVER_ADDRS);
            console.log('ƒê√£ kh·ªüi t·∫°o Stringee Client v·ªõi server addresses');
            addLog('ƒê√£ kh·ªüi t·∫°o Stringee Client', 'info');

            stringeeClient.on('connect', function () {
                console.log('ƒê√£ k·∫øt n·ªëi t·ªõi Stringee Server');
                document.getElementById('connectionStatus').innerText = 'üü¢ ƒê√£ k·∫øt n·ªëi';
                document.getElementById('connectionStatus').className = 'status status-connected';
                addLog('ƒê√£ k·∫øt n·ªëi t·ªõi Stringee Server', 'success');
            });

            stringeeClient.on('authen', function (res) {
                console.log('X√°c th·ª±c:', res);
                if (res.r === 0) {
                    console.log('ƒêƒÉng nh·∫≠p th√†nh c√¥ng');
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('call-screen').classList.remove('hidden');
                    document.getElementById('displayUserId').innerText = userId;
                    addLog('‚úÖ X√°c th·ª±c th√†nh c√¥ng! User ID: ' + res.userId, 'success');
                    addLog('B·∫°n c√≥ th·ªÉ th·ª±c hi·ªán cu·ªôc g·ªçi ngay b√¢y gi·ªù', 'success');
                } else {
                    console.error('X√°c th·ª±c th·∫•t b·∫°i:', res);
                    addLog('‚ùå X√°c th·ª±c th·∫•t b·∫°i: ' + res.message, 'error');
                    alert('X√°c th·ª±c th·∫•t b·∫°i: ' + res.message);
                }
            });

            stringeeClient.on('disconnect', function () {
                console.log('ƒê√£ ng·∫Øt k·∫øt n·ªëi kh·ªèi Stringee');
                document.getElementById('connectionStatus').innerText = 'üî¥ ƒê√£ ng·∫Øt k·∫øt n·ªëi';
                document.getElementById('connectionStatus').className = 'status status-disconnected';
                addLog('ƒê√£ ng·∫Øt k·∫øt n·ªëi', 'error');
            });

            stringeeClient.on('requestnewtoken', function () {
                console.log('Token h·∫øt h·∫°n');
                addLog('Token h·∫øt h·∫°n!', 'error');
                alert('Token ƒë√£ h·∫øt h·∫°n. Vui l√≤ng l√†m m·ªõi trang.');
            });

            stringeeClient.on('incomingcall', function (incomingCall) {
                console.log('Cu·ªôc g·ªçi ƒë·∫øn:', incomingCall);
                addLog('üìû Cu·ªôc g·ªçi ƒë·∫øn t·ª´: ' + incomingCall.fromNumber, 'info');
                currentCall = incomingCall;
                
                document.getElementById('callStatus').innerText = 'üìû ƒêang c√≥ cu·ªôc g·ªçi ƒë·∫øn t·ª´: ' + incomingCall.fromNumber;
                document.getElementById('btnAnswer').classList.remove('hidden');
                document.getElementById('btnReject').classList.remove('hidden');
                document.getElementById('btnCall').classList.add('hidden');

                settingCallEvents(currentCall);
            });

            console.log('ƒêang k·∫øt n·ªëi t·ªõi Stringee...');
            stringeeClient.connect(myToken);
        }

        function makeCall() {
            const callerId = document.getElementById('myUserId').value;
            const calleeId = document.getElementById('remoteUserId').value;

            if (!calleeId) return alert('Nh·∫≠p ID ng∆∞·ªùi nh·∫≠n');

            console.log('ƒêang g·ªçi...');
            addLog('ƒêang g·ªçi t·ªõi: ' + calleeId, 'info');

            currentCall = new StringeeCall(stringeeClient, callerId, calleeId, false);

            settingCallEvents(currentCall);

            currentCall.makeCall(function (res) {
                console.log('makeCall response:', res);
                if (res.r !== 0) {
                    console.error('G·ªçi th·∫•t b·∫°i:', res.message);
                    addLog('G·ªçi th·∫•t b·∫°i: ' + res.message, 'error');
                    alert(res.message);
                } else {
                    addLog('ƒêang th·ª±c hi·ªán cu·ªôc g·ªçi...', 'success');
                }
            });
            
            showInCallUI();
        }

        function settingCallEvents(call) {
            call.on('addremotestream', function (stream) {
                console.log('Adding remote stream');
                addLog('ƒê√£ nh·∫≠n lu·ªìng √¢m thanh', 'success');
                var videoElement = document.createElement('video');
                videoElement.setAttribute('autoplay', '');
                videoElement.setAttribute('playsinline', '');
                
                document.getElementById('remote_videos').appendChild(videoElement);
                stream.play(videoElement);
                
                // T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu ghi √¢m n·∫øu b·∫≠t auto-record
                const autoRecord = document.getElementById('autoRecordCheckbox').checked;
                if (autoRecord && (!mediaRecorder || mediaRecorder.state !== 'recording')) {
                    addLog('üéôÔ∏è T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu ghi √¢m...', 'info');
                    setTimeout(() => startRecording(), 500); // Delay nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o stream ƒë√£ ready
                }
            });

            call.on('signalingstate', function (state) {
                console.log('Signaling state:', state);
                document.getElementById('callStatus').innerText = state.reason;
                addLog('Tr·∫°ng th√°i: ' + state.reason, 'info');
                
                if (state.code === 6) {
                    addLog('Cu·ªôc g·ªçi ƒë√£ k·∫øt th√∫c', 'success');
                    resetUI();
                }
            });

            call.on('mediastate', function (state) {
                console.log('Media state:', state);
            });
            
            call.on('info', function (info) {
                console.log('Call info:', info);
            });
        }

        function answerCall() {
            if (currentCall) {
                currentCall.answer(function (res) {
                    console.log('answer res', res);
                    if (res.r === 0) {
                        showInCallUI();
                    }
                });
            }
        }

        function rejectCall() {
            if (currentCall) {
                // G·ªçi h√†m reject c·ªßa SDK
                currentCall.reject(function (res) {
                    console.log('reject res', res);
                    if (res.r === 0) {
                        addLog('ƒê√£ t·ª´ ch·ªëi cu·ªôc g·ªçi', 'info');
                    } else {
                        addLog('L·ªói t·ª´ ch·ªëi: ' + res.message, 'error');
                    }
                });
                // Reset giao di·ªán ngay l·∫≠p t·ª©c sau khi b·∫•m t·ª´ ch·ªëi
                resetUI();
            }
        }

        function hangupCall() {
            if (currentCall) {
                currentCall.hangup(function (res) {
                    console.log('hangup res', res);
                });
            }
            resetUI();
        }

        function showInCallUI() {
            document.getElementById('btnCall').classList.add('hidden');
            document.getElementById('btnAnswer').classList.add('hidden');
            document.getElementById('btnReject').classList.add('hidden');
            document.getElementById('btnHangup').classList.remove('hidden');
            
            // Ch·ªâ hi·ªÉn n√∫t ghi √¢m th·ªß c√¥ng n·∫øu t·∫Øt auto-record
            const autoRecord = document.getElementById('autoRecordCheckbox').checked;
            if (!autoRecord) {
                document.getElementById('btnStartRecord').classList.remove('hidden');
            }
        }

        function resetUI() {
            // T·ª± ƒë·ªông d·ª´ng v√† upload recording n·∫øu ƒëang ghi
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                addLog('ƒêang k·∫øt th√∫c ghi √¢m v√† upload...', 'info');
                stopRecording();
            }
            
            document.getElementById('callStatus').innerText = 'S·∫µn s√†ng';
            document.getElementById('btnCall').classList.remove('hidden');
            document.getElementById('btnAnswer').classList.add('hidden');
            document.getElementById('btnHangup').classList.add('hidden');
            document.getElementById('btnReject').classList.add('hidden');
            document.getElementById('btnStartRecord').classList.add('hidden');
            document.getElementById('btnStopRecord').classList.add('hidden');
            document.getElementById('recordingInfo').classList.add('hidden');
            document.getElementById('remote_videos').innerHTML = '';
            currentCall = null;
        }

        async function startRecording() {
            try {
                // L·∫•y audio stream t·ª´ microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    // D·ª´ng t·∫•t c·∫£ tracks
                    stream.getTracks().forEach(track => track.stop());
                    
                    // T·∫°o blob t·ª´ chunks
                    const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                    
                    // Upload l√™n server
                    await uploadRecording(blob);
                    
                    // Clear interval
                    if (recordingInterval) {
                        clearInterval(recordingInterval);
                    }
                };

                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                // Hi·ªÉn th·ªã UI
                document.getElementById('btnStartRecord').classList.add('hidden');
                document.getElementById('btnStopRecord').classList.remove('hidden');
                document.getElementById('recordingInfo').classList.remove('hidden');
                
                // C·∫≠p nh·∫≠t duration
                recordingInterval = setInterval(() => {
                    const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
                    const seconds = (duration % 60).toString().padStart(2, '0');
                    document.getElementById('recordingDuration').textContent = minutes + ':' + seconds;
                }, 1000);
                
                addLog('B·∫Øt ƒë·∫ßu ghi √¢m cu·ªôc g·ªçi', 'success');
                
            } catch (err) {
                console.error('L·ªói khi b·∫Øt ƒë·∫ßu ghi √¢m:', err);
                addLog('L·ªói: ' + err.message, 'error');
                alert('Kh√¥ng th·ªÉ truy c·∫≠p microphone. Vui l√≤ng cho ph√©p truy c·∫≠p.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                
                document.getElementById('btnStartRecord').classList.remove('hidden');
                document.getElementById('btnStopRecord').classList.add('hidden');
                document.getElementById('recordingInfo').classList.add('hidden');
                
                addLog('ƒê√£ d·ª´ng ghi √¢m. ƒêang upload l√™n S3...', 'info');
            }
        }

        async function uploadRecording(blob) {
            try {
                const userId = document.getElementById('myUserId').value;
                const remoteUserId = document.getElementById('remoteUserId').value;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `call_${userId}_to_${remoteUserId}_${timestamp}.webm`;
                
                const formData = new FormData();
                formData.append('file', blob, filename);
                formData.append('callId', 'web_' + Date.now());
                formData.append('userId', userId);
                
                addLog('ƒêang upload file ghi √¢m l√™n S3...', 'info');
                
                const response = await fetch('/api/stringee/upload-recording', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('‚úÖ Upload th√†nh c√¥ng! File: ' + result.s3Key, 'success');
                    console.log('S3 Key:', result.s3Key);
                    console.log('Pre-signed URL:', result.presignedUrl);
                } else {
                    addLog('‚ùå Upload th·∫•t b·∫°i: ' + result.error, 'error');
                }
                
            } catch (err) {
                console.error('L·ªói upload:', err);
                addLog('‚ùå L·ªói upload: ' + err.message, 'error');
            }
        }
    </script>
</body>
</html>
