<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Stringee Web Call Demo</title>
    <script src="/js/latest.sdk.bundle.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .status { font-weight: bold; color: blue; }
        .status-connecting { color: orange; }
        .status-connected { color: green; }
        .status-disconnected { color: red; }
        button { padding: 10px 20px; cursor: pointer; margin-right: 10px; }
        .hidden { display: none; }
        .log-box { 
            background: #f5f5f5; 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry { 
            margin: 3px 0; 
            padding: 3px;
        }
        .log-info { color: blue; }
        .log-success { color: green; }
        .log-error { color: red; }
    </style>
</head>
<body>
    <h1>Demo Web-to-Web Call</h1>

    <div id="login-screen" class="box">
        <h3>B∆∞·ªõc 1: K·∫øt n·ªëi</h3>
        <p>Nh·∫≠p User ID c·ªßa b·∫°n ƒë·ªÉ k·∫øt n·ªëi:</p>
        <input type="text" id="myUserId" placeholder="V√≠ d·ª•: user1">
        <button onclick="connectStringee()">K·∫øt n·ªëi</button>
    </div>

    <div id="call-screen" class="box hidden">
        <h3>Xin ch√†o: <span id="displayUserId"></span></h3>
        <p>
            Tr·∫°ng th√°i k·∫øt n·ªëi: 
            <span id="connectionStatus" class="status status-connecting">ƒêang k·∫øt n·ªëi...</span>
        </p>
        
        <div class="log-box" id="logConsole">
            <div class="log-entry log-info">Nh·∫≠t k√Ω ho·∫°t ƒë·ªông s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>
        </div>
        
        <hr>
        
        <h4>Th·ª±c hi·ªán cu·ªôc g·ªçi</h4>
        <input type="text" id="remoteUserId" placeholder="Nh·∫≠p ID ng∆∞·ªùi nh·∫≠n (v√≠ d·ª•: user2)">
        
        <div style="margin-top: 10px;">
            <button id="btnCall" onclick="makeCall()">üìû G·ªçi Voice</button>
            <button id="btnReject" onclick="rejectCall()" class="hidden" style="background: #dc3545; color: white;">‚õî T·ª´ ch·ªëi</button>
            <button id="btnAnswer" onclick="answerCall()" class="hidden" style="background: green; color: white;">‚úÖ Tr·∫£ l·ªùi</button>
            <button id="btnHangup" onclick="hangupCall()" class="hidden" style="background: red; color: white;">‚ùå K·∫øt th√∫c</button>
        </div>

        <p id="callStatus" style="font-weight: bold; margin-top: 10px;">S·∫µn s√†ng</p>
    </div>

    <div id="remote_videos" style="display: none;"></div>

    <script>
        // C·∫•u h√¨nh Stringee Server Addresses (Best Practice)
        const STRINGEE_SERVER_ADDRS = [
            "wss://v1.stringee.com:6899/", 
            "wss://v2.stringee.com:6899/"
        ];
        
        var stringeeClient;
        var currentCall;
        var myToken;

        function addLog(message, type) {
            type = type || 'info';
            const logBox = document.getElementById('logConsole');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'success' ? 'log-success' : (type === 'error' ? 'log-error' : 'log-info');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry ' + logClass;
            logEntry.textContent = '[' + timestamp + '] ' + message;
            
            logBox.appendChild(logEntry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function connectStringee() {
            const userId = document.getElementById('myUserId').value;
            if (!userId) return alert('Vui l√≤ng nh·∫≠p User ID');

            console.log('B·∫Øt ƒë·∫ßu k·∫øt n·ªëi v·ªõi userId:', userId);
            addLog('ƒêang k·∫øt n·ªëi v·ªõi user: ' + userId, 'info');

            try {
                console.log('ƒêang l·∫•y access token t·ª´ server...');
                addLog('ƒêang l·∫•y access token t·ª´ server...', 'info');
                
                const res = await fetch('/api/stringee/access-token?userId=' + userId);
                
                if (!res.ok) {
                    throw new Error('HTTP error! status: ' + res.status + ' - ' + res.statusText);
                }
                
                const data = await res.json();
                
                if (!data.token) {
                    throw new Error('Token kh√¥ng c√≥ trong response t·ª´ server');
                }
                
                myToken = data.token;
                console.log('ƒê√£ nh·∫≠n ƒë∆∞·ª£c token:', myToken.substring(0, 50) + '...');
                addLog('‚úÖ ƒê√£ nh·∫≠n ƒë∆∞·ª£c access token t·ª´ server', 'success');
            } catch (err) {
                console.error('L·ªói l·∫•y token:', err);
                addLog('‚ùå L·ªói l·∫•y token: ' + err.message, 'error');
                alert('L·ªói l·∫•y token t·ª´ server: ' + err.message + '\n\nVui l√≤ng ki·ªÉm tra:\n1. Server ƒëang ch·∫°y\n2. API endpoint /api/stringee/access-token ho·∫°t ƒë·ªông\n3. UserId h·ª£p l·ªá');
                return;
            }

            stringeeClient = new StringeeClient(STRINGEE_SERVER_ADDRS);
            console.log('ƒê√£ kh·ªüi t·∫°o Stringee Client v·ªõi server addresses');
            addLog('ƒê√£ kh·ªüi t·∫°o Stringee Client', 'info');

            stringeeClient.on('connect', function () {
                console.log('ƒê√£ k·∫øt n·ªëi t·ªõi Stringee Server');
                document.getElementById('connectionStatus').innerText = 'üü¢ ƒê√£ k·∫øt n·ªëi';
                document.getElementById('connectionStatus').className = 'status status-connected';
                addLog('ƒê√£ k·∫øt n·ªëi t·ªõi Stringee Server', 'success');
            });

            stringeeClient.on('authen', function (res) {
                console.log('X√°c th·ª±c:', res);
                if (res.r === 0) {
                    console.log('ƒêƒÉng nh·∫≠p th√†nh c√¥ng');
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('call-screen').classList.remove('hidden');
                    document.getElementById('displayUserId').innerText = userId;
                    addLog('‚úÖ X√°c th·ª±c th√†nh c√¥ng! User ID: ' + res.userId, 'success');
                    addLog('B·∫°n c√≥ th·ªÉ th·ª±c hi·ªán cu·ªôc g·ªçi ngay b√¢y gi·ªù', 'success');
                } else {
                    console.error('X√°c th·ª±c th·∫•t b·∫°i:', res);
                    addLog('‚ùå X√°c th·ª±c th·∫•t b·∫°i: ' + res.message, 'error');
                    alert('X√°c th·ª±c th·∫•t b·∫°i: ' + res.message);
                }
            });

            stringeeClient.on('disconnect', function () {
                console.log('ƒê√£ ng·∫Øt k·∫øt n·ªëi kh·ªèi Stringee');
                document.getElementById('connectionStatus').innerText = 'üî¥ ƒê√£ ng·∫Øt k·∫øt n·ªëi';
                document.getElementById('connectionStatus').className = 'status status-disconnected';
                addLog('ƒê√£ ng·∫Øt k·∫øt n·ªëi', 'error');
            });

            stringeeClient.on('requestnewtoken', function () {
                console.log('Token h·∫øt h·∫°n');
                addLog('Token h·∫øt h·∫°n!', 'error');
                alert('Token ƒë√£ h·∫øt h·∫°n. Vui l√≤ng l√†m m·ªõi trang.');
            });

            stringeeClient.on('incomingcall', function (incomingCall) {
                console.log('Cu·ªôc g·ªçi ƒë·∫øn:', incomingCall);
                addLog('üìû Cu·ªôc g·ªçi ƒë·∫øn t·ª´: ' + incomingCall.fromNumber, 'info');
                currentCall = incomingCall;
                
                document.getElementById('callStatus').innerText = 'üìû ƒêang c√≥ cu·ªôc g·ªçi ƒë·∫øn t·ª´: ' + incomingCall.fromNumber;
                document.getElementById('btnAnswer').classList.remove('hidden');
                document.getElementById('btnReject').classList.remove('hidden');
                document.getElementById('btnCall').classList.add('hidden');

                settingCallEvents(currentCall);
            });

            console.log('ƒêang k·∫øt n·ªëi t·ªõi Stringee...');
            stringeeClient.connect(myToken);
        }

        function makeCall() {
            const callerId = document.getElementById('myUserId').value;
            const calleeId = document.getElementById('remoteUserId').value;

            if (!calleeId) return alert('Nh·∫≠p ID ng∆∞·ªùi nh·∫≠n');

            console.log('ƒêang g·ªçi...');
            addLog('ƒêang g·ªçi t·ªõi: ' + calleeId, 'info');

            currentCall = new StringeeCall(stringeeClient, callerId, calleeId, false);

            settingCallEvents(currentCall);

            currentCall.makeCall(function (res) {
                console.log('makeCall response:', res);
                if (res.r !== 0) {
                    console.error('G·ªçi th·∫•t b·∫°i:', res.message);
                    addLog('G·ªçi th·∫•t b·∫°i: ' + res.message, 'error');
                    alert(res.message);
                } else {
                    addLog('ƒêang th·ª±c hi·ªán cu·ªôc g·ªçi...', 'success');
                }
            });
            
            showInCallUI();
        }

        function settingCallEvents(call) {
            call.on('addremotestream', function (stream) {
                console.log('Adding remote stream');
                addLog('ƒê√£ nh·∫≠n lu·ªìng √¢m thanh', 'success');
                var videoElement = document.createElement('video');
                videoElement.setAttribute('autoplay', '');
                videoElement.setAttribute('playsinline', '');
                
                document.getElementById('remote_videos').appendChild(videoElement);
                stream.play(videoElement);
            });

            call.on('signalingstate', function (state) {
                console.log('Signaling state:', state);
                document.getElementById('callStatus').innerText = state.reason;
                addLog('Tr·∫°ng th√°i: ' + state.reason, 'info');
                
                if (state.code === 6) {
                    addLog('Cu·ªôc g·ªçi ƒë√£ k·∫øt th√∫c', 'success');
                    resetUI();
                }
            });

            call.on('mediastate', function (state) {
                console.log('Media state:', state);
            });
            
            call.on('info', function (info) {
                console.log('Call info:', info);
            });
        }

        function answerCall() {
            if (currentCall) {
                currentCall.answer(function (res) {
                    console.log('answer res', res);
                    if (res.r === 0) {
                        showInCallUI();
                    }
                });
            }
        }

        function rejectCall() {
            if (currentCall) {
                // G·ªçi h√†m reject c·ªßa SDK
                currentCall.reject(function (res) {
                    console.log('reject res', res);
                    if (res.r === 0) {
                        addLog('ƒê√£ t·ª´ ch·ªëi cu·ªôc g·ªçi', 'info');
                    } else {
                        addLog('L·ªói t·ª´ ch·ªëi: ' + res.message, 'error');
                    }
                });
                // Reset giao di·ªán ngay l·∫≠p t·ª©c sau khi b·∫•m t·ª´ ch·ªëi
                resetUI();
            }
        }

        function hangupCall() {
            if (currentCall) {
                currentCall.hangup(function (res) {
                    console.log('hangup res', res);
                });
            }
            resetUI();
        }

        function showInCallUI() {
            document.getElementById('btnCall').classList.add('hidden');
            document.getElementById('btnAnswer').classList.add('hidden');
            document.getElementById('btnReject').classList.add('hidden');
            document.getElementById('btnHangup').classList.remove('hidden');
        }

        function resetUI() {
            document.getElementById('callStatus').innerText = 'S·∫µn s√†ng';
            document.getElementById('btnCall').classList.remove('hidden');
            document.getElementById('btnAnswer').classList.add('hidden');
            document.getElementById('btnHangup').classList.add('hidden');
            document.getElementById('btnReject').classList.add('hidden');
            document.getElementById('remote_videos').innerHTML = '';
            currentCall = null;
        }
    </script>
</body>
</html>
