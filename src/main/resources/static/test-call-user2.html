<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Test Call - User Test2</title>
    <script src="/js/latest.sdk.bundle.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #fff3e0; }
        .box { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: white; }
        .status { font-weight: bold; color: blue; }
        .status-connecting { color: orange; }
        .status-connected { color: green; }
        .status-disconnected { color: red; }
        button { padding: 10px 20px; cursor: pointer; margin-right: 10px; }
        .hidden { display: none; }
        .log-box { 
            background: #f5f5f5; 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry { margin: 3px 0; padding: 3px; }
        .log-info { color: blue; }
        .log-success { color: green; }
        .log-error { color: red; }
        .user-badge { 
            display: inline-block;
            background: #FF9800;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üü† User TEST2 - Web Call Demo</h1>
    <p><span class="user-badge">USER: test2</span></p>

    <div class="box">
        <h3>Tr·∫°ng th√°i k·∫øt n·ªëi: <span id="connectionStatus" class="status status-connecting">Ch∆∞a k·∫øt n·ªëi</span></h3>
        
        <button onclick="connectStringee()" id="btnConnect" style="background: #FF9800; color: white;">
            üîå K·∫øt n·ªëi t·ªõi Stringee
        </button>
        
        <div class="log-box" id="logConsole">
            <div class="log-entry log-info">Nh·∫≠t k√Ω ho·∫°t ƒë·ªông...</div>
        </div>
    </div>

    <div id="call-screen" class="box hidden">
        <h3>Th·ª±c hi·ªán cu·ªôc g·ªçi</h3>
        <p>G·ªçi t·ªõi User ID:</p>
        <input type="text" id="remoteUserId" placeholder="Nh·∫≠p: test" value="test" style="padding: 8px; width: 200px;">
        
        <div style="margin-top: 15px;">
            <button id="btnCall" onclick="makeCall()" style="background: #2196F3; color: white;">üìû G·ªçi</button>
            <button id="btnAnswer" onclick="answerCall()" class="hidden" style="background: green; color: white;">‚úÖ Tr·∫£ l·ªùi</button>
            <button id="btnHangup" onclick="hangupCall()" class="hidden" style="background: red; color: white;">‚ùå K·∫øt th√∫c</button>
        </div>

        <p id="callStatus" style="font-weight: bold; margin-top: 10px; color: #666;">S·∫µn s√†ng</p>
    </div>

    <div id="remote_videos" style="display: none;"></div>

    <script>
        // C·∫•u h√¨nh Stringee Server Addresses (Best Practice)
        const STRINGEE_SERVER_ADDRS = [
            "wss://v1.stringee.com:6899/", 
            "wss://v2.stringee.com:6899/"
        ];
        
        var stringeeClient;
        var currentCall;
        
        // Token cho user "test2"
        const ACCESS_TOKEN = "eyJjdHkiOiJzdHJpbmdlZS1hcGk7dj0xIiwidHlwIjoiSldUIiwiYWxnIjoiSFMyNTYifQ.eyJqdGkiOiJTSy4wLjRVUlMxQnptUm1BczZXRjNqdEpnbkl5ZlNTUzFObmFSLTE3NjkwNzI3MjciLCJpc3MiOiJTSy4wLjRVUlMxQnptUm1BczZXRjNqdEpnbkl5ZlNTUzFObmFSIiwiZXhwIjoxNzY5MDc2MzI3LCJ1c2VySWQiOiJ0ZXN0MiJ9.aEtaTu6bmGizhJyO8d2xN-YS6CTleL7DFEwEII5jCnQ";
        const MY_USER_ID = "test2";

        function addLog(message, type) {
            type = type || 'info';
            const logBox = document.getElementById('logConsole');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'success' ? 'log-success' : (type === 'error' ? 'log-error' : 'log-info');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry ' + logClass;
            logEntry.textContent = '[' + timestamp + '] ' + message;
            
            logBox.appendChild(logEntry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        function connectStringee() {
            console.log('B·∫Øt ƒë·∫ßu k·∫øt n·ªëi v·ªõi user:', MY_USER_ID);
            addLog('ƒêang k·∫øt n·ªëi v·ªõi user: ' + MY_USER_ID, 'info');

            stringeeClient = new StringeeClient(STRINGEE_SERVER_ADDRS);

            stringeeClient.on('connect', function () {
                console.log('ƒê√£ k·∫øt n·ªëi t·ªõi Stringee Server');
                document.getElementById('connectionStatus').innerText = 'üü¢ ƒê√£ k·∫øt n·ªëi';
                document.getElementById('connectionStatus').className = 'status status-connected';
                addLog('ƒê√£ k·∫øt n·ªëi t·ªõi Stringee Server', 'success');
            });

            stringeeClient.on('authen', function (res) {
                console.log('X√°c th·ª±c:', res);
                if (res.r === 0) {
                    console.log('ƒêƒÉng nh·∫≠p th√†nh c√¥ng');
                    addLog('X√°c th·ª±c th√†nh c√¥ng! User: ' + res.userId, 'success');
                    document.getElementById('call-screen').classList.remove('hidden');
                    document.getElementById('btnConnect').disabled = true;
                    document.getElementById('btnConnect').style.opacity = '0.5';
                } else {
                    console.error('X√°c th·ª±c th·∫•t b·∫°i:', res);
                    addLog('X√°c th·ª±c th·∫•t b·∫°i: ' + res.message, 'error');
                    alert('X√°c th·ª±c th·∫•t b·∫°i: ' + res.message);
                }
            });

            stringeeClient.on('disconnect', function () {
                console.log('ƒê√£ ng·∫Øt k·∫øt n·ªëi');
                document.getElementById('connectionStatus').innerText = 'üî¥ ƒê√£ ng·∫Øt k·∫øt n·ªëi';
                document.getElementById('connectionStatus').className = 'status status-disconnected';
                addLog('ƒê√£ ng·∫Øt k·∫øt n·ªëi', 'error');
            });

            stringeeClient.on('requestnewtoken', function () {
                console.log('Token h·∫øt h·∫°n');
                addLog('Token h·∫øt h·∫°n!', 'error');
                alert('Token ƒë√£ h·∫øt h·∫°n. Vui l√≤ng l√†m m·ªõi trang.');
            });

            stringeeClient.on('incomingcall', function (incomingCall) {
                console.log('Cu·ªôc g·ªçi ƒë·∫øn:', incomingCall);
                addLog('üìû Cu·ªôc g·ªçi ƒë·∫øn t·ª´: ' + incomingCall.fromNumber, 'info');
                currentCall = incomingCall;
                
                document.getElementById('callStatus').innerText = 'üìû Cu·ªôc g·ªçi ƒë·∫øn t·ª´: ' + incomingCall.fromNumber;
                document.getElementById('btnAnswer').classList.remove('hidden');
                document.getElementById('btnCall').classList.add('hidden');

                settingCallEvents(currentCall);
            });

            console.log('ƒêang k·∫øt n·ªëi t·ªõi Stringee...');
            stringeeClient.connect(ACCESS_TOKEN);
        }

        function makeCall() {
            const calleeId = document.getElementById('remoteUserId').value;
            if (!calleeId) return alert('Nh·∫≠p ID ng∆∞·ªùi nh·∫≠n');

            console.log('ƒêang g·ªçi t·ªõi:', calleeId);
            addLog('ƒêang g·ªçi t·ªõi: ' + calleeId, 'info');

            currentCall = new StringeeCall(stringeeClient, MY_USER_ID, calleeId, false);
            settingCallEvents(currentCall);

            currentCall.makeCall(function (res) {
                console.log('makeCall response:', res);
                if (res.r !== 0) {
                    console.error('G·ªçi th·∫•t b·∫°i:', res.message);
                    addLog('G·ªçi th·∫•t b·∫°i: ' + res.message, 'error');
                    alert(res.message);
                } else {
                    addLog('ƒêang g·ªçi...', 'success');
                }
            });
            
            showInCallUI();
        }

        function settingCallEvents(call) {
            call.on('addremotestream', function (stream) {
                console.log('Adding remote stream');
                addLog('ƒê√£ nh·∫≠n lu·ªìng √¢m thanh', 'success');
                var videoElement = document.createElement('video');
                videoElement.setAttribute('autoplay', '');
                videoElement.setAttribute('playsinline', '');
                
                document.getElementById('remote_videos').appendChild(videoElement);
                stream.play(videoElement);
            });

            call.on('signalingstate', function (state) {
                console.log('Signaling state:', state);
                document.getElementById('callStatus').innerText = state.reason;
                addLog('Tr·∫°ng th√°i: ' + state.reason, 'info');
                
                if (state.code === 6) {
                    addLog('Cu·ªôc g·ªçi ƒë√£ k·∫øt th√∫c', 'success');
                    resetUI();
                }
            });

            call.on('mediastate', function (state) {
                console.log('Media state:', state);
            });
            
            call.on('info', function (info) {
                console.log('Call info:', info);
            });
        }

        function answerCall() {
            if (currentCall) {
                currentCall.answer(function (res) {
                    console.log('answer res', res);
                    if (res.r === 0) {
                        addLog('ƒê√£ tr·∫£ l·ªùi cu·ªôc g·ªçi', 'success');
                        showInCallUI();
                    }
                });
            }
        }

        function hangupCall() {
            if (currentCall) {
                currentCall.hangup(function (res) {
                    console.log('hangup res', res);
                });
            }
            resetUI();
        }

        function showInCallUI() {
            document.getElementById('btnCall').classList.add('hidden');
            document.getElementById('btnAnswer').classList.add('hidden');
            document.getElementById('btnHangup').classList.remove('hidden');
        }

        function resetUI() {
            document.getElementById('callStatus').innerText = 'S·∫µn s√†ng';
            document.getElementById('btnCall').classList.remove('hidden');
            document.getElementById('btnAnswer').classList.add('hidden');
            document.getElementById('btnHangup').classList.add('hidden');
            document.getElementById('remote_videos').innerHTML = '';
            currentCall = null;
        }
    </script>
</body>
</html>
